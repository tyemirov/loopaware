services:
  pinguin:
    image: ghcr.io/tyemirov/pinguin:latest
    container_name: pinguin
    restart: unless-stopped
    pull_policy: always
    env_file:
      - .env.pinguin
    environment:
      - DATABASE_PATH=/var/lib/pinguin/pinguin.db
      - LOG_LEVEL=INFO
    volumes:
      - pinguin-data:/var/lib/pinguin
    ports:
      - "50051:50051"

  loopaware:
    build: .
    container_name: loopaware
    env_file:
      - .env
    depends_on:
      pinguin:
        condition: service_started
    environment:
      - PINGUIN_ADDR=pinguin:50051
    volumes:
      - loopaware-data:/app/data
      - ./config.yaml:/app/config.yaml:ro
    ports:
      - "8080:8080"
    restart: unless-stopped
    develop:
      watch:
        - action: sync+restart
          path: ./config.yaml
          target: /app/config.yaml
        - action: rebuild
          path: ./cmd/main.go
        - action: rebuild
          path: ./internal/httpapi/assets/widget.js
        - action: rebuild
          path: ./internal/httpapi/templates/dashboard.tmpl
        - action: rebuild
          path: ./internal/httpapi/templates/landing.tmpl
        - action: rebuild
          path: ./go.sum

volumes:
  loopaware-data:
  pinguin-data:
