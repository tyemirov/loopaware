<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>{{.PageTitle}}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script>
    window.addEventListener('DOMContentLoaded', function() {
      (function() {
      var THEME_KEYS = [
        'loopaware_dashboard_theme',
        'loopaware_public_theme',
        'loopaware_landing_theme',
        'loopaware_theme'
      ];
      var theme = 'light';
      for (var index = 0; index < THEME_KEYS.length; index++) {
        try {
          var value = localStorage.getItem(THEME_KEYS[index]);
          if (value === 'dark') {
            theme = 'dark';
            break;
          }
          if (value === 'light') {
            theme = 'light';
          }
        } catch (error) {
          theme = 'light';
        }
      }
      document.documentElement.setAttribute('data-bs-theme', theme);
      }());
    });
  </script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" {{.BootstrapIconsIntegrity}} crossorigin="anonymous" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/MarcoPoloResearchLab/mpr-ui@latest/mpr-ui.css" />
  <link rel="icon" type="image/svg+xml" href="{{.FaviconDataURI}}" />
  {{if .TauthScriptURL}}<script defer src="{{.TauthScriptURL}}"></script>{{end}}
  <script defer src="https://cdn.jsdelivr.net/gh/MarcoPoloResearchLab/mpr-ui@latest/mpr-ui.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>{{.SharedStyles}}</style>
</head>
<body class="d-flex flex-column min-vh-100"
      data-site-id="{{.SiteID}}"
      data-visits-endpoint="{{.VisitsEndpoint}}"
      data-stats-endpoint="{{.StatsEndpoint}}">
  {{template "dashboard_header" .Header}}
  <div class="modal fade" id="{{.Header.SettingsModalID}}" tabindex="-1" aria-labelledby="{{.Header.SettingsModalTitleID}}" aria-describedby="{{.Header.SettingsModalContentID}}" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="{{.Header.SettingsModalTitleID}}">{{.Header.SettingsModalTitle}}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{.Header.SettingsModalCloseLabel}}"></button>
        </div>
        <div class="modal-body">
          <p class="text-muted mb-4">{{.Header.SettingsModalIntro}}</p>
          <div id="{{.Header.SettingsModalContentID}}" class="d-flex flex-column gap-3"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{.Header.SettingsModalCloseLabel}}</button>
        </div>
      </div>
    </div>
  </div>
  <main class="flex-fill pt-5 mt-4">
    <div class="container">
      <div class="row justify-content-center">
        <div class="col-lg-10">
          <div class="card shadow-sm border-0 mb-4">
            <div class="card-body">
              <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-3">
                <div>
                  <h1 class="h4 mb-1">Test traffic widget — {{.SiteName}}</h1>
                  <p class="text-muted small mb-0">Site ID: <code>{{.SiteID}}</code></p>
                </div>
                <span class="badge text-bg-secondary">Preview only</span>
              </div>
              <hr class="my-4" />
              <p class="text-muted mb-1">Send sample visits to verify pixel.js before embedding. Each preview uses the live <code>/api/visits</code> endpoint for the selected site.</p>
              <p class="text-muted small mb-0">Use page URLs that match the site's Allowed Origin to pass origin checks.</p>
            </div>
          </div>
          <div class="card shadow-sm border-0 mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="mb-0">Sample visit</h5>
              <button type="button" class="btn btn-outline-secondary btn-sm" id="{{.RefreshButtonID}}">Refresh stats</button>
            </div>
            <div class="card-body">
              <label class="form-label" for="{{.URLInputID}}">Page URL</label>
              <input type="url" class="form-control" id="{{.URLInputID}}" value="{{.DefaultURL}}" placeholder="https://example.com/page" autocomplete="off">
              <div class="d-flex flex-wrap gap-2 mt-3">
                <button type="button" class="btn btn-primary" id="{{.SendButtonID}}">Record sample visit</button>
                <span id="{{.StatusElementID}}" class="small text-muted"></span>
              </div>
            </div>
            <div class="list-group list-group-flush" id="{{.StatusLogElementID}}"></div>
          </div>
          <div class="card shadow-sm border-0">
            <div class="card-header">
              <h5 class="mb-0">Live stats</h5>
            </div>
            <div class="card-body">
              <div class="row justify-content-center text-center mb-4">
                <div class="col-6 col-md-4">
                  <div class="display-5 fw-semibold" id="{{.TotalCounterID}}">0</div>
                  <p class="text-muted mb-0">Visits</p>
                </div>
                <div class="col-6 col-md-4">
                  <div class="display-5 fw-semibold" id="{{.UniqueCounterID}}">0</div>
                  <p class="text-muted mb-0">Unique visitors</p>
                </div>
              </div>
              <div class="table-responsive">
                <table class="table table-striped align-middle mb-0">
                  <thead class="table-light">
                    <tr>
                      <th scope="col">Page URL</th>
                      <th scope="col" class="text-end">Visits</th>
                    </tr>
                  </thead>
                  <tbody id="{{.TopPagesTableID}}">
                    <tr><td colspan="2" class="text-center text-muted">No visits yet.</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
  {{.FooterHTML}}
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
  <script>
    (function() {
      var themeStorageKey = '{{js .ThemeStorageKey}}';
      var publicThemeStorageKey = '{{js .PublicThemeStorageKey}}';
      var landingThemeStorageKey = '{{js .LandingThemeStorageKey}}';
      var legacyThemeStorageKey = '{{js .LegacyThemeStorageKey}}';
      var footerElement = document.getElementById('{{js .FooterElementID}}');
      var footerLightClass = '{{js .FooterThemeLightClass}}';
      var footerDarkClass = '{{js .FooterThemeDarkClass}}';
      var footerBaseClass = '{{js .FooterBaseClass}}';
      var landingPath = '{{js .LandingPath}}';
      var dashboardPath = '{{js .DashboardPath}}';
      var authFetch = typeof window.apiFetch === 'function' ? window.apiFetch : window.fetch.bind(window);

      function normalizeClassList(value) {
        if (typeof value !== 'string') {
          return [];
        }
        return value.split(/\s+/).filter(function(item) {
          return item.length > 0;
        });
      }

      function applyElementThemeClasses(element, classesToAdd, classesToRemove) {
        if (!element) {
          return;
        }
        normalizeClassList(classesToRemove).forEach(function(className) {
          element.classList.remove(className);
        });
        normalizeClassList(classesToAdd).forEach(function(className) {
          element.classList.add(className);
        });
      }

      function isRecognizedTheme(value) {
        return value === 'dark' || value === 'light';
      }

      function readThemePreference(storageKey) {
        if (!storageKey) {
          return '';
        }
        try {
          var storedValue = localStorage.getItem(storageKey);
          if (storedValue === null) {
            return '';
          }
          return storedValue;
        } catch (error) {
          return '';
        }
      }

      function writeThemePreference(storageKey, mode) {
        if (!storageKey) {
          return;
        }
        try {
          localStorage.setItem(storageKey, mode);
        } catch (writeError) {}
      }

      function resolveThemePreference() {
        var storedTheme = readThemePreference(themeStorageKey);
        if (isRecognizedTheme(storedTheme)) {
          return storedTheme;
        }
        var publicTheme = readThemePreference(publicThemeStorageKey);
        if (isRecognizedTheme(publicTheme)) {
          writeThemePreference(themeStorageKey, publicTheme);
          return publicTheme;
        }
        var landingTheme = readThemePreference(landingThemeStorageKey);
        if (isRecognizedTheme(landingTheme)) {
          writeThemePreference(themeStorageKey, landingTheme);
          return landingTheme;
        }
        var legacyTheme = readThemePreference(legacyThemeStorageKey);
        if (isRecognizedTheme(legacyTheme)) {
          writeThemePreference(themeStorageKey, legacyTheme);
          return legacyTheme;
        }
        writeThemePreference(themeStorageKey, 'light');
        return 'light';
      }

      function parseThemeConfig(rawValue) {
        if (!rawValue) {
          return {};
        }
        try {
          var parsed = JSON.parse(rawValue);
          if (parsed && typeof parsed === 'object') {
            return parsed;
          }
        } catch (error) {
          console.error(error);
        }
        return {};
      }

      function updateFooterThemeConfig(mode) {
        if (!footerElement) {
          return;
        }
        var normalized = mode === 'dark' ? 'dark' : 'light';
        var config = parseThemeConfig(footerElement.getAttribute('theme-config'));
        if (!config.attribute) {
          config.attribute = 'data-bs-theme';
        }
        config.initialMode = normalized;
        footerElement.setAttribute('theme-config', JSON.stringify(config));
      }

      function applyThemePreference(mode) {
        var normalized = mode === 'dark' ? 'dark' : 'light';
        document.documentElement.setAttribute('data-bs-theme', normalized);
        var footerThemeClass = normalized === 'dark' ? footerDarkClass : footerLightClass;
        applyElementThemeClasses(footerElement, footerThemeClass + ' ' + footerBaseClass, normalized === 'dark' ? footerLightClass : footerDarkClass);
      }

      function handleThemeSelection(mode) {
        writeThemePreference(themeStorageKey, mode);
        writeThemePreference(publicThemeStorageKey, mode);
        applyThemePreference(mode);
      }

      var resolvedTheme = resolveThemePreference();
      updateFooterThemeConfig(resolvedTheme);
      applyThemePreference(resolvedTheme);

      if (footerElement) {
        footerElement.addEventListener('mpr-footer:theme-change', function(event) {
          var nextTheme = event && event.detail && event.detail.theme === 'dark' ? 'dark' : 'light';
          handleThemeSelection(nextTheme);
        });
      }

      var body = document.body;
      if (!body) {
        return;
      }
      var siteId = body.getAttribute('data-site-id') || '';
      var visitsEndpoint = body.getAttribute('data-visits-endpoint') || '';
      var statsEndpoint = body.getAttribute('data-stats-endpoint') || '';
      var urlInput = document.getElementById('{{js .URLInputID}}');
      var statusLabel = document.getElementById('{{js .StatusElementID}}');
      var statusLog = document.getElementById('{{js .StatusLogElementID}}');
      var sendButton = document.getElementById('{{js .SendButtonID}}');
      var refreshButton = document.getElementById('{{js .RefreshButtonID}}');
      var totalCounter = document.getElementById('{{js .TotalCounterID}}');
      var uniqueCounter = document.getElementById('{{js .UniqueCounterID}}');
      var topPagesTable = document.getElementById('{{js .TopPagesTableID}}');
      var previewVisitorStorageKey = 'loopaware_traffic_preview_visitor_id';
      var cachedVisitorId = '';

      function updateStatus(message, variant) {
        if (!statusLabel) {
          return;
        }
        statusLabel.textContent = message || '';
        statusLabel.classList.remove('text-success', 'text-danger');
        if (variant === 'success') {
          statusLabel.classList.add('text-success');
        } else if (variant === 'danger') {
          statusLabel.classList.add('text-danger');
        } else {
          statusLabel.classList.add('text-muted');
        }
      }

      function formatVisitTimestamp(seconds) {
        if (typeof seconds !== 'number' || !isFinite(seconds)) {
          return '';
        }
        try {
          return new Date(seconds * 1000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        } catch (error) {
          return '';
        }
      }

      function renderRecentVisits(visits) {
        if (!statusLog) {
          return;
        }
        statusLog.innerHTML = '';
        var entries = Array.isArray(visits) ? visits : [];
        if (entries.length === 0) {
          var placeholder = document.createElement('div');
          placeholder.className = 'list-group-item text-muted small';
          placeholder.textContent = 'No recorded visits yet.';
          statusLog.appendChild(placeholder);
          return;
        }
        entries.forEach(function(entry) {
          var wrapper = document.createElement('div');
          wrapper.className = 'list-group-item d-flex flex-column gap-1';
          var header = document.createElement('div');
          header.className = 'd-flex justify-content-between align-items-start gap-2';
          var urlLabel = document.createElement('span');
          urlLabel.className = 'fw-semibold text-break';
          urlLabel.textContent = entry.url || '(no url)';
          var timeLabel = document.createElement('span');
          timeLabel.className = 'text-muted small';
          timeLabel.textContent = formatVisitTimestamp(entry.occurred_at);
          header.appendChild(urlLabel);
          header.appendChild(timeLabel);
          wrapper.appendChild(header);
          var metaRow = document.createElement('div');
          metaRow.className = 'text-muted small';
          var ipText = entry.ip || 'Unknown';
          var countryText = entry.country || 'Unknown';
          var browserText = entry.browser || entry.user_agent || 'Unknown';
          metaRow.textContent = 'IP: ' + ipText + ' • Country: ' + countryText + ' • Browser: ' + browserText;
          wrapper.appendChild(metaRow);
          if (entry.referrer) {
            var refRow = document.createElement('div');
            refRow.className = 'text-muted small';
            refRow.textContent = 'Referrer: ' + entry.referrer;
            wrapper.appendChild(refRow);
          }
          statusLog.appendChild(wrapper);
        });
      }

      function randomVisitorId() {
        try {
          if (window.crypto && typeof window.crypto.randomUUID === 'function') {
            return window.crypto.randomUUID();
          }
        } catch (error) {}
        var template = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx';
        return template.replace(/[xy]/g, function(char) {
          var random = Math.random() * 16 | 0;
          var value = char === 'x' ? random : (random & 0x3 | 0x8);
          return value.toString(16);
        });
      }

      function resolveVisitorId() {
        if (cachedVisitorId) {
          return cachedVisitorId;
        }
        try {
          var stored = window.localStorage.getItem(previewVisitorStorageKey);
          if (stored) {
            cachedVisitorId = stored;
            return stored;
          }
        } catch (error) {}
        cachedVisitorId = randomVisitorId();
        try {
          window.localStorage.setItem(previewVisitorStorageKey, cachedVisitorId);
        } catch (storageError) {}
        return cachedVisitorId;
      }

      function buildVisitURL(sampleURL) {
        var params = new URLSearchParams();
        params.set('site_id', siteId);
        if (sampleURL) {
          params.set('url', sampleURL);
        }
        if (document.location) {
          params.set('referrer', document.location.href);
        }
        var visitorIdentifier = resolveVisitorId();
        if (visitorIdentifier) {
          params.set('visitor_id', visitorIdentifier);
        }
        return visitsEndpoint + '?' + params.toString();
      }

      var inflightBeacons = [];

      function removeBeacon(image) {
        var index = inflightBeacons.indexOf(image);
        if (index >= 0) {
          inflightBeacons.splice(index, 1);
        }
      }

      function sendSampleVisit() {
        if (!siteId || !visitsEndpoint) {
          return;
        }
        var sampleURL = (urlInput && urlInput.value || '').trim();
        if (!sampleURL) {
          updateStatus('Enter a URL to record.', 'danger');
          return;
        }
        updateStatus('Recording sample visit…', null);
        var beacon = new Image(1, 1);
        inflightBeacons.push(beacon);
        beacon.onload = function() {
          updateStatus('Sample visit sent for ' + sampleURL, 'success');
          loadStats();
          removeBeacon(beacon);
        };
        beacon.onerror = function() {
          updateStatus('Failed to record visit. Check the Allowed Origin and see console.', 'danger');
          removeBeacon(beacon);
        };
        beacon.src = buildVisitURL(sampleURL);
      }

      function renderTopPages(rows) {
        if (!topPagesTable) {
          return;
        }
        var entries = Array.isArray(rows) ? rows : [];
        if (entries.length === 0) {
          topPagesTable.innerHTML = '<tr><td colspan="2" class="text-center text-muted">No visits yet.</td></tr>';
          return;
        }
        var html = entries.map(function(entry) {
          var url = entry.url || '';
          var count = typeof entry.visits === 'number' ? entry.visits : 0;
          return '<tr><td class="text-break">' + url + '</td><td class="text-end fw-semibold">' + count + '</td></tr>';
        }).join('');
        topPagesTable.innerHTML = html;
      }

      function loadStats() {
        if (!statsEndpoint) {
          return;
        }
        authFetch(statsEndpoint, { credentials: 'same-origin' }).then(function(response) {
          if (response.status === 401) {
            window.location.assign(landingPath || dashboardPath || '/');
            throw new Error('unauthorized');
          }
          if (!response.ok) {
            throw new Error('HTTP ' + response.status);
          }
          return response.json();
        }).then(function(payload) {
          var total = typeof payload.visit_count === 'number' ? payload.visit_count : 0;
          var unique = typeof payload.unique_visitor_count === 'number' ? payload.unique_visitor_count : 0;
          if (totalCounter) {
            totalCounter.textContent = total.toString();
          }
          if (uniqueCounter) {
            uniqueCounter.textContent = unique.toString();
          }
          renderTopPages(payload.top_pages || []);
          renderRecentVisits(payload.recent_visits || []);
        }).catch(function(error) {
          if (error && error.message === 'unauthorized') {
            return;
          }
          updateStatus('Failed to refresh stats.', 'danger');
        });
      }

      if (sendButton) {
        sendButton.addEventListener('click', function(event) {
          event.preventDefault();
          sendSampleVisit();
        });
      }

      if (refreshButton) {
        refreshButton.addEventListener('click', function(event) {
          event.preventDefault();
          loadStats();
        });
      }

      loadStats();
      setInterval(loadStats, 8000);
    }());
  </script>
</body>
</html>
