<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{.PageTitle}}</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" {{.BootstrapIconsIntegrityAttr}} crossorigin="anonymous" />
    <link rel="icon" type="image/svg+xml" href="{{.FaviconDataURI}}" />
  </head>
  <body class="d-flex flex-column min-vh-100 bg-light">
    <header class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top shadow-sm">
      <div class="container-fluid">
        <span class="navbar-brand d-flex align-items-center gap-3">
          <img id="{{.HeaderLogoImageID}}" src="{{.HeaderLogoDataURI}}" alt="LoopAware logo" width="44" height="44" />
          <span class="fw-semibold">{{.PageTitle}}</span>
        </span>
        <div class="dropdown ms-auto">
          <button id="{{.SettingsButtonID}}" class="btn btn-outline-light border-0 rounded-circle p-1 d-flex align-items-center justify-content-center" type="button" data-bs-toggle="dropdown" aria-expanded="false">
            <span class="visually-hidden">{{.SettingsButtonLabel}}</span>
            <img id="{{.SettingsAvatarImageID}}" src="" alt="Avatar" class="rounded-circle d-none" width="36" height="36" />
            <i id="{{.SettingsAvatarFallbackID}}" class="bi bi-person-circle fs-3"></i>
          </button>
          <div id="{{.SettingsMenuID}}" class="dropdown-menu dropdown-menu-end">
            <div class="dropdown-item d-flex align-items-center justify-content-between">
              <span>{{.ThemeToggleLabel}}</span>
              <div class="form-check form-switch m-0">
                <input class="form-check-input" type="checkbox" role="switch" id="{{.SettingsThemeToggleID}}" />
              </div>
            </div>
            <button id="{{.LogoutButtonID}}" class="dropdown-item" type="button">{{.LogoutLabel}}</button>
          </div>
        </div>
      </div>
    </header>
    <main class="flex-grow-1 pt-5 mt-4">
      <div class="container py-4">
        
        <div class="row g-4">
          <div class="col-lg-4">
            <div class="card shadow-sm">
              <div class="card-header">Account</div>
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <img id="{{.UserAvatarID}}" src="" alt="Avatar" class="rounded-circle me-3 d-none" width="64" height="64" />
                  <div>
                    <div id="{{.UserNameID}}" class="fw-semibold"></div>
                    <div id="{{.UserEmailID}}" class="text-muted small"></div>
                    <span id="{{.UserRoleBadgeID}}" class="badge bg-secondary mt-2"></span>
                  </div>
                </div>
              </div>
            </div>
            <div class="card shadow-sm mt-4">
              <div class="card-header">
                <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                  <div class="d-flex align-items-center gap-2">
                    <span>Sites</span>
                    <button id="{{.SiteSearchToggleButtonID}}" type="button" class="{{.SearchToggleButtonClass}}" aria-label="{{.SiteSearchToggleLabel}}" aria-expanded="false">
                      <i class="bi bi-search"></i>
                    </button>
                  </div>
                  <div class="d-flex align-items-center gap-2">
                    <button id="{{.DeleteSiteButtonID}}" type="button" class="{{.DeleteSiteButtonDisabledClass}}" aria-label="{{.DeleteSiteButtonLabel}}" disabled>
                      <i class="{{.DeleteSiteIconClass}}" aria-hidden="true"></i>
                    </button>
                    <button id="{{.NewSiteButtonID}}" type="button" class="{{.NewSiteButtonClass}}">{{.NewSiteButtonLabel}}</button>
                  </div>
                  <div id="{{.SiteSearchContainerID}}" class="w-100 d-none">
                    <input id="{{.SiteSearchInputID}}" type="search" class="{{.SearchInputClass}}" placeholder="{{.SiteSearchPlaceholder}}" autocomplete="off" />
                  </div>
                </div>
              </div>
              <div class="card-body p-0">
                <div id="{{.SitesListID}}" class="list-group list-group-flush overflow-auto" style="max-height: 20rem;"></div>
                <p class="text-muted small m-3" id="{{.EmptySitesMessageID}}">{{.EmptySitesMessage}}</p>
              </div>
            </div>
          </div>
          <div class="col-lg-8">
            <div class="card shadow-sm mb-4">
              <div class="card-header">
                <div class="d-flex align-items-center justify-content-between">
                  <h5 class="mb-0">Site details</h5>
                  <div class="d-flex align-items-center gap-2">
                    <div id="{{.FormStatusID}}" class="{{.FormStatusBaseClass}}"></div>
                    <button id="{{.SaveSiteButtonID}}" type="button" class="{{.SaveButtonDefaultClass}}"></button>
                  </div>
                </div>
              </div>
              <div class="card-body">
                <form id="{{.SiteFormID}}">
                  <div class="row g-3 align-items-end">
                    <div class="col-md-6">
                    <div class="d-flex align-items-center justify-content-between">
                      <label class="form-label mb-0" for="{{.EditSiteNameInputID}}">Name</label>
                      <button id="{{.SiteNameHelpButtonID}}" type="button" class="{{.FieldHelpButtonClass}}" tabindex="{{.FieldHelpButtonTabIndex}}" data-bs-toggle="popover" data-bs-trigger="focus" data-bs-placement="bottom" title="{{.SiteNameHelpTitle}}" data-bs-content="{{.SiteNameHelpContent}}">
                        <span class="visually-hidden">{{.SiteNameHelpTitle}}</span>
                        <i class="{{.FieldHelpIconClass}}"></i>
                      </button>
                    </div>
                    <input id="{{.EditSiteNameInputID}}" type="text" class="form-control" autocomplete="off" />
                  </div>
                  <div class="col-md-6">
                    <div class="d-flex align-items-center justify-content-between">
                      <label class="form-label mb-0" for="{{.EditSiteOriginInputID}}">Allowed origin</label>
                      <button id="{{.AllowedOriginHelpButtonID}}" type="button" class="{{.FieldHelpButtonClass}}" tabindex="{{.FieldHelpButtonTabIndex}}" data-bs-toggle="popover" data-bs-trigger="focus" data-bs-placement="bottom" title="{{.AllowedOriginHelpTitle}}" data-bs-content="{{.AllowedOriginHelpContent}}">
                        <span class="visually-hidden">{{.AllowedOriginHelpTitle}}</span>
                        <i class="{{.FieldHelpIconClass}}"></i>
                      </button>
                    </div>
                    <input id="{{.EditSiteOriginInputID}}" type="text" class="form-control" autocomplete="off" />
                  </div>
                  <div class="col-md-6 d-none" id="{{.EditSiteOwnerContainerID}}">
                    <div class="d-flex align-items-center justify-content-between">
                      <label class="form-label mb-0" for="{{.EditSiteOwnerInputID}}">Owner email</label>
                      <button id="{{.OwnerEmailHelpButtonID}}" type="button" class="{{.FieldHelpButtonClass}}" tabindex="{{.FieldHelpButtonTabIndex}}" data-bs-toggle="popover" data-bs-trigger="focus" data-bs-placement="bottom" title="{{.OwnerEmailHelpTitle}}" data-bs-content="{{.OwnerEmailHelpContent}}">
                        <span class="visually-hidden">{{.OwnerEmailHelpTitle}}</span>
                        <i class="{{.FieldHelpIconClass}}"></i>
                      </button>
                    </div>
                    <input id="{{.EditSiteOwnerInputID}}" type="email" class="form-control" autocomplete="off" />
                  </div>
                  <div class="col-md-6 d-none" id="{{.SiteCreatedAtContainerID}}">
                    <div class="d-flex flex-column align-items-md-end gap-1 text-muted small">
                      <span class="fw-semibold">Registered at:</span>
                      <span id="{{.SiteCreatedAtElementID}}">{{.SiteCreatedAtPlaceholder}}</span>
                    </div>
                  </div>
                  </div>
                </form>
              </div>
            </div>
            <div class="card shadow-sm mb-4">
              <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                  <h5 class="mb-0">{{.WidgetCardTitle}}</h5>
                  <div class="d-flex align-items-center gap-2">
                    <div id="{{.WidgetStatusID}}" class="d-none py-1 px-2 small"></div>
                    <button id="{{.CopyWidgetSnippetButtonID}}" type="button" class="{{.CopyButtonDefaultClass}}">{{.CopyButtonDefaultLabel}}</button>
                  </div>
                </div>
              </div>
              <div class="card-body">
                <p class="text-muted small mb-3">{{.WidgetInstructions}}</p>
                <textarea id="{{.WidgetSnippetTextareaID}}" class="form-control font-monospace" rows="3" readonly></textarea>
              </div>
            </div>
            <div class="card shadow-sm">
              <div class="card-header">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                  <div class="d-flex align-items-center gap-2">
                    <h5 class="mb-0">Feedback messages</h5>
                    <button id="{{.MessagesSearchToggleButtonID}}" type="button" class="{{.SearchToggleButtonClass}}" aria-label="{{.MessagesSearchToggleLabel}}" aria-expanded="false">
                      <i class="bi bi-search"></i>
                    </button>
                  </div>
                  <div class="d-flex align-items-center gap-2">
                    <div id="{{.MessagesStatusID}}" class="d-none py-1 px-2 small"></div>
                    <button id="{{.RefreshMessagesButtonID}}" class="{{.RefreshButtonDefaultClass}}">{{.RefreshButtonDefaultLabel}}</button>
                    <span id="{{.FeedbackCountElementID}}" class="badge bg-secondary d-none"></span>
                  </div>
                  <div id="{{.MessagesSearchContainerID}}" class="w-100 d-none">
                    <input id="{{.MessagesSearchInputID}}" type="search" class="{{.SearchInputClass}}" placeholder="{{.MessagesSearchPlaceholder}}" autocomplete="off" />
                  </div>
                </div>
              </div>
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table table-striped table-hover align-middle">
                    <thead id="{{.FeedbackTableHeaderID}}" class="{{.FeedbackTableHeaderLightClass}}">
                      <tr>
                        <th scope="col">When</th>
                        <th scope="col">Contact</th>
                        <th scope="col">Message</th>
                      </tr>
                    </thead>
                    <tbody id="{{.FeedbackTableBodyID}}">
                      <tr><td colspan="3" class="text-center text-muted">{{.FeedbackPlaceholder}}</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
    <div class="modal fade" id="{{.DeleteSiteModalID}}" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">{{.DeleteSiteModalTitle}}</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{.DeleteSiteModalCancelButtonLabel}}"></button>
          </div>
          <div class="modal-body">
            <p class="mb-3">{{.DeleteSiteModalDescription}}</p>
            <div class="mb-3">
              <label class="form-label" for="{{.DeleteSiteModalInputID}}">{{.DeleteSiteModalInputLabel}}</label>
              <input id="{{.DeleteSiteModalInputID}}" type="text" class="form-control" placeholder="{{.DeleteSiteModalInputPlaceholder}}" autocomplete="off" />
              <div class="form-text">{{.DeleteSiteModalHintPrefix}}<strong id="{{.DeleteSiteTargetNameID}}"></strong>{{.DeleteSiteModalHintSuffix}}</div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="{{.DeleteSiteModalCancelButtonClass}}" data-bs-dismiss="modal">{{.DeleteSiteModalCancelButtonLabel}}</button>
            <button id="{{.DeleteSiteModalConfirmButtonID}}" type="button" class="{{.DeleteSiteModalConfirmButtonClass}}" disabled>{{.DeleteSiteModalConfirmButtonLabel}}</button>
          </div>
        </div>
      </div>
    </div>
    <div id="inactivity-warning-bar" class="d-none alert alert-warning border-0 rounded-0 mb-0 text-center py-2">
      <div class="container-fluid d-flex align-items-center justify-content-center gap-2 flex-wrap">
        <span id="inactivity-warning-message" class="fw-semibold"></span>
        <button id="inactivity-warning-yes" type="button" class="btn btn-sm btn-danger">Yes</button>
        <button id="inactivity-warning-no" type="button" class="btn btn-sm btn-secondary">No</button>
      </div>
    </div>
    {{.FooterHTML}}
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script type="application/json" id="{{.ClientConfigElementID}}">{{.ClientConfigJSON}}</script>
    <script>
      (function() {
        var configElement = document.getElementById('{{.ClientConfigElementID}}');
        var parsedConfig = {};
        if (configElement) {
          try {
            parsedConfig = JSON.parse(configElement.textContent || '{}') || {};
          } catch (error) {
            parsedConfig = {};
          }
        }
        var apiPaths = parsedConfig.api_paths || {};
        var siteFaviconEventsEndpoint = apiPaths.site_favicon_events || '';
        var sharedPaths = parsedConfig.paths || {};
        var elementIds = parsedConfig.element_ids || {};
        var buttonClasses = parsedConfig.button_classes || {};
        var buttonLabels = parsedConfig.button_labels || {};
        var statusMessages = parsedConfig.status_messages || {};
        var errorMessages = parsedConfig.error_messages || {};
        var roleLabels = parsedConfig.role_labels || {};
        var roleValues = parsedConfig.role_values || {};
        var adminRoleValue = roleValues.admin || 'admin';
        var userRoleValue = roleValues.user || 'user';
        var buttonStyles = parsedConfig.button_styles || {};
        var componentClasses = parsedConfig.component_classes || {};
        var widgetTexts = parsedConfig.widget_texts || {};
        var optionValues = parsedConfig.option_values || {};
        var formStatusClasses = parsedConfig.form_status_classes || {};
        var validationMessages = parsedConfig.validation_messages || {};
        var themePreferenceStorageKey = parsedConfig.theme_storage_key || '';
        var themePreferenceLegacyStorageKey = 'loopaware_theme';
        var faviconUpdatedEventName = 'favicon_updated';
        var faviconEventSource = null;
        var faviconReconnectDelayMilliseconds = 5000;
        var settingsButton = document.getElementById(elementIds.settings_button);
        var settingsMenu = document.getElementById(elementIds.settings_menu);
        var themeToggle = document.getElementById(elementIds.settings_theme_toggle);
        var settingsAvatarImage = document.getElementById(elementIds.settings_avatar_image);
        var settingsAvatarFallback = document.getElementById(elementIds.settings_avatar_fallback);
        var siteNameHelpButton = document.getElementById(elementIds.site_name_help_button);
        var allowedOriginHelpButton = document.getElementById(elementIds.allowed_origin_help_button);
        var ownerEmailHelpButton = document.getElementById(elementIds.owner_email_help_button);
        var newSiteOptionValue = optionValues.new_site || '';
        var createButtonLabel = buttonLabels.create || '';
        var updateButtonLabel = buttonLabels.update || '';
        var createButtonClass = buttonClasses.create || '';
        var updateButtonClass = buttonClasses.update || '';
        var newSiteButton = document.getElementById(elementIds.new_site_button);
        var newSiteButtonDefaultClass = buttonClasses.new_site_default || '';
        var newSiteButtonActiveClass = buttonClasses.new_site_active || '';
        var sitesList = document.getElementById(elementIds.sites_list);
        var siteListItemClass = componentClasses.site_list_item || '';
        var siteListItemActiveClass = componentClasses.site_list_item_active || '';
        var siteListItemHeaderClass = componentClasses.site_list_item_header || '';
        var siteListItemFaviconClass = componentClasses.site_list_item_favicon || '';
        var siteSearchToggleButton = document.getElementById(elementIds.site_search_toggle_button);
        var siteSearchContainer = document.getElementById(elementIds.site_search_container);
        var siteSearchInput = document.getElementById(elementIds.site_search_input);
        var messagesSearchToggleButton = document.getElementById(elementIds.messages_search_toggle_button);
        var messagesSearchContainer = document.getElementById(elementIds.messages_search_container);
        var messagesSearchInput = document.getElementById(elementIds.messages_search_input);
        var siteCreatedAtElement = document.getElementById(elementIds.site_created_at);
        var siteCreatedAtContainer = document.getElementById(elementIds.site_created_at_container);
        var siteCreatedAtDefaultLabel = siteCreatedAtElement ? siteCreatedAtElement.textContent : '';
        var feedbackCountElement = document.getElementById(elementIds.feedback_count);
        var feedbackCountDefaultLabel = feedbackCountElement ? feedbackCountElement.textContent : '';
        var userName = document.getElementById(elementIds.user_name);
        var userEmail = document.getElementById(elementIds.user_email);
        var userAvatar = document.getElementById(elementIds.user_avatar);
        var userRole = document.getElementById(elementIds.user_role);
        var emptySitesMessage = document.getElementById(elementIds.empty_sites_message);
        var siteForm = document.getElementById(elementIds.site_form);
        var editSiteNameInput = document.getElementById(elementIds.edit_site_name);
        var editSiteOriginInput = document.getElementById(elementIds.edit_site_origin);
        var editSiteOwnerContainer = document.getElementById(elementIds.edit_site_owner_container);
        var editSiteOwnerInput = document.getElementById(elementIds.edit_site_owner);
        var saveSiteButton = document.getElementById(elementIds.save_site_button);
        var refreshMessagesButton = document.getElementById(elementIds.refresh_messages_button);
        var feedbackTableHeader = document.getElementById(elementIds.feedback_table_header);
        var feedbackTableBody = document.getElementById(elementIds.feedback_table_body);
        var logoutButton = document.getElementById(elementIds.logout_button);
        var widgetSnippetTextarea = document.getElementById(elementIds.widget_snippet_textarea);
        var copyWidgetSnippetButton = document.getElementById(elementIds.copy_widget_snippet_button);
        var deleteSiteButton = document.getElementById(elementIds.delete_site_button);
        var deleteSiteButtonDefaultClass = buttonClasses.delete_site_default || '';
        var deleteSiteButtonDisabledClass = buttonClasses.delete_site_disabled || '';
        var deleteSiteModalElement = document.getElementById(elementIds.delete_site_modal);
        var deleteSiteModal = deleteSiteModalElement && window.bootstrap && window.bootstrap.Modal ? new window.bootstrap.Modal(deleteSiteModalElement) : null;
        var deleteSiteConfirmButton = document.getElementById(elementIds.delete_site_confirm_button);
        var deleteSiteConfirmInput = document.getElementById(elementIds.delete_site_confirm_input);
        var deleteSiteTargetName = document.getElementById(elementIds.delete_site_target_name);
        var formStatus = document.getElementById(elementIds.form_status);
        var formStatusBaseClass = formStatusClasses.base || '';
        var formStatusSuccessClass = formStatusClasses.success || '';
        var formStatusDangerClass = formStatusClasses.danger || '';
        var formStatusDisplayDuration = 4000;
        var formStatusResetTimerId = null;
        var footerElement = document.getElementById(elementIds.footer);
        var footerThemeClasses = parsedConfig.footer_theme_classes || {};
        var tableThemeClasses = parsedConfig.table_theme_classes || {};
        var landingPath = sharedPaths.landing || '/';
        var logoutPath = sharedPaths.logout || '';
        var loginPath = sharedPaths.login || '';
        var widgetUnavailableMessage = widgetTexts.unavailable || '';
        var apiMeEndpoint = apiPaths.me || '';
        var apiSitesEndpoint = apiPaths.sites || '';
        var apiSiteUpdatePrefix = apiPaths.site_update_prefix || '';
        var apiSiteMessagesPrefix = apiPaths.site_messages_prefix || '';
        var apiSiteMessagesSuffix = apiPaths.site_messages_suffix || '';

        var state = {
          user: null,
          sites: [],
          selectedSiteId: '',
          pendingDeletionSiteId: '',
          siteMessages: {}
        };
        var siteSearchQuery = '';
        var messagesSearchQuery = '';
        var validationMessageKeyNameRequired = 'name_required';
        var validationMessageKeyOriginInvalid = 'origin_invalid';
        var validationMessageKeyOwnerInvalid = 'owner_invalid';
        var invalidFieldClassName = 'is-invalid';
        var validationEmailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        var mailtoSchemePrefix = 'mailto:';
        var contactLinkClassName = 'text-decoration-none';
        var emptyString = '';
        var statusNoSiteMatches = statusMessages.no_site_matches || '';
        var statusNoMessageMatches = statusMessages.no_message_matches || '';
        function shouldAlwaysValidate() {
          return true;
        }
        function shouldValidateOwnerEmail() {
          return Boolean(state.user);
        }
        function getTrimmedValue(element) {
          if (!element || typeof element.value !== 'string') {
            return '';
          }
          return element.value.trim();
        }
        function isSiteNameValid(value) {
          return value.length > 0;
        }
        function isAllowedOriginValid(value) {
          if (!value) {
            return false;
          }
          try {
            var parsed = new URL(value);
            if (parsed.protocol !== 'http:' && parsed.protocol !== 'https:') {
              return false;
            }
            if (!parsed.hostname) {
              return false;
            }
            if (parsed.username || parsed.password) {
              return false;
            }
            if ((parsed.pathname && parsed.pathname !== '/') || parsed.search || parsed.hash) {
              return false;
            }
            return true;
          } catch (error) {
            return false;
          }
        }
        function isOwnerEmailValid(value) {
          if (typeof value !== 'string') {
            return false;
          }
          var normalizedOwnerEmail = value.trim();
          if (normalizedOwnerEmail === '') {
            return false;
          }
          return validationEmailPattern.test(normalizedOwnerEmail);
        }
        var siteFormValidationDescriptors = [
          {
            fieldElement: editSiteNameInput,
            messageKey: validationMessageKeyNameRequired,
            shouldValidate: shouldAlwaysValidate,
            validateValue: isSiteNameValid
          },
          {
            fieldElement: editSiteOriginInput,
            messageKey: validationMessageKeyOriginInvalid,
            shouldValidate: shouldAlwaysValidate,
            validateValue: isAllowedOriginValid
          },
          {
            fieldElement: editSiteOwnerInput,
            messageKey: validationMessageKeyOwnerInvalid,
            shouldValidate: shouldValidateOwnerEmail,
            validateValue: isOwnerEmailValid
          }
        ];
        function clearValidationFeedback() {
          siteFormValidationDescriptors.forEach(function(descriptor) {
            if (descriptor.fieldElement) {
              descriptor.fieldElement.classList.remove(invalidFieldClassName);
            }
          });
          clearFormStatus();
        }
        function markFieldInvalid(fieldElement, messageKey) {
          if (!fieldElement) {
            return;
          }
          fieldElement.classList.add(invalidFieldClassName);
          fieldElement.focus();
          var message = validationMessages[messageKey] || '';
          setFormStatus(message, formStatusDangerClass);
        }
        function validateSiteForm() {
          clearValidationFeedback();
          for (var index = 0; index < siteFormValidationDescriptors.length; index += 1) {
            var descriptor = siteFormValidationDescriptors[index];
            if (!descriptor.fieldElement) {
              continue;
            }
            if (typeof descriptor.shouldValidate === 'function' && !descriptor.shouldValidate()) {
              continue;
            }
            var value = getTrimmedValue(descriptor.fieldElement);
            if (typeof descriptor.validateValue === 'function' && !descriptor.validateValue(value)) {
              markFieldInvalid(descriptor.fieldElement, descriptor.messageKey);
              return false;
            }
          }
          return true;
        }
        function registerValidationHandlers() {
          siteFormValidationDescriptors.forEach(function(descriptor) {
            if (!descriptor.fieldElement) {
              return;
            }
            descriptor.fieldElement.addEventListener('input', function() {
              descriptor.fieldElement.classList.remove(invalidFieldClassName);
              clearFormStatus();
            });
          });
        }
        function registerSiteFormTabCycle() {
          var tabOrderedFields = [editSiteNameInput, editSiteOriginInput, editSiteOwnerInput].filter(function(element) {
            return element;
          });
          if (tabOrderedFields.length === 0) {
            return;
          }
          tabOrderedFields.forEach(function(field, index) {
            field.addEventListener('keydown', function(event) {
              if (event.key !== 'Tab') {
                return;
              }
              event.preventDefault();
              var direction = event.shiftKey ? -1 : 1;
              var nextIndex = (index + direction + tabOrderedFields.length) % tabOrderedFields.length;
              tabOrderedFields[nextIndex].focus();
            });
          });
        }
        function renderContactValue(cell, value) {
          if (!cell) {
            return;
          }
          var normalized = (value || emptyString).trim();
          if (normalized.length === 0) {
            cell.textContent = emptyString;
            return;
          }
          if (validationEmailPattern.test(normalized)) {
            var link = document.createElement('a');
            link.href = mailtoSchemePrefix + normalized;
            link.textContent = normalized;
            link.className = contactLinkClassName;
            cell.textContent = emptyString;
            cell.appendChild(link);
            return;
          }
          cell.textContent = normalized;
        }
        function setSiteCreatedAt(unixSeconds) {
          if (!siteCreatedAtElement) {
            return;
          }
          var hasTimestamp = typeof unixSeconds === 'number' && unixSeconds > 0;
          if (!hasTimestamp) {
            siteCreatedAtElement.textContent = siteCreatedAtDefaultLabel;
          } else {
            siteCreatedAtElement.textContent = formatTimestamp(unixSeconds);
          }
          if (!siteCreatedAtContainer) {
            return;
          }
          if (!hasTimestamp || !state.user || state.user.role !== adminRoleValue) {
            siteCreatedAtContainer.classList.add('d-none');
            return;
          }
          siteCreatedAtContainer.classList.remove('d-none');
        }
        function setFeedbackCount(total, visible) {
          if (!feedbackCountElement) {
            return;
          }
          var normalizedTotal = typeof total === 'number' && total >= 0 ? total : 0;
          var normalizedVisible = typeof visible === 'number' && visible >= 0 ? visible : normalizedTotal;
          if (normalizedTotal === 0) {
            feedbackCountElement.textContent = feedbackCountDefaultLabel;
            feedbackCountElement.classList.add('d-none');
            return;
          }
          feedbackCountElement.classList.remove('d-none');
          if (normalizedVisible !== normalizedTotal) {
            feedbackCountElement.textContent = normalizedVisible + ' / ' + normalizedTotal;
          } else {
            feedbackCountElement.textContent = normalizedTotal.toString();
          }
        }
        function updateSelectedSiteSummary(site) {
          if (!site) {
            setSiteCreatedAt(null);
            setFeedbackCount(0, 0);
            return;
          }
          setSiteCreatedAt(site.created_at);
          var totalCount = typeof site.feedback_count === 'number' ? site.feedback_count : 0;
          setFeedbackCount(totalCount, messagesSearchQuery ? Math.min(totalCount, totalCount) : totalCount);
        }
        function normalizeSearchQuery(value) {
          if (typeof value !== 'string') {
            return '';
          }
          return value.trim().toLowerCase();
        }
        function applySiteSearchQuery(value) {
          var normalized = normalizeSearchQuery(value);
          if (siteSearchQuery === normalized) {
            return;
          }
          siteSearchQuery = normalized;
          renderSites();
        }
        function applyMessagesSearchQuery(value) {
          var normalized = normalizeSearchQuery(value);
          if (messagesSearchQuery === normalized) {
            return;
          }
          messagesSearchQuery = normalized;
          renderMessages(getMessagesForSelectedSite());
        }
        function getFilteredSites() {
          if (!siteSearchQuery) {
            return state.sites.slice();
          }
          var query = siteSearchQuery;
          return state.sites.filter(function(site) {
            var name = (site.name || emptyString).toLowerCase();
            var origin = (site.allowed_origin || emptyString).toLowerCase();
            var owner = (site.owner_email || emptyString).toLowerCase();
            return name.indexOf(query) !== -1 || origin.indexOf(query) !== -1 || owner.indexOf(query) !== -1;
          });
        }
        function getMessagesForSelectedSite() {
          if (!state.selectedSiteId || !state.siteMessages) {
            return [];
          }
          return state.siteMessages[state.selectedSiteId] || [];
        }
        function showSiteSearch() {
          if (!siteSearchContainer) {
            return;
          }
          siteSearchContainer.classList.remove('d-none');
          if (siteSearchToggleButton) {
            siteSearchToggleButton.setAttribute('aria-expanded', 'true');
          }
          if (siteSearchInput) {
            siteSearchInput.focus();
          }
        }
        function hideSiteSearch() {
          if (!siteSearchContainer) {
            return;
          }
          siteSearchContainer.classList.add('d-none');
          if (siteSearchToggleButton) {
            siteSearchToggleButton.setAttribute('aria-expanded', 'false');
          }
          if (siteSearchInput) {
            siteSearchInput.value = '';
          }
          if (siteSearchQuery !== '') {
            siteSearchQuery = '';
            renderSites();
          }
        }
        function toggleSiteSearchVisibility() {
          if (!siteSearchContainer) {
            return;
          }
          if (siteSearchContainer.classList.contains('d-none')) {
            showSiteSearch();
          } else {
            hideSiteSearch();
          }
        }
        function showMessagesSearch() {
          if (!messagesSearchContainer) {
            return;
          }
          messagesSearchContainer.classList.remove('d-none');
          if (messagesSearchToggleButton) {
            messagesSearchToggleButton.setAttribute('aria-expanded', 'true');
          }
          if (messagesSearchInput) {
            messagesSearchInput.focus();
          }
        }
        function hideMessagesSearch() {
          if (!messagesSearchContainer) {
            return;
          }
          messagesSearchContainer.classList.add('d-none');
          if (messagesSearchToggleButton) {
            messagesSearchToggleButton.setAttribute('aria-expanded', 'false');
          }
          if (messagesSearchInput) {
            messagesSearchInput.value = '';
          }
          if (messagesSearchQuery !== '') {
            messagesSearchQuery = '';
            renderMessages(getMessagesForSelectedSite());
          }
        }
        function toggleMessagesSearchVisibility() {
          if (!messagesSearchContainer) {
            return;
          }
          if (messagesSearchContainer.classList.contains('d-none')) {
            showMessagesSearch();
          } else {
            hideMessagesSearch();
          }
        }
        function initializeFieldHelpPopovers() {
          if (!window.bootstrap || !window.bootstrap.Popover) {
            return;
          }
          [siteNameHelpButton, allowedOriginHelpButton, ownerEmailHelpButton].forEach(function(button) {
            if (button) {
              new window.bootstrap.Popover(button);
            }
          });
        }
        var buttonStatusDisplayDuration = 3000;
        var widgetBaseURL = window.location.origin.replace(/\/$/, '');
        if (widgetSnippetTextarea) {
          widgetSnippetTextarea.value = widgetUnavailableMessage;
        }
        if (copyWidgetSnippetButton) {
          copyWidgetSnippetButton.disabled = true;
        }
        setButtonDefault(copyWidgetSnippetButton, buttonLabels.copy_default || '', buttonClasses.copy_default || '');
        setButtonDefault(refreshMessagesButton, buttonLabels.refresh_default || '', buttonClasses.refresh_default || '');
        setButtonDefault(saveSiteButton, updateButtonLabel, updateButtonClass);
        registerValidationHandlers();
        registerSiteFormTabCycle();
        initializeFieldHelpPopovers();
        clearValidationFeedback();

        function applyThemePreference(mode) {
          var normalized = mode === 'dark' ? 'dark' : 'light';
          document.documentElement.setAttribute('data-bs-theme', normalized);
          if (normalized === 'dark') {
            document.body.classList.remove('bg-light');
            document.body.classList.add('bg-dark', 'text-light');
            applyElementThemeClasses(footerElement, footerThemeClasses.dark || '', footerThemeClasses.light || '');
            applyElementThemeClasses(feedbackTableHeader, tableThemeClasses.dark || '', tableThemeClasses.light || '');
          } else {
            document.body.classList.remove('bg-dark', 'text-light');
            if (!document.body.classList.contains('bg-light')) {
              document.body.classList.add('bg-light');
            }
            applyElementThemeClasses(footerElement, footerThemeClasses.light || '', footerThemeClasses.dark || '');
            applyElementThemeClasses(feedbackTableHeader, tableThemeClasses.light || '', tableThemeClasses.dark || '');
          }
        }

        function loadThemePreference() {
          var stored = localStorage.getItem(themePreferenceStorageKey);
          if (stored !== 'dark' && stored !== 'light') {
            var legacyStored = localStorage.getItem(themePreferenceLegacyStorageKey);
            if (legacyStored === 'dark' || legacyStored === 'light') {
              stored = legacyStored;
              localStorage.setItem(themePreferenceStorageKey, stored);
            } else {
              stored = 'light';
            }
          }
          themeToggle.checked = stored === 'dark';
          applyThemePreference(stored);
        }

        function persistThemePreference(mode) {
          localStorage.setItem(themePreferenceStorageKey, mode);
        }

        function fetchJSON(url, options) {
          var requestOptions = options || {};
          if (!requestOptions.credentials) {
            requestOptions.credentials = 'same-origin';
          }
          return window.fetch(url, requestOptions).then(function(response) {
            if (response.status === 401) {
              window.location.href = loginPath;
              return Promise.reject(new Error('unauthorized'));
            }
            var forbiddenResponse = response.status === 403;
            if (!response.ok) {
              if (forbiddenResponse && refreshMessagesButton) {
                updateButtonStatus(refreshMessagesButton, buttonLabels.refresh_failed || '', buttonStyles.danger || '');
              }
              return response.json().catch(function() {
                return {};
              }).then(function(body) {
                var backendErrorCode = '';
                if (body && typeof body.error === 'string') {
                  backendErrorCode = body.error;
                } else if (body && typeof body.message === 'string') {
                  backendErrorCode = body.message;
                }
                var resolvedMessage = resolveErrorMessage(backendErrorCode, statusMessages.load_failed || '');
                throw new Error(resolvedMessage);
              });
            }
            return response.json();
          });
        }

        function extractAvatarURL(user) {
          if (!user || typeof user !== 'object') {
            return '';
          }
          var avatar = user.avatar;
          if (!avatar || typeof avatar !== 'object') {
            return '';
          }
          var avatarURL = avatar.url;
          if (typeof avatarURL !== 'string') {
            return '';
          }
          return avatarURL.trim();
        }

        function updateUserCard() {
          var displayName = state.user.name || state.user.email;
          userName.textContent = displayName || '';
          userEmail.textContent = state.user.email || '';
          var avatarURL = extractAvatarURL(state.user);
          if (avatarURL) {
            userAvatar.src = avatarURL;
            userAvatar.classList.remove('d-none');
          } else {
            userAvatar.src = '';
            userAvatar.classList.add('d-none');
          }
          var isAdminUser = state.user.role === adminRoleValue;
          var roleLabel = isAdminUser ? roleLabels[adminRoleValue] : roleLabels[userRoleValue];
          userRole.textContent = roleLabel;
          userRole.className = isAdminUser ? 'badge bg-warning text-dark mt-2' : 'badge bg-secondary mt-2';
          if (editSiteOwnerContainer) {
            editSiteOwnerContainer.classList.remove('d-none');
          }

          var shouldShowAvatar = avatarURL !== '';
          settingsAvatarImage.src = shouldShowAvatar ? avatarURL : '';
          if (shouldShowAvatar) {
            settingsAvatarImage.classList.remove('d-none');
            settingsAvatarFallback.classList.add('d-none');
          } else {
            settingsAvatarImage.classList.add('d-none');
            settingsAvatarFallback.classList.remove('d-none');
          }
          clearValidationFeedback();
        }

        function isNewSiteSelected() {
          return state.selectedSiteId === newSiteOptionValue;
        }

        function buildWidgetSnippet(siteId) {
          return '<script defer src="' + widgetBaseURL + '/widget.js?site_id=' + siteId + '"></script>';
        }

        function updateButtonStatus(button, text, extraClass) {
          if (!button) {
            return;
          }
          if (!button._defaultText) {
            button._defaultText = button.textContent;
          }
          if (!button._defaultClass) {
            button._defaultClass = button.className;
          }
          button.textContent = text;
          button.className = extraClass || button._defaultClass;
          button._statusActive = true;
          clearTimeout(button._statusTimer);
          button._statusTimer = window.setTimeout(function() {
            button._statusActive = false;
            restoreButtonDefault(button);
          }, buttonStatusDisplayDuration);
        }

        function setButtonDefault(button, label, className) {
          if (!button) {
            return;
          }
          button._defaultText = label;
          button._defaultClass = className;
          if (button._statusActive) {
            return;
          }
          restoreButtonDefault(button);
        }

        function restoreButtonDefault(button) {
          if (!button) {
            return;
          }
          if (typeof button._defaultText === 'string') {
            button.textContent = button._defaultText;
          }
          if (typeof button._defaultClass === 'string') {
            button.className = button._defaultClass;
          }
        }

        function normalizeClassList(value) {
          if (typeof value !== 'string') {
            return [];
          }
          return value.split(/\s+/).filter(function(item) {
            return item.length > 0;
          });
        }

        function normalizeMessage(value) {
          if (typeof value !== 'string') {
            return '';
          }
          return value.trim();
        }

        function resolveErrorMessage(errorCode, fallbackMessage) {
          var normalizedCode = normalizeMessage(errorCode);
          if (normalizedCode !== '') {
            var mappedMessage = normalizeMessage(errorMessages[normalizedCode]);
            if (mappedMessage !== '') {
              return mappedMessage;
            }
          }
          var normalizedFallback = normalizeMessage(fallbackMessage);
          if (normalizedFallback !== '') {
            return normalizedFallback;
          }
          if (normalizedCode !== '') {
            return normalizedCode;
          }
          return '';
        }

        function applyElementThemeClasses(element, classesToAdd, classesToRemove) {
          if (!element) {
            return;
          }
          normalizeClassList(classesToRemove).forEach(function(className) {
            element.classList.remove(className);
          });
          normalizeClassList(classesToAdd).forEach(function(className) {
            element.classList.add(className);
          });
        }

        function updateNewSiteButtonState() {
          if (!newSiteButton) {
            return;
          }
          if (isNewSiteSelected()) {
            newSiteButton.className = newSiteButtonActiveClass;
          } else {
            newSiteButton.className = newSiteButtonDefaultClass;
          }
        }

        function updateDeleteButtonState() {
          if (!deleteSiteButton) {
            return;
          }
          var shouldDisable = state.sites.length === 0 || !state.selectedSiteId || isNewSiteSelected();
          deleteSiteButton.disabled = shouldDisable;
          deleteSiteButton.className = shouldDisable ? deleteSiteButtonDisabledClass : deleteSiteButtonDefaultClass;
        }

        function setFormStatus(message, className) {
          if (!formStatus) {
            return;
          }
          if (formStatusResetTimerId) {
            clearTimeout(formStatusResetTimerId);
            formStatusResetTimerId = null;
          }
          formStatus.textContent = message;
          formStatus.className = className;
          var trimmed = (message || '').trim();
          if (trimmed === '') {
            clearFormStatus();
            return;
          }
          formStatusResetTimerId = window.setTimeout(function() {
            clearFormStatus();
          }, formStatusDisplayDuration);
        }

        function clearFormStatus() {
          if (!formStatus) {
            return;
          }
          if (formStatusResetTimerId) {
            clearTimeout(formStatusResetTimerId);
            formStatusResetTimerId = null;
          }
          formStatus.textContent = '';
          formStatus.className = formStatusBaseClass;
        }

        function clearDeleteConfirmationInput() {
          if (deleteSiteConfirmInput) {
            deleteSiteConfirmInput.value = '';
            deleteSiteConfirmInput.dataset.expectedName = '';
          }
          if (deleteSiteConfirmButton) {
            deleteSiteConfirmButton.disabled = true;
          }
        }

        function updateDeleteConfirmationState() {
          if (!deleteSiteConfirmInput || !deleteSiteConfirmButton) {
            return;
          }
          var expectedName = (deleteSiteConfirmInput.dataset.expectedName || '').trim();
          var typedName = deleteSiteConfirmInput.value.trim();
          deleteSiteConfirmButton.disabled = expectedName === '' || typedName !== expectedName;
        }

        function openDeleteSiteModal() {
          if (!deleteSiteModal || !deleteSiteButton || deleteSiteButton.disabled) {
            return;
          }
          var site = state.sites.find(function(item) { return item.id === state.selectedSiteId; });
          if (!site) {
            return;
          }
          state.pendingDeletionSiteId = site.id;
          if (deleteSiteTargetName) {
            deleteSiteTargetName.textContent = site.name || '';
          }
          if (deleteSiteConfirmInput) {
            deleteSiteConfirmInput.dataset.expectedName = site.name || '';
            deleteSiteConfirmInput.value = '';
          }
          if (deleteSiteConfirmButton) {
            deleteSiteConfirmButton.disabled = true;
          }
          deleteSiteModal.show();
          window.setTimeout(function() {
            if (deleteSiteConfirmInput) {
              deleteSiteConfirmInput.focus();
            }
          }, 150);
        }

        function deleteSelectedSite() {
          if (!state.pendingDeletionSiteId) {
            return;
          }
          var site = state.sites.find(function(item) { return item.id === state.pendingDeletionSiteId; });
          if (!site) {
            return;
          }
          if (deleteSiteConfirmButton) {
            deleteSiteConfirmButton.disabled = true;
          }
          setFormStatus(statusMessages.deleting_site || '', formStatusDangerClass);
          window.fetch(apiSiteUpdatePrefix + site.id, {
            method: 'DELETE',
            credentials: 'same-origin'
          }).then(function(response) {
            if (response.status === 401) {
              window.location.href = loginPath;
              throw new Error('unauthorized');
            }
            if (!response.ok) {
              return response.json().catch(function() {
                return {};
              }).then(function(body) {
                var message = body.error || body.message || statusMessages.delete_site_failed || '';
                throw new Error(message);
              });
            }
            return response;
          }).then(function() {
            state.sites = state.sites.filter(function(item) { return item.id !== site.id; });
            if (state.siteMessages) {
              delete state.siteMessages[site.id];
            }
            state.selectedSiteId = state.sites.length > 0 ? state.sites[0].id : newSiteOptionValue;
            state.pendingDeletionSiteId = '';
            if (deleteSiteModal) {
              deleteSiteModal.hide();
            }
            clearDeleteConfirmationInput();
            renderSites();
            setFormStatus(statusMessages.site_deleted || '', formStatusSuccessClass);
          }).catch(function(error) {
            if (error && error.message === 'unauthorized') {
              return;
            }
            setFormStatus((error && error.message) || statusMessages.delete_site_failed || '', formStatusDangerClass);
            if (deleteSiteConfirmInput) {
              updateDeleteConfirmationState();
            }
          });
        }

        function updateWidgetSnippet() {
          if (!state.selectedSiteId || isNewSiteSelected()) {
            widgetSnippetTextarea.value = widgetUnavailableMessage;
            copyWidgetSnippetButton.disabled = true;
            return;
          }
          var site = state.sites.find(function(item) { return item.id === state.selectedSiteId; });
          if (!site) {
            widgetSnippetTextarea.value = widgetUnavailableMessage;
            copyWidgetSnippetButton.disabled = true;
            return;
          }
          widgetSnippetTextarea.value = buildWidgetSnippet(site.id);
          copyWidgetSnippetButton.disabled = false;
        }

        function copyWidgetSnippet() {
          if (copyWidgetSnippetButton.disabled) {
            return;
          }
          var snippet = widgetSnippetTextarea.value;
          if (!snippet || snippet === widgetUnavailableMessage) {
            updateButtonStatus(copyWidgetSnippetButton, buttonLabels.copy_failed || '', buttonStyles.danger || '');
            return;
          }
          if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(snippet).then(function() {
              updateButtonStatus(copyWidgetSnippetButton, buttonLabels.copy_copied || '', buttonStyles.primary || '');
            }).catch(function() {
              fallbackCopyWidgetSnippet(snippet);
            });
          } else {
            fallbackCopyWidgetSnippet(snippet);
          }
        }

        function fallbackCopyWidgetSnippet(snippet) {
          var previousSelectionStart = widgetSnippetTextarea.selectionStart;
          var previousSelectionEnd = widgetSnippetTextarea.selectionEnd;
          widgetSnippetTextarea.focus();
          widgetSnippetTextarea.select();
          var copySucceeded = false;
          try {
            copySucceeded = document.execCommand('copy');
          } catch (error) {
            copySucceeded = false;
          }
          widgetSnippetTextarea.selectionStart = previousSelectionStart;
          widgetSnippetTextarea.selectionEnd = previousSelectionEnd;
          widgetSnippetTextarea.blur();
          if (copySucceeded) {
            updateButtonStatus(copyWidgetSnippetButton, buttonLabels.copy_copied || '', buttonStyles.primary || '');
          } else {
            updateButtonStatus(copyWidgetSnippetButton, buttonLabels.copy_failed || '', buttonStyles.danger || '');
          }
        }

        function renderSites() {
          if (!sitesList) {
            return;
          }
          while (sitesList.firstChild) {
            sitesList.removeChild(sitesList.firstChild);
          }
          var filteredSites = getFilteredSites();
          var hasSites = filteredSites.length > 0;
          var previousSelectedSiteId = state.selectedSiteId;

          if (!state.selectedSiteId && hasSites) {
            state.selectedSiteId = filteredSites[0].id;
          }

          if (!isNewSiteSelected()) {
            var selectedExists = filteredSites.some(function(item) {
              return item.id === state.selectedSiteId;
            });
            if (!selectedExists) {
              if (hasSites) {
                state.selectedSiteId = filteredSites[0].id;
              } else if (siteSearchQuery === '') {
                state.selectedSiteId = state.sites.length > 0 ? state.sites[0].id : newSiteOptionValue;
              } else {
                state.selectedSiteId = '';
              }
            }
          }

          var selectedSite = null;
          filteredSites.forEach(function(site) {
            var listItem = document.createElement('button');
            listItem.type = 'button';
            listItem.className = siteListItemClass + (site.id === state.selectedSiteId ? ' ' + siteListItemActiveClass : '');
            listItem.dataset.siteId = site.id;

            if (site.id === state.selectedSiteId) {
              selectedSite = site;
            }

            var headerElement = document.createElement('div');
            headerElement.className = siteListItemHeaderClass;

            var faviconElement = document.createElement('img');
            faviconElement.className = siteListItemFaviconClass;
            faviconElement.width = 24;
            faviconElement.height = 24;
            faviconElement.alt = '';
            faviconElement.decoding = 'async';
            faviconElement.loading = 'lazy';
            faviconElement.referrerPolicy = 'no-referrer';
            var faviconURL = (site.favicon_url || '').trim();
            if (faviconURL.length > 0) {
              faviconElement.src = faviconURL;
              faviconElement.addEventListener('error', function() {
                faviconElement.classList.add('d-none');
              });
            } else {
              faviconElement.classList.add('d-none');
            }
            headerElement.appendChild(faviconElement);

            var nameElement = document.createElement('span');
            nameElement.className = 'fw-semibold text-truncate flex-grow-1';
            nameElement.textContent = site.name || '';
            headerElement.appendChild(nameElement);

            listItem.appendChild(headerElement);

            var originElement = document.createElement('div');
            originElement.className = 'small text-muted text-truncate';
            originElement.textContent = site.allowed_origin || '';
            listItem.appendChild(originElement);

            sitesList.appendChild(listItem);
          });

          if (hasSites) {
            emptySitesMessage.classList.add('d-none');
          } else {
            emptySitesMessage.textContent = siteSearchQuery ? statusNoSiteMatches : statusMessages.no_sites || '';
            emptySitesMessage.classList.remove('d-none');
          }

          updateNewSiteButtonState();
          updateDeleteButtonState();
          updateSelectedSiteSummary(selectedSite);
          populateSiteForm();
          updateWidgetSnippet();
          if (!state.selectedSiteId) {
            renderFeedbackPlaceholder(siteSearchQuery ? statusNoSiteMatches : statusMessages.select_site || '');
            return;
          }
          if (isNewSiteSelected()) {
            renderFeedbackPlaceholder(statusMessages.select_site || '');
            return;
          }
          if (previousSelectedSiteId !== state.selectedSiteId || !state.siteMessages[state.selectedSiteId]) {
            loadMessages(false);
            return;
          }
          renderMessages(state.siteMessages[state.selectedSiteId]);
        }

        function handleSitesListClick(event) {
          var target = event.target;
          while (target && target !== sitesList && !target.dataset.siteId) {
            target = target.parentElement;
          }
          if (!target || target === sitesList) {
            return;
          }
          var siteIdentifier = target.dataset.siteId;
          if (!siteIdentifier || siteIdentifier === state.selectedSiteId) {
            return;
          }
          clearValidationFeedback();
          state.selectedSiteId = siteIdentifier;
          renderSites();
        }

        function clearSiteForm() {
          editSiteNameInput.value = '';
          editSiteOriginInput.value = '';
          editSiteOwnerInput.value = '';
          clearValidationFeedback();
          setSiteCreatedAt(null);
          setFeedbackCount(0, 0);
        }

        function populateSiteForm() {
          clearValidationFeedback();
          if (!state.selectedSiteId) {
            updateSelectedSiteSummary(null);
            clearSiteForm();
            saveSiteButton.disabled = true;
            updateFormMode();
            updateWidgetSnippet();
            return;
          }

          if (isNewSiteSelected()) {
            updateSelectedSiteSummary(null);
            clearSiteForm();
            saveSiteButton.disabled = false;
            updateFormMode();
            updateWidgetSnippet();
            return;
          }

          var site = state.sites.find(function(item) { return item.id === state.selectedSiteId; });
          if (!site) {
            updateSelectedSiteSummary(null);
            clearSiteForm();
            saveSiteButton.disabled = true;
            updateFormMode();
            updateWidgetSnippet();
            return;
          }

          updateSelectedSiteSummary(site);
          editSiteNameInput.value = site.name || '';
          editSiteOriginInput.value = site.allowed_origin || '';
          editSiteOwnerInput.value = site.owner_email || '';
          saveSiteButton.disabled = false;
          updateFormMode();
          updateWidgetSnippet();
        }

        function updateFormMode() {
          if (!state.user) {
            return;
          }
          if (isNewSiteSelected()) {
            setButtonDefault(saveSiteButton, createButtonLabel, createButtonClass);
          } else {
            setButtonDefault(saveSiteButton, updateButtonLabel, updateButtonClass);
          }
          if (!editSiteOwnerInput) {
            return;
          }
          editSiteOwnerInput.disabled = false;
        }

        function renderFeedbackPlaceholder(message) {
          feedbackTableBody.innerHTML = '';
          var row = document.createElement('tr');
          var cell = document.createElement('td');
          cell.colSpan = 3;
          cell.className = 'text-center text-muted';
          cell.textContent = message;
          row.appendChild(cell);
          feedbackTableBody.appendChild(row);
          setFeedbackCount(0, 0);
        }

        function renderMessages(messages) {
          var baseMessages = Array.isArray(messages) ? messages : [];
          var filteredMessages = filterMessages(baseMessages);
          if (!filteredMessages.length) {
            if (baseMessages.length === 0 && messagesSearchQuery === '') {
              renderFeedbackPlaceholder(statusMessages.no_messages || '');
              setFeedbackCount(0, 0);
              return;
            }
            renderFeedbackPlaceholder(messagesSearchQuery ? statusNoMessageMatches : statusMessages.no_messages || '');
            setFeedbackCount(baseMessages.length, 0);
            return;
          }
          feedbackTableBody.innerHTML = '';
          filteredMessages.forEach(function(message) {
            var row = document.createElement('tr');
            var createdCell = document.createElement('td');
            createdCell.textContent = formatTimestamp(message.created_at);
            var contactCell = document.createElement('td');
            renderContactValue(contactCell, message.contact);
            var bodyCell = document.createElement('td');
            bodyCell.textContent = message.message;
            row.appendChild(createdCell);
            row.appendChild(contactCell);
            row.appendChild(bodyCell);
            feedbackTableBody.appendChild(row);
          });
          setFeedbackCount(baseMessages.length, filteredMessages.length);
        }

        function filterMessages(messages) {
          if (!messagesSearchQuery) {
            return messages.slice();
          }
          var query = messagesSearchQuery;
          return messages.filter(function(message) {
            var contactValue = (message.contact || emptyString).toLowerCase();
            var bodyValue = (message.message || emptyString).toLowerCase();
            return contactValue.indexOf(query) !== -1 || bodyValue.indexOf(query) !== -1;
          });
        }

        function formatTimestamp(unixSeconds) {
          if (!unixSeconds) {
            return '';
          }
          var date = new Date(unixSeconds * 1000);
          return date.toLocaleDateString();
        }

        function loadUser() {
          return fetchJSON(apiMeEndpoint).then(function(payload) {
            state.user = payload;
            updateUserCard();
          }).catch(function(error) {
            updateButtonStatus(saveSiteButton, error.message || buttonLabels.save_failed || '', buttonStyles.danger || '');
            saveSiteButton.disabled = false;
            throw error;
          });
        }

        function loadSites() {
          updateButtonStatus(refreshMessagesButton, buttonLabels.refresh_loading || '', buttonStyles.secondary || '');
          return fetchJSON(apiSitesEndpoint).then(function(payload) {
            state.sites = payload.sites || [];
            state.siteMessages = {};
            renderSites();
          }).catch(function(error) {
            updateButtonStatus(saveSiteButton, error.message || buttonLabels.save_failed || '', buttonStyles.danger || '');
            saveSiteButton.disabled = false;
          });
        }

        function loadMessages(shouldUpdateButtonStatus) {
          var manualRefresh = shouldUpdateButtonStatus === true;
          if (!state.selectedSiteId || isNewSiteSelected()) {
            renderFeedbackPlaceholder(statusMessages.select_site || '');
            if (manualRefresh) {
              setButtonDefault(refreshMessagesButton, buttonLabels.refresh_default || '', buttonClasses.refresh_default || '');
            }
            return;
          }
          var endpoint = apiSiteMessagesPrefix + state.selectedSiteId + apiSiteMessagesSuffix;
          renderFeedbackPlaceholder(statusMessages.loading_sites || 'Loading...');
          if (manualRefresh) {
            updateButtonStatus(refreshMessagesButton, buttonLabels.refresh_loading || '', buttonStyles.secondary || '');
          }
          fetchJSON(endpoint).then(function(payload) {
            var messages = payload.messages || [];
            var site = state.sites.find(function(item) { return item.id === state.selectedSiteId; });
            state.siteMessages[state.selectedSiteId] = messages;
            if (site) {
              site.feedback_count = messages.length;
              updateSelectedSiteSummary(site);
            }
            renderMessages(messages);
            if (manualRefresh) {
              updateButtonStatus(refreshMessagesButton, buttonLabels.refresh_success || '', buttonStyles.secondary || '');
            }
        }).catch(function() {
          renderFeedbackPlaceholder(statusMessages.load_failed || '');
          var site = state.sites.find(function(item) { return item.id === state.selectedSiteId; });
          if (site) {
            setFeedbackCount(site.feedback_count || 0, site.feedback_count || 0);
          } else {
            setFeedbackCount(0, 0);
          }
          if (manualRefresh) {
            updateButtonStatus(refreshMessagesButton, buttonLabels.refresh_failed || '', buttonStyles.danger || '');
          }
        });
      }

      function closeFaviconEventStream() {
        if (!faviconEventSource) {
          return;
        }
        faviconEventSource.close();
        faviconEventSource = null;
      }

      function openFaviconEventStream() {
        if (!window.EventSource || !siteFaviconEventsEndpoint) {
          return;
        }
        closeFaviconEventStream();
        faviconEventSource = new EventSource(siteFaviconEventsEndpoint);
        faviconEventSource.addEventListener(faviconUpdatedEventName, handleFaviconUpdateEvent);
        faviconEventSource.onerror = function() {
          closeFaviconEventStream();
          window.setTimeout(openFaviconEventStream, faviconReconnectDelayMilliseconds);
        };
      }

      function handleFaviconUpdateEvent(event) {
        if (!event || !event.data) {
          return;
        }
        var payload;
        try {
          payload = JSON.parse(event.data);
        } catch (error) {
          return;
        }
        var siteIdentifier = (payload.site_id || '').trim();
        var faviconURL = (payload.favicon_url || '').trim();
        if (!siteIdentifier || !faviconURL) {
          return;
        }
        var site = state.sites.find(function(item) { return item.id === siteIdentifier; });
        if (!site) {
          return;
        }
        if (site.favicon_url === faviconURL) {
          return;
        }
        site.favicon_url = faviconURL;
        renderSites();
      }

      function submitSite(event) {
        if (event) { event.preventDefault(); }
        if (saveSiteButton.disabled) { return; }
        if (!state.selectedSiteId) {
            updateButtonStatus(saveSiteButton, statusMessages.select_site || '', buttonStyles.secondary || '');
            return;
          }
          if (!validateSiteForm()) {
            return;
          }
          if (isNewSiteSelected()) {
            createSite();
          } else {
            updateSite();
          }
        }

        function updateSite() {
          saveSiteButton.disabled = true;
          updateButtonStatus(saveSiteButton, buttonLabels.save_saving || '');
          var ownerEmailValue = getTrimmedValue(editSiteOwnerInput);
          var body = {
            name: getTrimmedValue(editSiteNameInput),
            allowed_origin: getTrimmedValue(editSiteOriginInput)
          };
          if (ownerEmailValue) {
            body.owner_email = ownerEmailValue;
          }
          var endpoint = apiSiteUpdatePrefix + state.selectedSiteId;
          fetchJSON(endpoint, {
            method: 'PATCH',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(body)
          }).then(function(payload) {
            updateButtonStatus(saveSiteButton, buttonLabels.save_saved || '');
            saveSiteButton.disabled = false;
            var index = state.sites.findIndex(function(item) { return item.id === payload.id; });
            if (index >= 0) {
              state.sites[index] = payload;
            }
            renderSites();
          }).catch(function(error) {
            updateButtonStatus(saveSiteButton, error.message || buttonLabels.save_failed || '', buttonStyles.danger || '');
            saveSiteButton.disabled = false;
          });
        }

        function createSite() {
          saveSiteButton.disabled = true;
          updateButtonStatus(saveSiteButton, buttonLabels.save_saving || '');
          var body = {
            name: getTrimmedValue(editSiteNameInput),
            allowed_origin: getTrimmedValue(editSiteOriginInput),
            owner_email: getTrimmedValue(editSiteOwnerInput)
          };
          fetchJSON(apiSitesEndpoint, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(body)
          }).then(function(payload) {
            updateButtonStatus(saveSiteButton, buttonLabels.save_created || '');
            saveSiteButton.disabled = false;
            state.sites.unshift(payload);
            if (!state.siteMessages) {
              state.siteMessages = {};
            }
            state.siteMessages[payload.id] = [];
            state.selectedSiteId = payload.id;
            renderSites();
          }).catch(function(error) {
            updateButtonStatus(saveSiteButton, error.message || buttonLabels.save_failed || '', buttonStyles.danger || '');
            saveSiteButton.disabled = false;
          });
        }

        if (sitesList) {
          sitesList.addEventListener('click', handleSitesListClick);
        }
        if (siteSearchToggleButton) {
          siteSearchToggleButton.addEventListener('click', function(event) {
            event.preventDefault();
            toggleSiteSearchVisibility();
          });
        }
        if (siteSearchInput) {
          siteSearchInput.addEventListener('input', function() {
            applySiteSearchQuery(siteSearchInput.value);
          });
          siteSearchInput.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
              hideSiteSearch();
            }
          });
        }
        if (newSiteButton) {
          newSiteButton.addEventListener('click', function(event) {
            event.preventDefault();
            if (state.selectedSiteId === newSiteOptionValue) {
              return;
            }
            clearValidationFeedback();
            state.selectedSiteId = newSiteOptionValue;
            renderSites();
          });
        }
        if (deleteSiteButton) {
          deleteSiteButton.addEventListener('click', function(event) {
            event.preventDefault();
            openDeleteSiteModal();
          });
        }
        if (messagesSearchToggleButton) {
          messagesSearchToggleButton.addEventListener('click', function(event) {
            event.preventDefault();
            toggleMessagesSearchVisibility();
          });
        }
        if (messagesSearchInput) {
          messagesSearchInput.addEventListener('input', function() {
            applyMessagesSearchQuery(messagesSearchInput.value);
          });
          messagesSearchInput.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
              hideMessagesSearch();
            }
          });
        }
        if (deleteSiteConfirmInput) {
          deleteSiteConfirmInput.addEventListener('input', function() {
            updateDeleteConfirmationState();
          });
        }
        if (deleteSiteConfirmButton) {
          deleteSiteConfirmButton.addEventListener('click', function(event) {
            event.preventDefault();
            deleteSelectedSite();
          });
        }
        if (deleteSiteModalElement) {
          deleteSiteModalElement.addEventListener('hidden.bs.modal', function() {
            state.pendingDeletionSiteId = '';
            clearDeleteConfirmationInput();
          });
        }

        if (siteForm) {
          siteForm.addEventListener('submit', submitSite);
        }
        if (saveSiteButton) {
          saveSiteButton.addEventListener('click', submitSite);
        }
        if (themeToggle) {
          themeToggle.addEventListener('change', function(event) {
            var mode = event.target.checked ? 'dark' : 'light';
            applyThemePreference(mode);
            persistThemePreference(mode);
          });
        }
        if (copyWidgetSnippetButton) {
          copyWidgetSnippetButton.addEventListener('click', function(event) {
            event.preventDefault();
            copyWidgetSnippet();
          });
        }
        if (refreshMessagesButton) {
          refreshMessagesButton.addEventListener('click', function(event) {
            event.preventDefault();
            loadMessages(true);
          });
        }
        if (logoutButton) {
          logoutButton.addEventListener('click', function(event) {
            event.preventDefault();
            if (!logoutPath) {
              window.location.href = landingPath;
              return;
            }
            var redirectToLanding = function() {
              window.location.href = landingPath;
            };
            window.fetch(logoutPath, {
              method: 'POST',
              credentials: 'same-origin'
            }).then(redirectToLanding).catch(redirectToLanding);
          });
        }

        window.addEventListener('beforeunload', function() {
          closeFaviconEventStream();
        });

        var inactivityWarningDurationMilliseconds = 60000;
        var autoLogoutDurationMilliseconds = 120000;
        var inactivityCheckIntervalMilliseconds = 1000;
        var lastActivityTimestamp = Date.now();
        var inactivityWarningDisplayed = false;
        var autoLogoutTimerId = null;
        var inactivityWarningBar = document.getElementById('inactivity-warning-bar');
        var inactivityWarningMessage = document.getElementById('inactivity-warning-message');
        var inactivityWarningYesButton = document.getElementById('inactivity-warning-yes');
        var inactivityWarningNoButton = document.getElementById('inactivity-warning-no');

        function resetInactivityTimer() {
          lastActivityTimestamp = Date.now();
          if (inactivityWarningDisplayed) {
            hideInactivityWarning();
          }
        }

        function showInactivityWarning() {
          if (inactivityWarningDisplayed) {
            return;
          }
          inactivityWarningDisplayed = true;
          var warningDurationMinutes = Math.floor(inactivityWarningDurationMilliseconds / 60000);
          var countdownDurationSeconds = Math.ceil((autoLogoutDurationMilliseconds - inactivityWarningDurationMilliseconds) / 1000);
          inactivityWarningMessage.textContent = 'you have been inactive for ' + warningDurationMinutes + ' minute. Log off?';
          if (inactivityWarningBar) {
            inactivityWarningBar.classList.remove('d-none');
          }
          autoLogoutTimerId = window.setTimeout(function() {
            performLogout();
          }, autoLogoutDurationMilliseconds - inactivityWarningDurationMilliseconds);
        }

        function hideInactivityWarning() {
          inactivityWarningDisplayed = false;
          if (inactivityWarningBar) {
            inactivityWarningBar.classList.add('d-none');
          }
          if (autoLogoutTimerId) {
            window.clearTimeout(autoLogoutTimerId);
            autoLogoutTimerId = null;
          }
        }

        function performLogout() {
          if (!logoutPath) {
            window.location.href = landingPath;
            return;
          }
          var redirectAfterLogout = function() {
            window.location.href = landingPath;
          };
          window.fetch(logoutPath, {
            method: 'POST',
            credentials: 'same-origin'
          }).then(redirectAfterLogout).catch(redirectAfterLogout);
        }

        function checkUserInactivity() {
          var currentTimestamp = Date.now();
          var inactiveDurationMilliseconds = currentTimestamp - lastActivityTimestamp;

          if (inactiveDurationMilliseconds >= inactivityWarningDurationMilliseconds && !inactivityWarningDisplayed) {
            showInactivityWarning();
          }
        }

        if (inactivityWarningYesButton) {
          inactivityWarningYesButton.addEventListener('click', function() {
            performLogout();
          });
        }

        if (inactivityWarningNoButton) {
          inactivityWarningNoButton.addEventListener('click', function() {
            resetInactivityTimer();
          });
        }

        var activityEventNames = ['mousedown', 'keydown', 'scroll', 'touchstart', 'click'];
        activityEventNames.forEach(function(eventName) {
          document.addEventListener(eventName, resetInactivityTimer, { passive: true });
        });

        window.setInterval(checkUserInactivity, inactivityCheckIntervalMilliseconds);

        loadThemePreference();
        loadUser().then(function() {
          openFaviconEventStream();
          return loadSites();
        });
      })();
    </script>
  </body>
</html>
