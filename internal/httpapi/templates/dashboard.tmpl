<!doctype html>
<html lang="en" data-bs-theme="light">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{{ .PageTitle }}</title>
    <link rel="icon" href="{{ .FaviconDataURL }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <style>
      body {
        padding-top: 4.5rem;
        padding-bottom: 3.5rem;
      }
      .dashboard-main {
        min-height: calc(100vh - 8rem);
      }
      .dashboard-sites-scroll {
        max-height: calc(100vh - 9rem);
        overflow-y: auto;
      }
      .surface-nav,
      .surface-footer,
      .surface-card-header {
        background-color: var(--bs-secondary-bg);
        color: var(--bs-body-color);
        border-color: var(--bs-border-color);
      }
      .surface-nav {
        border-bottom: 1px solid var(--bs-border-color);
      }
      .surface-footer {
        border-top: 1px solid var(--bs-border-color);
      }
      .surface-card-header {
        border-bottom: 1px solid var(--bs-border-color);
      }
      .surface-card-header .fw-semibold {
        font-size: 1.05rem;
      }
      .account-toggle {
        border-radius: 999px;
        width: 40px;
        height: 40px;
        border: 2px solid transparent;
        background: transparent;
        color: var(--bs-body-color);
        padding: 0;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }
      .account-toggle:hover,
      .account-toggle:focus {
        border-color: var(--bs-body-color);
        background: transparent;
        color: var(--bs-body-color);
        box-shadow: none;
      }
      .account-toggle img {
        border-radius: 999px;
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .account-toggle .avatar-initial {
        border-radius: 999px;
        width: 100%;
        height: 100%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        background: var(--bs-primary);
        color: #fff;
      }
      .status-placeholder {
        min-width: 0;
      }
      .status-placeholder:empty {
        display: none;
      }
      .btn-icon {
        background: transparent;
        border: 0;
        color: var(--bs-danger);
        padding: 0;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }
      .btn-icon:disabled {
        color: var(--bs-secondary);
      }
      .list-group-item-action.active {
        background-color: var(--bs-primary);
        border-color: var(--bs-primary);
      }
    </style>
  </head>
  <body>
    <header class="navbar surface-nav shadow-sm fixed-top navbar-light">
      <div class="container-fluid">
        <span class="navbar-brand fw-semibold">LoopAware</span>
        <div class="dropdown">
          <button class="account-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
            {{ if .CurrentUser.PictureURL }}
              <img src="{{ .CurrentUser.PictureURL }}" alt="avatar">
            {{ else }}
              <span class="avatar-initial">{{ .CurrentUser.AvatarInitial }}</span>
            {{ end }}
          </button>
          <div class="dropdown-menu dropdown-menu-end shadow">
            <div class="px-3 py-2 border-bottom">
              <div class="fw-semibold">{{ if .CurrentUser.Name }}{{ .CurrentUser.Name }}{{ else }}Account{{ end }}</div>
              <div class="text-muted small">{{ .CurrentUser.Email }}</div>
              {{ if .CurrentUser.IsAdmin }}
                <span class="badge text-bg-warning mt-2">Administrator</span>
              {{ end }}
            </div>
            <div class="px-3 py-3">
              <div class="form-check form-switch mb-0">
                <input class="form-check-input" type="checkbox" id="{{ .CurrentUser.ThemeToggleID }}">
                <label class="form-check-label" for="{{ .CurrentUser.ThemeToggleID }}">Dark mode</label>
              </div>
            </div>
            <div class="dropdown-divider"></div>
            <a class="dropdown-item text-danger py-2" href="{{ .LogoutPath }}">Log out</a>
          </div>
        </div>
      </div>
    </header>

    <main class="container-xxl px-4 px-lg-5 dashboard-main py-3">
      <div class="row g-4">
        <aside id="sites-panel" class="col-lg-4">
          <div class="card shadow-sm h-100">
            <div class="card-header surface-card-header d-flex justify-content-between align-items-center">
              <span class="fw-semibold">Sites</span>
              <div class="d-flex align-items-center gap-2">
                <button type="button" class="btn-icon" title="Delete site" data-bs-toggle="modal" data-bs-target="#deleteSiteModal" data-site-name="{{ if .SelectedSite }}{{ .SelectedSite.Name }}{{ end }}" data-delete-url="{{ if .DeleteAllowed }}{{ .DeleteActionURL }}{{ end }}" {{ if not .DeleteAllowed }}disabled{{ end }}>
                  <i class="bi bi-trash-fill"></i>
                </button>
                <a class="btn btn-sm btn-outline-primary" href="{{ printf "%s?%s=%s" "/app" "site_id" "new" }}" data-site-link data-role="site-new">New</a>
              </div>
            </div>
            <div class="list-group list-group-flush dashboard-sites-scroll">
              {{ if eq (len .Sites) 0 }}
                <div class="list-group-item text-muted">No sites registered yet.</div>
              {{ else }}
                {{ range .Sites }}
                  <a href="{{ printf "%s?%s=%s" "/app" "site_id" .ID }}" class="list-group-item list-group-item-action {{ if .IsActive }}active text-white{{ end }}" data-site-link data-role="site-select">
                    <div class="fw-semibold">{{ .Name }}</div>
                    <div class="small text-muted">{{ .AllowedOrigin }}</div>
                  </a>
                {{ end }}
              {{ end }}
            </div>
          </div>
        </aside>

        <section class="col-lg-8">
          <form id="site-form-panel" method="post" action="{{ .SiteForm.ActionURL }}" class="card shadow-sm mb-4" data-ajax="true" data-role="site-form">
            <div class="card-header surface-card-header d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3">
              <div>
                <span class="fw-semibold fs-5">{{ if .IsCreateMode }}Create site{{ else }}Site details{{ end }}</span>
                {{ if and .SelectedSite (not .IsCreateMode) }}
                  <div class="text-muted small">Created {{ .SelectedSite.CreatedAt }}</div>
                {{ end }}
              </div>
              <div class="d-flex align-items-center gap-3">
                <span class="small status-placeholder {{ .SiteStatus.Class }}" data-status-role="site" data-default-message="{{ .SiteStatusDefault }}" data-default-class="{{ .SiteStatusDefaultClass }}" {{ if .SiteStatus.Ephemeral }}data-ephemeral="1"{{ end }}>{{ .SiteStatus.Message }}</span>
                <button type="submit" class="{{ .SiteForm.SubmitClass }}" data-loading-label="{{ if .IsCreateMode }}Saving site...{{ else }}Updating site...{{ end }}" data-loading-status="{{ if .IsCreateMode }}Saving site...{{ else }}Updating site...{{ end }}" data-default-label="{{ .SiteForm.SubmitLabel }}">{{ .SiteForm.SubmitLabel }}</button>
              </div>
            </div>
            <div class="card-body">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label" for="site-name">Name</label>
                  <input id="site-name" name="name" type="text" class="form-control" value="{{ .SiteForm.Name }}" required>
                </div>
                <div class="col-md-6">
                  <label class="form-label" for="site-origin">Allowed origin</label>
                  <input id="site-origin" name="allowed_origin" type="text" class="form-control" value="{{ .SiteForm.AllowedOrigin }}" required>
                </div>
                {{ if .CurrentUser.IsAdmin }}
                  <div class="col-md-6">
                    <label class="form-label" for="site-owner">Owner email</label>
                    <input id="site-owner" name="owner_email" type="email" class="form-control" value="{{ .SiteForm.OwnerEmail }}" required>
                  </div>
                {{ else }}
                  <input type="hidden" name="owner_email" value="{{ .SiteForm.OwnerEmail }}">
                {{ end }}
              </div>
            </div>
          </form>

          <div id="widget-panel" class="card shadow-sm mb-4">
            <div class="card-header surface-card-header d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3">
              <span class="fw-semibold fs-5">Widget</span>
              <div class="d-flex align-items-center gap-3">
                <span class="small status-placeholder {{ .WidgetStatus.Class }}" data-status-role="widget" data-default-message="{{ .WidgetStatusDefault }}" data-default-class="{{ .WidgetStatusDefaultClass }}" {{ if .WidgetStatus.Ephemeral }}data-ephemeral="1"{{ end }}>{{ .WidgetStatus.Message }}</span>
                <button type="button" class="btn btn-sm btn-outline-primary" id="widget-copy-button" {{ if not .WidgetCopyEnabled }}disabled{{ end }}>Copy widget</button>
              </div>
            </div>
            <div class="card-body">
              <textarea class="form-control" id="widget-snippet" rows="3" readonly {{ if not .WidgetCopyEnabled }}disabled{{ end }}>{{ .WidgetSnippet }}</textarea>
            </div>
          </div>

          <div id="feedback-panel" class="card shadow-sm mb-5">
            <div class="card-header surface-card-header d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3">
              <span class="fw-semibold fs-5">Feedback</span>
              <div class="d-flex align-items-center gap-3">
                <span class="small status-placeholder {{ .FeedbackStatus.Class }}" data-status-role="feedback" data-default-message="{{ .FeedbackStatusDefault }}" data-default-class="{{ .FeedbackStatusDefaultClass }}" {{ if .FeedbackStatus.Ephemeral }}data-ephemeral="1"{{ end }}>{{ .FeedbackStatus.Message }}</span>
                <a class="btn btn-sm btn-outline-secondary {{ if not .SelectedSite }}disabled{{ end }}" href="{{ if .SelectedSite }}{{ .FeedbackRefresh }}{{ else }}#{{ end }}" data-site-link data-role="feedback-refresh" data-loading-label="Refreshing..." data-loading-status="Refreshing feedback...">Refresh</a>
              </div>
            </div>
            <div class="card-body">
              {{ if not .SelectedSite }}
                <p class="text-muted mb-0">Select a site to review incoming messages.</p>
              {{ else if eq (len .FeedbackMessages) 0 }}
                <p class="text-muted mb-0">No feedback received yet.</p>
              {{ else }}
                <div class="table-responsive">
                  <table class="table table-sm align-middle mb-0">
                    <thead>
                      <tr>
                        <th scope="col">Received</th>
                        <th scope="col">Contact</th>
                        <th scope="col">Message</th>
                      </tr>
                    </thead>
                    <tbody>
                      {{ range .FeedbackMessages }}
                        <tr>
                          <td class="text-nowrap">{{ .CreatedAt }}</td>
                          <td>{{ .Contact }}</td>
                          <td>{{ .Message }}</td>
                        </tr>
                      {{ end }}
                    </tbody>
                  </table>
                </div>
              {{ end }}
            </div>
          </div>
        </section>
      </div>
    </main>

    <footer class="surface-footer text-end py-2 fixed-bottom">
      <div class="container small">
        Built by <a class="text-decoration-none text-warning" href="{{ .BrandURL }}" target="_blank" rel="noreferrer">{{ .BrandName }}</a>
      </div>
    </footer>

    <div class="modal fade" id="deleteSiteModal" tabindex="-1" aria-hidden="true" aria-labelledby="delete-site-modal-label">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <form id="delete-site-form" method="post" data-ajax="true" data-role="delete-site">
            <div class="modal-header">
              <h5 class="modal-title" id="delete-site-modal-label">Delete site</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <p class="mb-3">Type <strong id="delete-site-name-label"></strong> to confirm. This action cannot be undone.</p>
              <input type="text" class="form-control" id="delete-site-confirm-input" autocomplete="off" required>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-danger" id="delete-site-confirm-button" disabled>Delete site</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      (function() {
        var themeToggleId = "{{ .CurrentUser.ThemeToggleID }}";
        var themeStorageKey = "{{ .CurrentUser.ThemeStorageID }}";
        var themeToggle = document.getElementById(themeToggleId);

        function applyTheme(theme) {
          document.documentElement.setAttribute("data-bs-theme", theme);
          var navbar = document.querySelector(".surface-nav");
          if (navbar) {
            navbar.classList.toggle("navbar-dark", theme === "dark");
            navbar.classList.toggle("navbar-light", theme !== "dark");
          }
        }

        function currentTheme() {
          return document.documentElement.getAttribute("data-bs-theme") || "light";
        }

        var storedTheme = localStorage.getItem(themeStorageKey);
        var initialTheme = storedTheme === "dark" ? "dark" : "light";
        applyTheme(initialTheme);
        if (themeToggle) {
          themeToggle.checked = initialTheme === "dark";
          themeToggle.addEventListener("change", function() {
            var nextTheme = themeToggle.checked ? "dark" : "light";
            applyTheme(nextTheme);
            localStorage.setItem(themeStorageKey, nextTheme);
          });
        }

        function markBound(element, key) {
          element.dataset[key] = "1";
        }

        function isBound(element, key) {
          return element.dataset[key] === "1";
        }

        function replaceSection(id, doc) {
          var next = doc.getElementById(id);
          var current = document.getElementById(id);
          if (current && next) {
            current.replaceWith(next);
          }
        }

        function replacePanelsFromHTML(html) {
          var parser = new DOMParser();
          var doc = parser.parseFromString(html, "text/html");
          ["sites-panel","site-form-panel","widget-panel","feedback-panel","deleteSiteModal"].forEach(function(id) {
            replaceSection(id, doc);
          });
          rebind(document);
        }

        function setStatusElement(element, message, className, ephemeral) {
          if (!element) {
            return;
          }
          if (!element.dataset.baseClass) {
            element.dataset.baseClass = element.className.trim();
          }
          if (!element.dataset.defaultMessage) {
            element.dataset.defaultMessage = element.getAttribute("data-default-message") || "";
          }
          if (!element.dataset.defaultClass) {
            element.dataset.defaultClass = element.getAttribute("data-default-class") || "";
          }
          element.className = element.dataset.baseClass;
          if (className) {
            element.className += " " + className;
          }
          element.textContent = message || "";
          if (ephemeral) {
            element.dataset.ephemeral = "1";
            scheduleStatusReset([element]);
          } else {
            delete element.dataset.ephemeral;
            element.dataset.defaultMessage = message || "";
            element.dataset.defaultClass = className || "";
          }
        }

        function setStatus(role, message, className, ephemeral) {
          var element = document.querySelector("[data-status-role='" + role + "']");
          if (!element) {
            return;
          }
          setStatusElement(element, message, className, ephemeral);
        }

        function scheduleStatusReset(scope) {
          var nodes = Array.isArray(scope) ? scope : scope.querySelectorAll(".status-placeholder[data-ephemeral='1']");
          Array.prototype.forEach.call(nodes, function(element) {
            if (element.dataset.resetAttached === "1") {
              return;
            }
            element.dataset.resetAttached = "1";
            window.setTimeout(function() {
              setStatusElement(
                element,
                element.dataset.defaultMessage || "",
                element.dataset.defaultClass || "",
                false
              );
              delete element.dataset.resetAttached;
            }, 3000);
          });
        }

        function bindSiteLinks(root) {
          root.querySelectorAll("[data-site-link]").forEach(function(link) {
            if (isBound(link, "siteBound")) {
              return;
            }
            link.addEventListener("click", function(event) {
              if (event.metaKey || event.ctrlKey || event.shiftKey || event.altKey) {
                return;
              }
              event.preventDefault();
              var role = link.dataset.role || "";
              var callbacks = [];
              if (role === "feedback-refresh") {
                setStatus("feedback", "Refreshing...", "text-info", true);
                callbacks.push(function() {
                  setStatus("feedback", "Feedback refreshed.", "text-success", true);
                });
              } else if (role === "site-new") {
                setStatus("site", "Preparing new site...", "text-info", true);
                callbacks.push(function() {
                  focusSiteName();
                  setStatus("site", "", "", false);
                });
              } else if (role === "site-select") {
                setStatus("site", "Loading site...", "text-info", true);
                callbacks.push(function() {
                  setStatus("site", "", "", false);
                });
              }
              link.classList.add("disabled");
              loadDashboard(link.href, true, {
                after: function() {
                  callbacks.forEach(function(fn) { fn(); });
                }
              });
            });
            markBound(link, "siteBound");
          });
        }

        function bindCopyButton(root) {
          var copyButton = root.querySelector("#widget-copy-button");
          var widgetSnippet = root.querySelector("#widget-snippet");
          if (!copyButton || !widgetSnippet || isBound(copyButton, "copyBound")) {
            return;
          }
          copyButton.addEventListener("click", function() {
            if (copyButton.disabled) {
              return;
            }
            var text = widgetSnippet.value || "";
            var handleSuccess = function() {
              setStatus("widget", "", "", false);
              copyButton.classList.remove("btn-outline-primary");
              copyButton.classList.add("btn-outline-success");
              copyButton.textContent = "Copied";
              window.setTimeout(function() {
                copyButton.classList.remove("btn-outline-success");
                copyButton.classList.add("btn-outline-primary");
                copyButton.textContent = "Copy widget";
              }, 2000);
            };
            var handleError = function() {
              setStatus("widget", "Unable to copy widget.", "text-danger", true);
            };
            if (navigator.clipboard && navigator.clipboard.writeText) {
              navigator.clipboard.writeText(text).then(handleSuccess).catch(handleError);
              return;
            }
            widgetSnippet.focus();
            widgetSnippet.select();
            try {
              if (document.execCommand("copy")) {
                handleSuccess();
              } else {
                handleError();
              }
            } catch (copyError) {
              handleError();
            }
          });
          markBound(copyButton, "copyBound");
        }

        function bindAjaxForms(root) {
          root.querySelectorAll("form[data-ajax='true']").forEach(function(form) {
            if (isBound(form, "ajaxBound")) {
              return;
            }
            form.addEventListener("submit", function(event) {
              event.preventDefault();
              handleFormSubmit(form);
            });
            markBound(form, "ajaxBound");
          });
        }

        function handleFormSubmit(form) {
          var formData = new FormData(form);
          var submitButton = form.querySelector("[data-loading-label]");
          var loadingLabel = submitButton ? submitButton.dataset.loadingLabel || submitButton.textContent : "";
          var loadingStatus = submitButton ? submitButton.dataset.loadingStatus || "" : "";
          var defaultLabel = submitButton ? submitButton.dataset.defaultLabel || submitButton.textContent : "";
          if (submitButton) {
            submitButton.disabled = true;
            submitButton.textContent = loadingLabel;
          }
          if (form.dataset.role === "site-form" && loadingStatus) {
            setStatus("site", loadingStatus, "text-info", false);
          }
          if (form.dataset.role === "delete-site") {
            setStatus("site", "Deleting site...", "text-warning", false);
          }
          var requestURL = form.action;
          if (form.dataset.role === "delete-site") {
            hideDeleteModal();
          }
          fetch(form.action, {
            method: form.method || "POST",
            body: formData,
            headers: { "X-Requested-With": "XMLHttpRequest" },
            credentials: "same-origin"
          }).then(function(response) {
            requestURL = response.url || requestURL;
            return response.text().then(function(html) {
              replacePanelsFromHTML(html);
              if (response.ok) {
                window.history.pushState({}, "", requestURL);
              }
            });
          }).catch(function() {
            window.location.href = form.action;
          }).finally(function() {
            if (submitButton && document.body.contains(submitButton)) {
              submitButton.disabled = false;
              submitButton.textContent = defaultLabel;
            }
          });
        }

        function loadDashboard(url, pushHistory, options) {
          fetch(url, { headers: { "X-Requested-With": "XMLHttpRequest" } })
            .then(function(response) {
              if (!response.ok) {
                throw new Error("fetch_failed");
              }
              var nextURL = response.url || url;
              return response.text().then(function(html) {
                replacePanelsFromHTML(html);
                if (options && typeof options.after === "function") {
                  options.after();
                }
                if (pushHistory !== false) {
                  window.history.pushState({}, "", nextURL);
                }
              });
            })
            .catch(function() {
              window.location.href = url;
            });
        }

        function bindDeleteModal() {
          var modalElement = document.getElementById("deleteSiteModal");
          if (!modalElement || modalElement.dataset.bound === "1") {
            return;
          }
          var deleteForm = document.getElementById("delete-site-form");
          var deleteInput = document.getElementById("delete-site-confirm-input");
          var deleteButton = document.getElementById("delete-site-confirm-button");
          var deleteNameLabel = document.getElementById("delete-site-name-label");
          if (!deleteForm || !deleteInput || !deleteButton || !deleteNameLabel) {
            return;
          }
          var currentName = "";
          modalElement.addEventListener("show.bs.modal", function(event) {
            var trigger = event.relatedTarget;
            currentName = trigger ? (trigger.getAttribute("data-site-name") || "") : "";
            var deleteURL = trigger ? (trigger.getAttribute("data-delete-url") || "") : "";
            deleteForm.action = deleteURL || "#";
            deleteNameLabel.textContent = currentName;
            deleteInput.value = "";
            deleteButton.disabled = true;
          });
          modalElement.addEventListener("shown.bs.modal", function() {
            deleteInput.focus();
          });
          deleteInput.addEventListener("input", function() {
            deleteButton.disabled = deleteInput.value.trim() !== currentName || deleteForm.action === "#";
          });
          deleteForm.addEventListener("submit", function(event) {
            if (deleteForm.action === "#") {
              event.preventDefault();
            }
          });
          modalElement.dataset.bound = "1";
        }

        function hideDeleteModal() {
          var modalElement = document.getElementById("deleteSiteModal");
          if (!modalElement) {
            return;
          }
          var instance = bootstrap.Modal.getInstance(modalElement);
          if (!instance) {
            instance = new bootstrap.Modal(modalElement);
          }
          instance.hide();
        }

        function focusSiteName() {
          var input = document.getElementById("site-name");
          if (input) {
            input.focus();
          }
        }

        function rebind(root) {
          bindSiteLinks(root);
          bindCopyButton(root);
          bindAjaxForms(root);
          bindDeleteModal();
          scheduleStatusReset(root);
          applyTheme(currentTheme());
        }

        rebind(document);

        window.addEventListener("popstate", function() {
          loadDashboard(window.location.href, false);
        });
      })();
    </script>
  </body>
</html>
