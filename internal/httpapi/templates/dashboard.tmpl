<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{.PageTitle}}</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" {{.BootstrapIconsIntegrityAttr}} crossorigin="anonymous" />
    <link rel="icon" type="image/svg+xml" href="{{.FaviconDataURI}}" />
  </head>
  <body class="d-flex flex-column min-vh-100 bg-light">
    {{template "dashboard_header" .}}
    <main class="flex-grow-1 pt-5 mt-4">
      <div class="container py-4">
        
        <div class="row g-4">
          <div class="col-lg-4">
            <div class="card shadow-sm">
              <div class="card-header">Account</div>
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <img id="{{.UserAvatarID}}" src="" alt="Avatar" class="rounded-circle me-3 d-none" width="64" height="64" />
                  <div>
                    <div id="{{.UserNameID}}" class="fw-semibold"></div>
                    <div id="{{.UserEmailID}}" class="text-muted small"></div>
                    <span id="{{.UserRoleBadgeID}}" class="badge bg-secondary mt-2"></span>
                  </div>
                </div>
              </div>
            </div>
            <div class="card shadow-sm mt-4">
              <div class="card-header">
                <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                  <div class="d-flex align-items-center gap-2">
                    <span>Sites</span>
                    <button id="{{.SiteSearchToggleButtonID}}" type="button" class="{{.SearchToggleButtonClass}}" aria-label="{{.SiteSearchToggleLabel}}" aria-expanded="false">
                      <i class="bi bi-search"></i>
                    </button>
                  </div>
                  <div class="d-flex align-items-center gap-2">
                    <button id="{{.DeleteSiteButtonID}}" type="button" class="{{.DeleteSiteButtonDisabledClass}}" aria-label="{{.DeleteSiteButtonLabel}}" disabled>
                      <i class="{{.DeleteSiteIconClass}}" aria-hidden="true"></i>
                    </button>
                    <button id="{{.NewSiteButtonID}}" type="button" class="{{.NewSiteButtonClass}}">{{.NewSiteButtonLabel}}</button>
                  </div>
                  <div id="{{.SiteSearchContainerID}}" class="w-100 d-none">
                    <input id="{{.SiteSearchInputID}}" type="search" class="{{.SearchInputClass}}" placeholder="{{.SiteSearchPlaceholder}}" autocomplete="off" />
                  </div>
                </div>
              </div>
              <div class="card-body p-0">
                <div id="{{.SitesListID}}" class="list-group list-group-flush overflow-auto" style="max-height: 20rem;"></div>
                <p class="text-muted small m-3" id="{{.EmptySitesMessageID}}">{{.EmptySitesMessage}}</p>
              </div>
            </div>
          </div>
          <div class="col-lg-8">
            <div class="card shadow-sm mb-4">
              <div class="card-header">
                <div class="d-flex align-items-center justify-content-between">
                  <h5 class="mb-0">Site details</h5>
                  <div class="d-flex align-items-center gap-2">
                    <div id="{{.FormStatusID}}" class="{{.FormStatusBaseClass}}"></div>
                    <button id="{{.SaveSiteButtonID}}" type="button" class="{{.SaveButtonDefaultClass}}"></button>
                  </div>
                </div>
              </div>
              <div class="card-body">
                <form id="{{.SiteFormID}}">
                  <div class="row g-3 align-items-end">
                    <div class="col-md-6">
                    <div class="d-flex align-items-center justify-content-between">
                      <label class="form-label mb-0" for="{{.EditSiteNameInputID}}">Name</label>
                      <button id="{{.SiteNameHelpButtonID}}" type="button" class="{{.FieldHelpButtonClass}}" tabindex="{{.FieldHelpButtonTabIndex}}" data-bs-toggle="popover" data-bs-trigger="focus" data-bs-placement="bottom" title="{{.SiteNameHelpTitle}}" data-bs-content="{{.SiteNameHelpContent}}">
                        <span class="visually-hidden">{{.SiteNameHelpTitle}}</span>
                        <i class="{{.FieldHelpIconClass}}"></i>
                      </button>
                    </div>
                    <input id="{{.EditSiteNameInputID}}" type="text" class="form-control" autocomplete="off" />
                  </div>
                  <div class="col-md-6">
                    <div class="d-flex align-items-center justify-content-between">
                      <label class="form-label mb-0" for="{{.EditSiteOriginInputID}}">Allowed origin</label>
                      <button id="{{.AllowedOriginHelpButtonID}}" type="button" class="{{.FieldHelpButtonClass}}" tabindex="{{.FieldHelpButtonTabIndex}}" data-bs-toggle="popover" data-bs-trigger="focus" data-bs-placement="bottom" title="{{.AllowedOriginHelpTitle}}" data-bs-content="{{.AllowedOriginHelpContent}}">
                        <span class="visually-hidden">{{.AllowedOriginHelpTitle}}</span>
                        <i class="{{.FieldHelpIconClass}}"></i>
                      </button>
                    </div>
                    <input id="{{.EditSiteOriginInputID}}" type="text" class="form-control" autocomplete="off" />
                  </div>
                  <div class="col-md-6 d-none" id="{{.EditSiteOwnerContainerID}}">
                    <div class="d-flex align-items-center justify-content-between">
                      <label class="form-label mb-0" for="{{.EditSiteOwnerInputID}}">Owner email</label>
                      <button id="{{.OwnerEmailHelpButtonID}}" type="button" class="{{.FieldHelpButtonClass}}" tabindex="{{.FieldHelpButtonTabIndex}}" data-bs-toggle="popover" data-bs-trigger="focus" data-bs-placement="bottom" title="{{.OwnerEmailHelpTitle}}" data-bs-content="{{.OwnerEmailHelpContent}}">
                        <span class="visually-hidden">{{.OwnerEmailHelpTitle}}</span>
                        <i class="{{.FieldHelpIconClass}}"></i>
                      </button>
                    </div>
                    <input id="{{.EditSiteOwnerInputID}}" type="email" class="form-control" autocomplete="off" />
                  </div>
                  <div class="col-md-6 d-none" id="{{.SiteCreatedAtContainerID}}">
                    <div class="d-flex flex-column align-items-md-end gap-1 text-muted small">
                      <span class="fw-semibold">Registered at:</span>
                      <span id="{{.SiteCreatedAtElementID}}">{{.SiteCreatedAtPlaceholder}}</span>
                    </div>
                  </div>
                  </div>
                </form>
              </div>
            </div>
            <div class="card shadow-sm mb-4">
              <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                  <h5 class="mb-0">{{.WidgetCardTitle}}</h5>
                  <div class="d-flex align-items-center gap-2">
                    <div id="{{.WidgetStatusID}}" class="d-none py-1 px-2 small"></div>
                    <button id="{{.WidgetTestButtonID}}" type="button" class="{{.WidgetTestButtonClass}}">{{.WidgetTestButtonLabel}}</button>
                    <button id="{{.CopyWidgetSnippetButtonID}}" type="button" class="{{.CopyButtonDefaultClass}}">{{.CopyButtonDefaultLabel}}</button>
                  </div>
                </div>
              </div>
              <div class="card-body">
                <p class="text-muted small mb-3">{{.WidgetInstructions}}</p>
                <h6 class="fw-semibold mb-2">{{.WidgetPlacementTitle}}</h6>
                <div class="row g-3 align-items-end mb-3">
                  <div class="col-md-6">
                    <span class="form-label d-block">{{.WidgetPlacementSideLabel}}</span>
                    <div class="form-check form-check-inline">
                      <input class="form-check-input" type="radio" name="{{.WidgetPlacementSideInputName}}" id="{{.WidgetPlacementSideRightID}}" value="right" checked />
                      <label class="form-check-label" for="{{.WidgetPlacementSideRightID}}">{{.WidgetPlacementRightLabel}}</label>
                    </div>
                    <div class="form-check form-check-inline">
                      <input class="form-check-input" type="radio" name="{{.WidgetPlacementSideInputName}}" id="{{.WidgetPlacementSideLeftID}}" value="left" />
                      <label class="form-check-label" for="{{.WidgetPlacementSideLeftID}}">{{.WidgetPlacementLeftLabel}}</label>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label" for="{{.WidgetBottomOffsetInputID}}">{{.WidgetPlacementBottomOffsetLabel}}</label>
                    <input type="number" class="form-control" id="{{.WidgetBottomOffsetInputID}}" min="{{.WidgetBottomOffsetMin}}" max="{{.WidgetBottomOffsetMax}}" step="1" aria-describedby="{{.WidgetBottomOffsetHelpID}}" />
                    <div class="form-text" id="{{.WidgetBottomOffsetHelpID}}">{{.WidgetPlacementBottomOffsetHelp}}</div>
                  </div>
                </div>
                <textarea id="{{.WidgetSnippetTextareaID}}" class="form-control font-monospace" rows="3" readonly></textarea>
              </div>
            </div>
            <div class="card shadow-sm">
              <div class="card-header">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                  <div class="d-flex align-items-center gap-2">
                    <h5 class="mb-0">Feedback messages</h5>
                    <button id="{{.MessagesSearchToggleButtonID}}" type="button" class="{{.SearchToggleButtonClass}}" aria-label="{{.MessagesSearchToggleLabel}}" aria-expanded="false">
                      <i class="bi bi-search"></i>
                    </button>
                  </div>
                  <div class="d-flex align-items-center gap-2">
                    <div id="{{.MessagesStatusID}}" class="d-none py-1 px-2 small"></div>
                    <button id="{{.RefreshMessagesButtonID}}" class="{{.RefreshButtonDefaultClass}}">{{.RefreshButtonDefaultLabel}}</button>
                    <span id="{{.FeedbackCountElementID}}" class="badge bg-secondary d-none"></span>
                  </div>
                  <div id="{{.MessagesSearchContainerID}}" class="w-100 d-none">
                    <input id="{{.MessagesSearchInputID}}" type="search" class="{{.SearchInputClass}}" placeholder="{{.MessagesSearchPlaceholder}}" autocomplete="off" />
                  </div>
                </div>
              </div>
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table table-striped table-hover align-middle">
                    <thead id="{{.FeedbackTableHeaderID}}" class="{{.FeedbackTableHeaderLightClass}}">
                      <tr>
                        <th scope="col">When</th>
                        <th scope="col">Contact</th>
                        <th scope="col">Message</th>
                        <th scope="col">Delivery</th>
                      </tr>
                    </thead>
                    <tbody id="{{.FeedbackTableBodyID}}">
                      <tr><td colspan="4" class="text-center text-muted">{{.FeedbackPlaceholder}}</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
      </div>
    </div>
  </main>
    <div class="modal fade" id="{{.SettingsModalID}}" tabindex="-1" aria-labelledby="{{.SettingsModalTitleID}}" aria-describedby="{{.SettingsModalContentID}}" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="{{.SettingsModalTitleID}}">{{.SettingsModalTitle}}</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{.SettingsModalCloseLabel}}"></button>
          </div>
          <div class="modal-body">
            <p class="text-muted mb-4">{{.SettingsModalIntro}}</p>
            <div id="{{.SettingsModalContentID}}" class="d-flex flex-column gap-4">
              <section>
                <h2 class="h5 mb-2">{{.SettingsAutoLogoutSectionTitle}}</h2>
                <p class="text-muted small mb-3">{{.SettingsAutoLogoutDescription}}</p>
                <div class="form-check form-switch mb-3">
                  <input class="form-check-input" type="checkbox" role="switch" id="{{.SettingsAutoLogoutToggleID}}" />
                  <label class="form-check-label" for="{{.SettingsAutoLogoutToggleID}}">{{.SettingsAutoLogoutEnableLabel}}</label>
                </div>
                <div id="{{.SettingsAutoLogoutFieldsID}}" class="row g-3" data-gap-message="{{.SettingsAutoLogoutGapError}}">
                  <div class="col-md-6">
                    <label class="form-label" for="{{.SettingsAutoLogoutPromptInputID}}">{{.SettingsAutoLogoutPromptLabel}}</label>
                    <input class="form-control" type="number" id="{{.SettingsAutoLogoutPromptInputID}}" min="{{.SettingsAutoLogoutPromptMin}}" max="{{.SettingsAutoLogoutPromptMax}}" step="1" inputmode="numeric" />
                    <div class="invalid-feedback" id="{{.SettingsAutoLogoutPromptErrorID}}">{{.SettingsAutoLogoutPromptError}}</div>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label" for="{{.SettingsAutoLogoutLogoutInputID}}">{{.SettingsAutoLogoutLogoutLabel}}</label>
                    <input class="form-control" type="number" id="{{.SettingsAutoLogoutLogoutInputID}}" min="{{.SettingsAutoLogoutLogoutMin}}" max="{{.SettingsAutoLogoutLogoutMax}}" step="1" inputmode="numeric" />
                    <div class="invalid-feedback" id="{{.SettingsAutoLogoutLogoutErrorID}}">{{.SettingsAutoLogoutLogoutError}}</div>
                  </div>
                  <p class="text-muted small mb-0">{{.SettingsAutoLogoutHelpText}}</p>
                </div>
              </section>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{.SettingsModalCloseLabel}}</button>
          </div>
        </div>
      </div>
    </div>
    <div class="modal fade" id="{{.DeleteSiteModalID}}" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">{{.DeleteSiteModalTitle}}</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{.DeleteSiteModalCancelButtonLabel}}"></button>
          </div>
          <div class="modal-body">
            <p class="mb-3">{{.DeleteSiteModalDescription}}</p>
            <div class="mb-3">
              <label class="form-label" for="{{.DeleteSiteModalInputID}}">{{.DeleteSiteModalInputLabel}}</label>
              <input id="{{.DeleteSiteModalInputID}}" type="text" class="form-control" placeholder="{{.DeleteSiteModalInputPlaceholder}}" autocomplete="off" />
              <div class="form-text">{{.DeleteSiteModalHintPrefix}}<strong id="{{.DeleteSiteTargetNameID}}"></strong>{{.DeleteSiteModalHintSuffix}}</div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="{{.DeleteSiteModalCancelButtonClass}}" data-bs-dismiss="modal">{{.DeleteSiteModalCancelButtonLabel}}</button>
            <button id="{{.DeleteSiteModalConfirmButtonID}}" type="button" class="{{.DeleteSiteModalConfirmButtonClass}}" disabled>{{.DeleteSiteModalConfirmButtonLabel}}</button>
          </div>
        </div>
      </div>
    </div>
    <div id="{{.SessionTimeoutContainerID}}" class="{{.SessionTimeoutContainerClass}}" aria-live="polite" aria-hidden="true">
      <div class="{{.SessionTimeoutInnerClass}}">
        <p id="{{.SessionTimeoutMessageID}}" class="{{.SessionTimeoutMessageClass}}">{{.SessionTimeoutPromptText}}</p>
        <div class="{{.SessionTimeoutActionsClass}}">
          <button id="{{.SessionTimeoutConfirmButtonID}}" type="button" class="{{.SessionTimeoutConfirmButtonClass}}">{{.SessionTimeoutConfirmLabel}}</button>
          <button id="{{.SessionTimeoutDismissButtonID}}" type="button" class="{{.SessionTimeoutDismissButtonClass}}">{{.SessionTimeoutDismissLabel}}</button>
        </div>
      </div>
    </div>
    {{.FooterHTML}}
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script type="application/json" id="{{.ClientConfigElementID}}">{{.ClientConfigJSON}}</script>
    <script>
      (function() {
        var configElement = document.getElementById('{{.ClientConfigElementID}}');
        var parsedConfig = {};
        if (configElement) {
          try {
            parsedConfig = JSON.parse(configElement.textContent || '{}') || {};
          } catch (error) {
            parsedConfig = {};
          }
        }
        var apiPaths = parsedConfig.api_paths || {};
        var siteFaviconEventsEndpoint = apiPaths.site_favicon_events || '';
        var feedbackEventsEndpoint = apiPaths.feedback_events || '';
        var sharedPaths = parsedConfig.paths || {};
        var elementIds = parsedConfig.element_ids || {};
        var buttonClasses = parsedConfig.button_classes || {};
        var buttonLabels = parsedConfig.button_labels || {};
        var statusMessages = parsedConfig.status_messages || {};
        var errorMessages = parsedConfig.error_messages || {};
        var roleLabels = parsedConfig.role_labels || {};
        var roleValues = parsedConfig.role_values || {};
        var adminRoleValue = roleValues.admin || 'admin';
        var userRoleValue = roleValues.user || 'user';
        var buttonStyles = parsedConfig.button_styles || {};
        var componentClasses = parsedConfig.component_classes || {};
        var sessionTimeoutConfig = parsedConfig.session_timeout || {};
        var sessionTimeoutComponentClasses = sessionTimeoutConfig.component_classes || {};
        var sessionTimeoutThemeClasses = sessionTimeoutConfig.theme_classes || {};
        var sessionTimeoutTexts = sessionTimeoutConfig.texts || {};
        var sessionTimeoutPromptDelay = Number(sessionTimeoutConfig.prompt_delay_ms) || 60000;
        var sessionTimeoutAutoLogout = Number(sessionTimeoutConfig.auto_logout_ms) || 120000;
        var sessionTimeoutHiddenClassName = sessionTimeoutComponentClasses.container_hidden || 'd-none';
        var sessionTimeoutVisibleClassName = sessionTimeoutComponentClasses.container_visible || 'd-block';
        var autoLogoutConfig = parsedConfig.auto_logout || {};
        var autoLogoutStorageKey = autoLogoutConfig.storage_key || '';
        var autoLogoutPromptMinSeconds = Number(autoLogoutConfig.min_prompt_seconds);
        if (!Number.isFinite(autoLogoutPromptMinSeconds)) {
          autoLogoutPromptMinSeconds = {{.SettingsAutoLogoutPromptMin}};
        }
        var autoLogoutPromptMaxSeconds = Number(autoLogoutConfig.max_prompt_seconds);
        if (!Number.isFinite(autoLogoutPromptMaxSeconds)) {
          autoLogoutPromptMaxSeconds = {{.SettingsAutoLogoutPromptMax}};
        }
        var autoLogoutLogoutMinSeconds = Number(autoLogoutConfig.min_logout_seconds);
        if (!Number.isFinite(autoLogoutLogoutMinSeconds)) {
          autoLogoutLogoutMinSeconds = {{.SettingsAutoLogoutLogoutMin}};
        }
        var autoLogoutLogoutMaxSeconds = Number(autoLogoutConfig.max_logout_seconds);
        if (!Number.isFinite(autoLogoutLogoutMaxSeconds)) {
          autoLogoutLogoutMaxSeconds = {{.SettingsAutoLogoutLogoutMax}};
        }
        var autoLogoutMinimumGapSeconds = Number(autoLogoutConfig.minimum_gap_seconds);
        if (!Number.isFinite(autoLogoutMinimumGapSeconds)) {
          autoLogoutMinimumGapSeconds = {{.SettingsAutoLogoutGapSeconds}};
        }
        var idleState = {
          lastActivityTimestamp: Date.now(),
          promptVisible: false,
          idleCheckIntervalId: null
        };
        var idleCheckIntervalMilliseconds = Math.max(500, Math.min(Math.floor(sessionTimeoutPromptDelay / 2), 1000));
        var widgetTexts = parsedConfig.widget_texts || {};
        var optionValues = parsedConfig.option_values || {};
        var widgetPlacementConfig = parsedConfig.widget_placement || {};
        var widgetPlacementInputName = widgetPlacementConfig.input_name || 'widget-bubble-side';
        var widgetDefaultSide = widgetPlacementConfig.default_side || 'right';
        var widgetDefaultBottomOffset = Number(widgetPlacementConfig.default_bottom_offset);
        if (!Number.isFinite(widgetDefaultBottomOffset)) {
          widgetDefaultBottomOffset = 16;
        }
        var widgetPlacementSides = widgetPlacementConfig.sides || {};
        var widgetBottomOffsetConfig = widgetPlacementConfig.bottom_offset || {};
        var widgetBottomOffsetMinimum = Number(widgetBottomOffsetConfig.min);
        if (!Number.isFinite(widgetBottomOffsetMinimum)) {
          widgetBottomOffsetMinimum = 0;
        }
        var widgetBottomOffsetMaximum = Number(widgetBottomOffsetConfig.max);
        if (!Number.isFinite(widgetBottomOffsetMaximum)) {
          widgetBottomOffsetMaximum = 240;
        }
        var formStatusClasses = parsedConfig.form_status_classes || {};
        var validationMessages = parsedConfig.validation_messages || {};
        var themePreferenceStorageKey = parsedConfig.theme_storage_key || '';
        var themePreferencePublicStorageKey = '{{js .PublicThemeStorageKey}}';
        var themePreferenceLandingStorageKey = '{{js .LandingThemeStorageKey}}';
        var themePreferenceLegacyStorageKey = 'loopaware_theme';
        var faviconUpdatedEventName = 'favicon_updated';
        var faviconEventSource = null;
        var faviconReconnectDelayMilliseconds = 5000;
        var feedbackUpdatedEventName = 'feedback_created';
        var feedbackEventSource = null;
        var feedbackReconnectDelayMilliseconds = 5000;
        var settingsButton = document.getElementById(elementIds.settings_button);
        var settingsMenu = document.getElementById(elementIds.settings_menu);
        var settingsModalElement = document.getElementById(elementIds.settings_modal);
        var settingsAvatarImage = document.getElementById(elementIds.settings_avatar_image);
        var settingsAvatarFallback = document.getElementById(elementIds.settings_avatar_fallback);
        var siteNameHelpButton = document.getElementById(elementIds.site_name_help_button);
        var allowedOriginHelpButton = document.getElementById(elementIds.allowed_origin_help_button);
        var ownerEmailHelpButton = document.getElementById(elementIds.owner_email_help_button);
        var newSiteOptionValue = optionValues.new_site || '';
        var createButtonLabel = buttonLabels.create || '';
        var updateButtonLabel = buttonLabels.update || '';
        var createButtonClass = buttonClasses.create || '';
        var updateButtonClass = buttonClasses.update || '';
        var newSiteButton = document.getElementById(elementIds.new_site_button);
        var newSiteButtonDefaultClass = buttonClasses.new_site_default || '';
        var newSiteButtonActiveClass = buttonClasses.new_site_active || '';
        var sitesList = document.getElementById(elementIds.sites_list);
        var siteListItemClass = componentClasses.site_list_item || '';
        var siteListItemActiveClass = componentClasses.site_list_item_active || '';
        var siteListItemHeaderClass = componentClasses.site_list_item_header || '';
        var siteListItemFaviconClass = componentClasses.site_list_item_favicon || '';
        var siteSearchToggleButton = document.getElementById(elementIds.site_search_toggle_button);
        var siteSearchContainer = document.getElementById(elementIds.site_search_container);
        var siteSearchInput = document.getElementById(elementIds.site_search_input);
        var messagesSearchToggleButton = document.getElementById(elementIds.messages_search_toggle_button);
        var messagesSearchContainer = document.getElementById(elementIds.messages_search_container);
        var messagesSearchInput = document.getElementById(elementIds.messages_search_input);
        var siteCreatedAtElement = document.getElementById(elementIds.site_created_at);
        var siteCreatedAtContainer = document.getElementById(elementIds.site_created_at_container);
        var siteCreatedAtDefaultLabel = siteCreatedAtElement ? siteCreatedAtElement.textContent : '';
        var feedbackCountElement = document.getElementById(elementIds.feedback_count);
        var feedbackCountDefaultLabel = feedbackCountElement ? feedbackCountElement.textContent : '';
        var userName = document.getElementById(elementIds.user_name);
        var userEmail = document.getElementById(elementIds.user_email);
        var userAvatar = document.getElementById(elementIds.user_avatar);
        var userRole = document.getElementById(elementIds.user_role);
        var emptySitesMessage = document.getElementById(elementIds.empty_sites_message);
        var siteForm = document.getElementById(elementIds.site_form);
        var editSiteNameInput = document.getElementById(elementIds.edit_site_name);
        var editSiteOriginInput = document.getElementById(elementIds.edit_site_origin);
        var editSiteOwnerContainer = document.getElementById(elementIds.edit_site_owner_container);
        var editSiteOwnerInput = document.getElementById(elementIds.edit_site_owner);
        var saveSiteButton = document.getElementById(elementIds.save_site_button);
        var refreshMessagesButton = document.getElementById(elementIds.refresh_messages_button);
        var feedbackTableHeader = document.getElementById(elementIds.feedback_table_header);
        var feedbackTableBody = document.getElementById(elementIds.feedback_table_body);
        var logoutButton = document.getElementById(elementIds.logout_button);
        var sessionTimeoutContainer = document.getElementById(elementIds.session_timeout_container);
        var sessionTimeoutMessage = document.getElementById(elementIds.session_timeout_message);
        var sessionTimeoutConfirmButton = document.getElementById(elementIds.session_timeout_confirm_button);
        var sessionTimeoutDismissButton = document.getElementById(elementIds.session_timeout_dismiss_button);
        var autoLogoutFieldsContainer = document.getElementById(elementIds.settings_auto_logout_fields);
        var autoLogoutToggle = document.getElementById(elementIds.settings_auto_logout_toggle);
        var autoLogoutPromptInput = document.getElementById(elementIds.settings_auto_logout_prompt);
        var autoLogoutLogoutInput = document.getElementById(elementIds.settings_auto_logout_logout);
        var autoLogoutPromptError = document.getElementById(elementIds.settings_auto_logout_prompt_error);
        var autoLogoutLogoutError = document.getElementById(elementIds.settings_auto_logout_logout_error);
        var autoLogoutGapMessage = autoLogoutFieldsContainer ? autoLogoutFieldsContainer.getAttribute('data-gap-message') || '' : '';
        var widgetSnippetTextarea = document.getElementById(elementIds.widget_snippet_textarea);
        var copyWidgetSnippetButton = document.getElementById(elementIds.copy_widget_snippet_button);
        var widgetTestButton = document.getElementById(elementIds.widget_test_button);
        var widgetTestPagePrefix = typeof sharedPaths.widget_test_prefix === 'string' ? sharedPaths.widget_test_prefix : '';
        var widgetTestPageSuffix = typeof sharedPaths.widget_test_suffix === 'string' ? sharedPaths.widget_test_suffix : '';
        var widgetSideLeftOption = document.getElementById(elementIds.widget_side_left);
        var widgetSideRightOption = document.getElementById(elementIds.widget_side_right);
        var widgetBottomOffsetInput = document.getElementById(elementIds.widget_bottom_offset);
        if (widgetBottomOffsetInput) {
          widgetBottomOffsetInput.min = String(widgetBottomOffsetMinimum);
          widgetBottomOffsetInput.max = String(widgetBottomOffsetMaximum);
        }
        var deleteSiteButton = document.getElementById(elementIds.delete_site_button);
        var deleteSiteButtonDefaultClass = buttonClasses.delete_site_default || '';
        var deleteSiteButtonDisabledClass = buttonClasses.delete_site_disabled || '';
        var deleteSiteModalElement = document.getElementById(elementIds.delete_site_modal);
        var deleteSiteModal = deleteSiteModalElement && window.bootstrap && window.bootstrap.Modal ? new window.bootstrap.Modal(deleteSiteModalElement) : null;
        var deleteSiteConfirmButton = document.getElementById(elementIds.delete_site_confirm_button);
        var deleteSiteConfirmInput = document.getElementById(elementIds.delete_site_confirm_input);
        var deleteSiteTargetName = document.getElementById(elementIds.delete_site_target_name);
        var formStatus = document.getElementById(elementIds.form_status);
        var formStatusBaseClass = formStatusClasses.base || '';
        var formStatusSuccessClass = formStatusClasses.success || '';
        var formStatusDangerClass = formStatusClasses.danger || '';
        var formStatusDisplayDuration = 4000;
        var formStatusResetTimerId = null;
        var footerElement = document.getElementById(elementIds.footer);
        var footerThemeToggleInput = footerElement ? footerElement.querySelector('[data-mpr-footer="theme-toggle-input"]') : null;
        var footerThemeClasses = parsedConfig.footer_theme_classes || {};
        var tableThemeClasses = parsedConfig.table_theme_classes || {};
        var landingPath = sharedPaths.landing || '/';
        var logoutPath = sharedPaths.logout || '';
        var loginPath = sharedPaths.login || '';
        var widgetUnavailableMessage = widgetTexts.unavailable || '';
        var apiMeEndpoint = apiPaths.me || '';
        var apiSitesEndpoint = apiPaths.sites || '';
        var apiSiteUpdatePrefix = apiPaths.site_update_prefix || '';
        var apiSiteMessagesPrefix = apiPaths.site_messages_prefix || '';
        var apiSiteMessagesSuffix = apiPaths.site_messages_suffix || '';

        var state = {
          user: null,
          sites: [],
          selectedSiteId: '',
          pendingDeletionSiteId: '',
          siteMessages: {}
        };
        var sessionTimeoutManager = null;
        var siteSearchQuery = '';
        var messagesSearchQuery = '';
        var validationMessageKeyNameRequired = 'name_required';
        var validationMessageKeyOriginInvalid = 'origin_invalid';
        var validationMessageKeyOwnerInvalid = 'owner_invalid';
        var validationMessageKeyWidgetOffsetInvalid = 'widget_offset_invalid';
        var invalidFieldClassName = 'is-invalid';
        var currentThemeMode = document.documentElement.getAttribute('data-bs-theme') || 'light';
        var sessionTimeoutStartRequested = false;
        var autoLogoutSettingsState = null;
        var validationEmailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        var mailtoSchemePrefix = 'mailto:';
        var contactLinkClassName = 'text-decoration-none';
        var emptyString = '';
        var statusNoSiteMatches = statusMessages.no_site_matches || '';
        var statusNoMessageMatches = statusMessages.no_message_matches || '';
        function shouldAlwaysValidate() {
          return true;
        }

        function normalizeWidgetSideValue(value) {
          var normalized = (value || '').toLowerCase();
          if (normalized !== 'left' && normalized !== 'right') {
            normalized = widgetDefaultSide;
          }
          return normalized;
        }

        function normalizeWidgetBottomOffsetValue(value) {
          var numericValue = Number(value);
          if (!Number.isFinite(numericValue)) {
            numericValue = widgetDefaultBottomOffset;
          }
          numericValue = Math.round(numericValue);
          if (numericValue < widgetBottomOffsetMinimum) {
            numericValue = widgetBottomOffsetMinimum;
          }
          if (numericValue > widgetBottomOffsetMaximum) {
            numericValue = widgetBottomOffsetMaximum;
          }
          return numericValue;
        }

        function resolveWidgetSideSelection() {
          var selected = document.querySelector('input[name="' + widgetPlacementInputName + '"]:checked');
          if (selected && typeof selected.value === 'string') {
            return normalizeWidgetSideValue(selected.value);
          }
          return normalizeWidgetSideValue(widgetDefaultSide);
        }

        function setWidgetPlacementControls(sideValue, bottomOffsetValue) {
          var normalizedSide = normalizeWidgetSideValue(sideValue);
          var normalizedOffset = normalizeWidgetBottomOffsetValue(bottomOffsetValue);
          if (widgetSideLeftOption && widgetSideRightOption) {
            widgetSideLeftOption.checked = normalizedSide === 'left';
            widgetSideRightOption.checked = normalizedSide !== 'left';
          }
          if (widgetBottomOffsetInput) {
            widgetBottomOffsetInput.value = normalizedOffset.toString();
          }
        }

        function determineWidgetPlacementPayload() {
          var sideValue = resolveWidgetSideSelection();
          var offsetValue = widgetBottomOffsetInput ? normalizeWidgetBottomOffsetValue(widgetBottomOffsetInput.value) : widgetDefaultBottomOffset;
          return {
            widget_bubble_side: sideValue,
            widget_bubble_bottom_offset: offsetValue
          };
        }

        function isWidgetBottomOffsetValid(value) {
          if (value === '') {
            return false;
          }
          var numericValue = Number(value);
          if (!Number.isFinite(numericValue)) {
            return false;
          }
          if (Math.round(numericValue) !== numericValue) {
            return false;
          }
          if (numericValue < widgetBottomOffsetMinimum || numericValue > widgetBottomOffsetMaximum) {
            return false;
          }
          return true;
        }

        function createSessionTimeoutManager(configuration) {
          if (!configuration) {
            return null;
          }
          var containerElement = configuration.containerElement;
          var messageElement = configuration.messageElement;
          var confirmButtonElement = configuration.confirmButtonElement;
          var dismissButtonElement = configuration.dismissButtonElement;
          var footerElement = configuration.footerElement;
          if (!containerElement || !confirmButtonElement || !dismissButtonElement) {
            return null;
          }
          var hiddenClassName = configuration.hiddenClass || '';
          var visibleClassName = configuration.visibleClass || '';
          var themeClasses = configuration.themeClasses || {};
          var promptDelayMilliseconds = typeof configuration.promptDelayMilliseconds === 'number' ? configuration.promptDelayMilliseconds : 60000;
          if (promptDelayMilliseconds < 0) {
            promptDelayMilliseconds = 0;
          }
          var autoLogoutMilliseconds = typeof configuration.autoLogoutMilliseconds === 'number' ? configuration.autoLogoutMilliseconds : promptDelayMilliseconds;
          if (autoLogoutMilliseconds < 0) {
            autoLogoutMilliseconds = 0;
          }
          var promptTextContent = typeof configuration.promptText === 'string' ? configuration.promptText : '';
          var confirmButtonLabel = typeof configuration.confirmButtonLabel === 'string' ? configuration.confirmButtonLabel : '';
          var dismissButtonLabel = typeof configuration.dismissButtonLabel === 'string' ? configuration.dismissButtonLabel : '';
          var logoutHandler = typeof configuration.onLogout === 'function' ? configuration.onLogout : function() {};
          if (messageElement && promptTextContent !== '') {
            messageElement.textContent = promptTextContent;
          }
          if (confirmButtonElement && confirmButtonLabel !== '') {
            confirmButtonElement.textContent = confirmButtonLabel;
          }
          if (dismissButtonElement && dismissButtonLabel !== '') {
            dismissButtonElement.textContent = dismissButtonLabel;
          }
          var listenersBound = false;
          var activityEvents = ['mousemove', 'mousedown', 'keydown', 'touchstart', 'scroll'];
          var activityHandler = function(event) {
            if (event && typeof event.isTrusted === 'boolean' && event.isTrusted === false) {
              return;
            }
            recordSessionActivity();
          };
          var visibilityHandler = function() {
            if (document.visibilityState === 'visible') {
              recordSessionActivity();
              return;
            }
            recordSessionActivity();
          };
          var confirmHandler = function(event) {
            event.preventDefault();
            logoutHandler();
          };
          var dismissHandler = function(event) {
            event.preventDefault();
            recordSessionActivity();
          };

          function recordSessionActivity() {
            idleState.lastActivityTimestamp = Date.now();
            if (idleState.promptVisible) {
              hidePrompt();
            }
          }

          function checkSessionIdleState() {
            var now = Date.now();
            var elapsed = now - idleState.lastActivityTimestamp;
            if (idleState.promptVisible) {
              if (elapsed >= autoLogoutMilliseconds) {
                logoutHandler();
              }
              return;
            }
            if (elapsed >= promptDelayMilliseconds) {
              showPrompt();
            }
          }

          function startIdleChecks() {
            if (idleState.idleCheckIntervalId !== null) {
              return;
            }
            idleState.idleCheckIntervalId = window.setInterval(checkSessionIdleState, idleCheckIntervalMilliseconds);
          }

          function stopIdleChecks() {
            if (idleState.idleCheckIntervalId === null) {
              return;
            }
            window.clearInterval(idleState.idleCheckIntervalId);
            idleState.idleCheckIntervalId = null;
          }

          function setHiddenState(isHidden) {
            containerElement.setAttribute('aria-hidden', isHidden ? 'true' : 'false');
          }

          function resetFooterOffset() {
            containerElement.style.bottom = '0px';
          }

          function applyFooterOffset() {
            var footerHeight = 0;
            if (footerElement) {
              footerHeight = footerElement.getBoundingClientRect().height;
            }
            if (footerHeight > 0) {
              containerElement.style.bottom = footerHeight + 'px';
            } else {
              resetFooterOffset();
            }
          }

          function hidePrompt() {
            normalizeClassList(visibleClassName).forEach(function(className) {
              containerElement.classList.remove(className);
            });
            normalizeClassList(hiddenClassName).forEach(function(className) {
              if (!containerElement.classList.contains(className)) {
                containerElement.classList.add(className);
              }
            });
            setHiddenState(true);
            resetFooterOffset();
            idleState.promptVisible = false;
          }

          function showPrompt() {
            normalizeClassList(hiddenClassName).forEach(function(className) {
              containerElement.classList.remove(className);
            });
            normalizeClassList(visibleClassName).forEach(function(className) {
              if (!containerElement.classList.contains(className)) {
                containerElement.classList.add(className);
              }
            });
            setHiddenState(false);
            idleState.promptVisible = true;
            applyFooterOffset();
            window.requestAnimationFrame(applyFooterOffset);
          }

          function bindListeners() {
            if (listenersBound) {
              return;
            }
            activityEvents.forEach(function(eventName) {
              document.addEventListener(eventName, activityHandler, true);
            });
            document.addEventListener('visibilitychange', visibilityHandler, true);
            confirmButtonElement.addEventListener('click', confirmHandler);
            dismissButtonElement.addEventListener('click', dismissHandler);
            listenersBound = true;
          }

          function unbindListeners() {
            if (!listenersBound) {
              return;
            }
            activityEvents.forEach(function(eventName) {
              document.removeEventListener(eventName, activityHandler, true);
            });
            document.removeEventListener('visibilitychange', visibilityHandler, true);
            confirmButtonElement.removeEventListener('click', confirmHandler);
            dismissButtonElement.removeEventListener('click', dismissHandler);
            listenersBound = false;
          }

          function applyTheme(mode) {
            var normalized = mode === 'dark' ? 'dark' : 'light';
            var lightClasses = themeClasses.light || '';
            var darkClasses = themeClasses.dark || '';
            if (normalized === 'dark') {
              applyElementThemeClasses(containerElement, darkClasses, lightClasses);
            } else {
              applyElementThemeClasses(containerElement, lightClasses, darkClasses);
            }
          }

          function startManager() {
            recordSessionActivity();
            bindListeners();
            startIdleChecks();
          }

          function stopManager() {
            unbindListeners();
            stopIdleChecks();
            hidePrompt();
            resetFooterOffset();
          }

          if (typeof window === 'object' && window) {
            window.__loopawareDashboardIdleTestHooks = {
              forcePrompt: function() {
                idleState.lastActivityTimestamp = Date.now() - (promptDelayMilliseconds + 1000);
                checkSessionIdleState();
              },
              forceLogout: function() {
                idleState.lastActivityTimestamp = Date.now() - (autoLogoutMilliseconds + 1000);
                showPrompt();
                checkSessionIdleState();
              }
            };
          }

          resetFooterOffset();

          return {
            start: function() {
              if (!containerElement) {
                return;
              }
              startManager();
            },
            stop: stopManager,
            applyTheme: applyTheme
          };
        }
        function resetSessionTimeoutTestHooks() {
          if (typeof window !== 'object' || !window) {
            return;
          }
          window.__loopawareDashboardIdleTestHooks = {
            forcePrompt: function() {},
            forceLogout: function() {}
          };
        }

        function hideSessionTimeoutContainer() {
          if (!sessionTimeoutContainer) {
            return;
          }
          normalizeClassList(sessionTimeoutVisibleClassName).forEach(function(className) {
            sessionTimeoutContainer.classList.remove(className);
          });
          normalizeClassList(sessionTimeoutHiddenClassName).forEach(function(className) {
            if (!sessionTimeoutContainer.classList.contains(className)) {
              sessionTimeoutContainer.classList.add(className);
            }
          });
          sessionTimeoutContainer.setAttribute('aria-hidden', 'true');
        }

        function clampAutoLogoutSeconds(value, minimum, maximum) {
          if (!Number.isFinite(value)) {
            return minimum;
          }
          var rounded = Math.round(value);
          if (rounded < minimum) {
            return minimum;
          }
          if (rounded > maximum) {
            return maximum;
          }
          return rounded;
        }

        function loadStoredAutoLogoutSettings() {
          if (!autoLogoutStorageKey || typeof window !== 'object' || !window || !window.localStorage) {
            return null;
          }
          try {
            var rawValue = window.localStorage.getItem(autoLogoutStorageKey);
            if (!rawValue) {
              return null;
            }
            var parsedValue = JSON.parse(rawValue);
            if (!parsedValue || typeof parsedValue !== 'object') {
              return null;
            }
            var stored = {};
            if (typeof parsedValue.enabled === 'boolean') {
              stored.enabled = parsedValue.enabled;
            }
            if (typeof parsedValue.prompt_seconds === 'number') {
              stored.promptSeconds = parsedValue.prompt_seconds;
            }
            if (typeof parsedValue.logout_seconds === 'number') {
              stored.logoutSeconds = parsedValue.logout_seconds;
            }
            return stored;
          } catch (error) {
            return null;
          }
        }

        function persistAutoLogoutSettings(settings) {
          if (!autoLogoutStorageKey || typeof window !== 'object' || !window || !window.localStorage) {
            return;
          }
          try {
            window.localStorage.setItem(autoLogoutStorageKey, JSON.stringify({
              enabled: !!settings.enabled,
              prompt_seconds: settings.promptSeconds,
              logout_seconds: settings.logoutSeconds
            }));
          } catch (error) {
            // Ignore storage errors.
          }
        }

        function normalizeAutoLogoutSettings(rawSettings) {
          var normalized = {
            enabled: true,
            promptSeconds: clampAutoLogoutSeconds(autoLogoutDefaultPromptSeconds, autoLogoutPromptMinSeconds, autoLogoutPromptMaxSeconds),
            logoutSeconds: clampAutoLogoutSeconds(autoLogoutDefaultLogoutSeconds, autoLogoutLogoutMinSeconds, autoLogoutLogoutMaxSeconds)
          };
          if (rawSettings && typeof rawSettings.enabled === 'boolean') {
            normalized.enabled = rawSettings.enabled;
          }
          if (rawSettings && Number.isFinite(rawSettings.promptSeconds)) {
            normalized.promptSeconds = clampAutoLogoutSeconds(rawSettings.promptSeconds, autoLogoutPromptMinSeconds, autoLogoutPromptMaxSeconds);
          }
          if (rawSettings && Number.isFinite(rawSettings.logoutSeconds)) {
            normalized.logoutSeconds = clampAutoLogoutSeconds(rawSettings.logoutSeconds, autoLogoutLogoutMinSeconds, autoLogoutLogoutMaxSeconds);
          }
          if (normalized.logoutSeconds <= normalized.promptSeconds + autoLogoutMinimumGapSeconds) {
            normalized.logoutSeconds = clampAutoLogoutSeconds(normalized.promptSeconds + autoLogoutMinimumGapSeconds, autoLogoutLogoutMinSeconds, autoLogoutLogoutMaxSeconds);
          }
          return normalized;
        }

        function setAutoLogoutInputsDisabled(isDisabled) {
          if (autoLogoutPromptInput) {
            autoLogoutPromptInput.disabled = isDisabled;
          }
          if (autoLogoutLogoutInput) {
            autoLogoutLogoutInput.disabled = isDisabled;
          }
          if (autoLogoutFieldsContainer) {
            autoLogoutFieldsContainer.setAttribute('aria-disabled', isDisabled ? 'true' : 'false');
          }
        }

        function updateAutoLogoutInputs(settings) {
          if (autoLogoutToggle) {
            autoLogoutToggle.checked = !!settings.enabled;
          }
          if (autoLogoutPromptInput) {
            autoLogoutPromptInput.value = String(settings.promptSeconds);
          }
          if (autoLogoutLogoutInput) {
            autoLogoutLogoutInput.value = String(settings.logoutSeconds);
          }
          setAutoLogoutInputsDisabled(!settings.enabled);
        }

        function clearAutoLogoutValidation() {
          if (autoLogoutPromptInput) {
            autoLogoutPromptInput.classList.remove(invalidFieldClassName);
          }
          if (autoLogoutLogoutInput) {
            autoLogoutLogoutInput.classList.remove(invalidFieldClassName);
          }
        }

        function applyAutoLogoutValidation(validation) {
          if (!validation) {
            return;
          }
          if (autoLogoutPromptInput) {
            if (validation.promptError) {
              autoLogoutPromptInput.classList.add(invalidFieldClassName);
              if (autoLogoutPromptError) {
                autoLogoutPromptError.textContent = validation.promptError;
              }
            } else {
              autoLogoutPromptInput.classList.remove(invalidFieldClassName);
            }
          }
          if (autoLogoutLogoutInput) {
            if (validation.logoutError) {
              autoLogoutLogoutInput.classList.add(invalidFieldClassName);
              if (autoLogoutLogoutError) {
                autoLogoutLogoutError.textContent = validation.logoutError;
              }
            } else {
              autoLogoutLogoutInput.classList.remove(invalidFieldClassName);
            }
          }
        }

        function validateAutoLogoutSettings(settings) {
          var result = {
            isValid: true,
            promptError: '',
            logoutError: ''
          };
          if (!settings.enabled) {
            return result;
          }
          if (!Number.isFinite(settings.promptSeconds) || Math.round(settings.promptSeconds) !== settings.promptSeconds || settings.promptSeconds < autoLogoutPromptMinSeconds || settings.promptSeconds > autoLogoutPromptMaxSeconds) {
            result.isValid = false;
            result.promptError = '{{.SettingsAutoLogoutPromptError}}';
          }
          if (!Number.isFinite(settings.logoutSeconds) || Math.round(settings.logoutSeconds) !== settings.logoutSeconds || settings.logoutSeconds < autoLogoutLogoutMinSeconds || settings.logoutSeconds > autoLogoutLogoutMaxSeconds) {
            result.isValid = false;
            result.logoutError = '{{.SettingsAutoLogoutLogoutError}}';
          } else if (result.isValid && settings.logoutSeconds <= settings.promptSeconds + autoLogoutMinimumGapSeconds) {
            result.isValid = false;
            result.logoutError = autoLogoutGapMessage || '{{.SettingsAutoLogoutGapError}}';
          }
          return result;
        }

        function readAutoLogoutInputs() {
          var promptValue = Number(autoLogoutPromptInput ? autoLogoutPromptInput.value : autoLogoutDefaultPromptSeconds);
          var logoutValue = Number(autoLogoutLogoutInput ? autoLogoutLogoutInput.value : autoLogoutDefaultLogoutSeconds);
          return {
            enabled: autoLogoutToggle ? autoLogoutToggle.checked : true,
            promptSeconds: Number.isFinite(promptValue) ? Math.round(promptValue) : NaN,
            logoutSeconds: Number.isFinite(logoutValue) ? Math.round(logoutValue) : NaN
          };
        }

        function configureSessionTimeoutFromSettings(settings) {
          if (sessionTimeoutManager && typeof sessionTimeoutManager.stop === 'function') {
            sessionTimeoutManager.stop();
          }
          sessionTimeoutManager = null;
          if (!settings.enabled) {
            resetSessionTimeoutTestHooks();
            hideSessionTimeoutContainer();
            return;
          }
          var promptMilliseconds = settings.promptSeconds * 1000;
          var logoutMilliseconds = settings.logoutSeconds * 1000;
          sessionTimeoutManager = createSessionTimeoutManager({
            containerElement: sessionTimeoutContainer,
            messageElement: sessionTimeoutMessage,
            confirmButtonElement: sessionTimeoutConfirmButton,
            dismissButtonElement: sessionTimeoutDismissButton,
            footerElement: footerElement,
            hiddenClass: sessionTimeoutHiddenClassName,
            visibleClass: sessionTimeoutVisibleClassName,
            themeClasses: sessionTimeoutThemeClasses || {},
            promptDelayMilliseconds: promptMilliseconds,
            autoLogoutMilliseconds: logoutMilliseconds,
            promptText: sessionTimeoutTexts.prompt || '',
            confirmButtonLabel: sessionTimeoutTexts.confirm || '',
            dismissButtonLabel: sessionTimeoutTexts.dismiss || '',
            onLogout: performLogout
          });
          if (sessionTimeoutManager && typeof sessionTimeoutManager.applyTheme === 'function') {
            sessionTimeoutManager.applyTheme(currentThemeMode);
          }
          if (sessionTimeoutManager && sessionTimeoutStartRequested && typeof sessionTimeoutManager.start === 'function') {
            sessionTimeoutManager.start();
          }
        }

        function handleAutoLogoutSettingsChange() {
          if (!autoLogoutToggle) {
            return;
          }
          var inputs = readAutoLogoutInputs();
          var validation = validateAutoLogoutSettings(inputs);
          applyAutoLogoutValidation(validation);
          if (!inputs.enabled) {
            clearAutoLogoutValidation();
          }
          if (!validation.isValid) {
            return;
          }
          autoLogoutSettingsState = normalizeAutoLogoutSettings(inputs);
          updateAutoLogoutInputs(autoLogoutSettingsState);
          persistAutoLogoutSettings(autoLogoutSettingsState);
          configureSessionTimeoutFromSettings(autoLogoutSettingsState);
          exposeAutoLogoutTestHooks();
        }

        function exposeAutoLogoutTestHooks() {
          if (typeof window !== 'object' || !window) {
            return;
          }
          window.__loopawareDashboardSettingsTestHooks = {
            readAutoLogoutSettings: function() {
              if (!autoLogoutSettingsState) {
                return { enabled: false, promptSeconds: 0, logoutSeconds: 0 };
              }
              return {
                enabled: autoLogoutSettingsState.enabled,
                promptSeconds: autoLogoutSettingsState.promptSeconds,
                logoutSeconds: autoLogoutSettingsState.logoutSeconds
              };
            },
            minPromptSeconds: autoLogoutPromptMinSeconds,
            maxPromptSeconds: autoLogoutPromptMaxSeconds,
            minLogoutSeconds: autoLogoutLogoutMinSeconds,
            maxLogoutSeconds: autoLogoutLogoutMaxSeconds,
            minimumGapSeconds: autoLogoutMinimumGapSeconds
          };
        }

        var autoLogoutDefaultPromptSeconds = clampAutoLogoutSeconds(Math.round(sessionTimeoutPromptDelay / 1000) || {{.SettingsAutoLogoutPromptMin}}, autoLogoutPromptMinSeconds, autoLogoutPromptMaxSeconds);
        var autoLogoutDefaultLogoutSeconds = clampAutoLogoutSeconds(Math.round(sessionTimeoutAutoLogout / 1000) || {{.SettingsAutoLogoutLogoutMin}}, autoLogoutLogoutMinSeconds, autoLogoutLogoutMaxSeconds);
        if (autoLogoutDefaultLogoutSeconds <= autoLogoutDefaultPromptSeconds + autoLogoutMinimumGapSeconds) {
          autoLogoutDefaultLogoutSeconds = clampAutoLogoutSeconds(autoLogoutDefaultPromptSeconds + autoLogoutMinimumGapSeconds, autoLogoutLogoutMinSeconds, autoLogoutLogoutMaxSeconds);
        }
        resetSessionTimeoutTestHooks();
        var storedAutoLogoutSettings = loadStoredAutoLogoutSettings();
        autoLogoutSettingsState = normalizeAutoLogoutSettings({
          enabled: storedAutoLogoutSettings && typeof storedAutoLogoutSettings.enabled === 'boolean' ? storedAutoLogoutSettings.enabled : true,
          promptSeconds: storedAutoLogoutSettings && Number.isFinite(storedAutoLogoutSettings.promptSeconds) ? storedAutoLogoutSettings.promptSeconds : autoLogoutDefaultPromptSeconds,
          logoutSeconds: storedAutoLogoutSettings && Number.isFinite(storedAutoLogoutSettings.logoutSeconds) ? storedAutoLogoutSettings.logoutSeconds : autoLogoutDefaultLogoutSeconds
        });
        updateAutoLogoutInputs(autoLogoutSettingsState);
        persistAutoLogoutSettings(autoLogoutSettingsState);
        configureSessionTimeoutFromSettings(autoLogoutSettingsState);
        exposeAutoLogoutTestHooks();
        function shouldValidateOwnerEmail() {
          return Boolean(state.user);
        }
        function getTrimmedValue(element) {
          if (!element || typeof element.value !== 'string') {
            return '';
          }
          return element.value.trim();
        }
        function isSiteNameValid(value) {
          return value.length > 0;
        }
        function isAllowedOriginValid(value) {
          if (!value) {
            return false;
          }
          try {
            var parsed = new URL(value);
            if (parsed.protocol !== 'http:' && parsed.protocol !== 'https:') {
              return false;
            }
            if (!parsed.hostname) {
              return false;
            }
            if (parsed.username || parsed.password) {
              return false;
            }
            if ((parsed.pathname && parsed.pathname !== '/') || parsed.search || parsed.hash) {
              return false;
            }
            return true;
          } catch (error) {
            return false;
          }
        }
        function isOwnerEmailValid(value) {
          if (typeof value !== 'string') {
            return false;
          }
          var normalizedOwnerEmail = value.trim();
          if (normalizedOwnerEmail === '') {
            return false;
          }
          return validationEmailPattern.test(normalizedOwnerEmail);
        }
        var siteFormValidationDescriptors = [
          {
            fieldElement: editSiteNameInput,
            messageKey: validationMessageKeyNameRequired,
            shouldValidate: shouldAlwaysValidate,
            validateValue: isSiteNameValid
          },
          {
            fieldElement: editSiteOriginInput,
            messageKey: validationMessageKeyOriginInvalid,
            shouldValidate: shouldAlwaysValidate,
            validateValue: isAllowedOriginValid
          },
          {
            fieldElement: editSiteOwnerInput,
            messageKey: validationMessageKeyOwnerInvalid,
            shouldValidate: shouldValidateOwnerEmail,
            validateValue: isOwnerEmailValid
          },
          {
            fieldElement: widgetBottomOffsetInput,
            messageKey: validationMessageKeyWidgetOffsetInvalid,
            shouldValidate: shouldAlwaysValidate,
            validateValue: isWidgetBottomOffsetValid
          }
        ];
        function clearValidationFeedback() {
          siteFormValidationDescriptors.forEach(function(descriptor) {
            if (descriptor.fieldElement) {
              descriptor.fieldElement.classList.remove(invalidFieldClassName);
            }
          });
          clearFormStatus();
        }
        function markFieldInvalid(fieldElement, messageKey) {
          if (!fieldElement) {
            return;
          }
          fieldElement.classList.add(invalidFieldClassName);
          fieldElement.focus();
          var message = validationMessages[messageKey] || '';
          setFormStatus(message, formStatusDangerClass);
        }
        function validateSiteForm() {
          clearValidationFeedback();
          for (var index = 0; index < siteFormValidationDescriptors.length; index += 1) {
            var descriptor = siteFormValidationDescriptors[index];
            if (!descriptor.fieldElement) {
              continue;
            }
            if (typeof descriptor.shouldValidate === 'function' && !descriptor.shouldValidate()) {
              continue;
            }
            var value = getTrimmedValue(descriptor.fieldElement);
            if (typeof descriptor.validateValue === 'function' && !descriptor.validateValue(value)) {
              markFieldInvalid(descriptor.fieldElement, descriptor.messageKey);
              return false;
            }
          }
          return true;
        }
        function registerValidationHandlers() {
          siteFormValidationDescriptors.forEach(function(descriptor) {
            if (!descriptor.fieldElement) {
              return;
            }
            descriptor.fieldElement.addEventListener('input', function() {
              descriptor.fieldElement.classList.remove(invalidFieldClassName);
              clearFormStatus();
            });
          });
        }
        function registerSiteFormTabCycle() {
          var tabOrderedFields = [editSiteNameInput, editSiteOriginInput, editSiteOwnerInput, widgetBottomOffsetInput].filter(function(element) {
            return element;
          });
          if (tabOrderedFields.length === 0) {
            return;
          }
          tabOrderedFields.forEach(function(field, index) {
            field.addEventListener('keydown', function(event) {
              if (event.key !== 'Tab') {
                return;
              }
              event.preventDefault();
              var direction = event.shiftKey ? -1 : 1;
              var nextIndex = (index + direction + tabOrderedFields.length) % tabOrderedFields.length;
              tabOrderedFields[nextIndex].focus();
            });
          });
        }
        function renderContactValue(cell, value) {
          if (!cell) {
            return;
          }
          var normalized = (value || emptyString).trim();
          if (normalized.length === 0) {
            cell.textContent = emptyString;
            return;
          }
          if (validationEmailPattern.test(normalized)) {
            var link = document.createElement('a');
            link.href = mailtoSchemePrefix + normalized;
            link.textContent = normalized;
            link.className = contactLinkClassName;
            cell.textContent = emptyString;
            cell.appendChild(link);
            return;
          }
          cell.textContent = normalized;
        }
        function setSiteCreatedAt(unixSeconds) {
          if (!siteCreatedAtElement) {
            return;
          }
          var hasTimestamp = typeof unixSeconds === 'number' && unixSeconds > 0;
          if (!hasTimestamp) {
            siteCreatedAtElement.textContent = siteCreatedAtDefaultLabel;
          } else {
            siteCreatedAtElement.textContent = formatTimestamp(unixSeconds);
          }
          if (!siteCreatedAtContainer) {
            return;
          }
          if (!hasTimestamp || !state.user || state.user.role !== adminRoleValue) {
            siteCreatedAtContainer.classList.add('d-none');
            return;
          }
          siteCreatedAtContainer.classList.remove('d-none');
        }
        function setFeedbackCount(total, visible) {
          if (!feedbackCountElement) {
            return;
          }
          var normalizedTotal = typeof total === 'number' && total >= 0 ? total : 0;
          var normalizedVisible = typeof visible === 'number' && visible >= 0 ? visible : normalizedTotal;
          if (normalizedTotal === 0) {
            feedbackCountElement.textContent = feedbackCountDefaultLabel;
            feedbackCountElement.classList.add('d-none');
            return;
          }
          feedbackCountElement.classList.remove('d-none');
          if (normalizedVisible !== normalizedTotal) {
            feedbackCountElement.textContent = normalizedVisible + ' / ' + normalizedTotal;
          } else {
            feedbackCountElement.textContent = normalizedTotal.toString();
          }
        }
        function updateSelectedSiteSummary(site) {
          if (!site) {
            setSiteCreatedAt(null);
            setFeedbackCount(0, 0);
            return;
          }
          setSiteCreatedAt(site.created_at);
          var totalCount = typeof site.feedback_count === 'number' ? site.feedback_count : 0;
          setFeedbackCount(totalCount, messagesSearchQuery ? Math.min(totalCount, totalCount) : totalCount);
        }
        function normalizeSearchQuery(value) {
          if (typeof value !== 'string') {
            return '';
          }
          return value.trim().toLowerCase();
        }
        function applySiteSearchQuery(value) {
          var normalized = normalizeSearchQuery(value);
          if (siteSearchQuery === normalized) {
            return;
          }
          siteSearchQuery = normalized;
          renderSites();
        }
        function applyMessagesSearchQuery(value) {
          var normalized = normalizeSearchQuery(value);
          if (messagesSearchQuery === normalized) {
            return;
          }
          messagesSearchQuery = normalized;
          renderMessages(getMessagesForSelectedSite());
        }
        function getFilteredSites() {
          if (!siteSearchQuery) {
            return state.sites.slice();
          }
          var query = siteSearchQuery;
          return state.sites.filter(function(site) {
            var name = (site.name || emptyString).toLowerCase();
            var origin = (site.allowed_origin || emptyString).toLowerCase();
            var owner = (site.owner_email || emptyString).toLowerCase();
            return name.indexOf(query) !== -1 || origin.indexOf(query) !== -1 || owner.indexOf(query) !== -1;
          });
        }
        function getMessagesForSelectedSite() {
          if (!state.selectedSiteId || !state.siteMessages) {
            return [];
          }
          return state.siteMessages[state.selectedSiteId] || [];
        }
        function showSiteSearch() {
          if (!siteSearchContainer) {
            return;
          }
          siteSearchContainer.classList.remove('d-none');
          if (siteSearchToggleButton) {
            siteSearchToggleButton.setAttribute('aria-expanded', 'true');
          }
          if (siteSearchInput) {
            siteSearchInput.focus();
          }
        }
        function hideSiteSearch() {
          if (!siteSearchContainer) {
            return;
          }
          siteSearchContainer.classList.add('d-none');
          if (siteSearchToggleButton) {
            siteSearchToggleButton.setAttribute('aria-expanded', 'false');
          }
          if (siteSearchInput) {
            siteSearchInput.value = '';
          }
          if (siteSearchQuery !== '') {
            siteSearchQuery = '';
            renderSites();
          }
        }
        function toggleSiteSearchVisibility() {
          if (!siteSearchContainer) {
            return;
          }
          if (siteSearchContainer.classList.contains('d-none')) {
            showSiteSearch();
          } else {
            hideSiteSearch();
          }
        }
        function showMessagesSearch() {
          if (!messagesSearchContainer) {
            return;
          }
          messagesSearchContainer.classList.remove('d-none');
          if (messagesSearchToggleButton) {
            messagesSearchToggleButton.setAttribute('aria-expanded', 'true');
          }
          if (messagesSearchInput) {
            messagesSearchInput.focus();
          }
        }
        function hideMessagesSearch() {
          if (!messagesSearchContainer) {
            return;
          }
          messagesSearchContainer.classList.add('d-none');
          if (messagesSearchToggleButton) {
            messagesSearchToggleButton.setAttribute('aria-expanded', 'false');
          }
          if (messagesSearchInput) {
            messagesSearchInput.value = '';
          }
          if (messagesSearchQuery !== '') {
            messagesSearchQuery = '';
            renderMessages(getMessagesForSelectedSite());
          }
        }
        function toggleMessagesSearchVisibility() {
          if (!messagesSearchContainer) {
            return;
          }
          if (messagesSearchContainer.classList.contains('d-none')) {
            showMessagesSearch();
          } else {
            hideMessagesSearch();
          }
        }
        function initializeFieldHelpPopovers() {
          if (!window.bootstrap || !window.bootstrap.Popover) {
            return;
          }
          [siteNameHelpButton, allowedOriginHelpButton, ownerEmailHelpButton].forEach(function(button) {
            if (button) {
              new window.bootstrap.Popover(button);
            }
          });
        }
        var buttonStatusDisplayDuration = 3000;
        var widgetBaseURL = window.location.origin.replace(/\/$/, '');
        if (widgetSnippetTextarea) {
          widgetSnippetTextarea.value = widgetUnavailableMessage;
        }
        if (copyWidgetSnippetButton) {
          copyWidgetSnippetButton.disabled = true;
        }
        setButtonDefault(copyWidgetSnippetButton, buttonLabels.copy_default || '', buttonClasses.copy_default || '');
        setButtonDefault(refreshMessagesButton, buttonLabels.refresh_default || '', buttonClasses.refresh_default || '');
        setButtonDefault(saveSiteButton, updateButtonLabel, updateButtonClass);
        registerValidationHandlers();
        registerSiteFormTabCycle();
        initializeFieldHelpPopovers();
        clearValidationFeedback();

        function isRecognizedTheme(value) {
          return value === 'dark' || value === 'light';
        }

        function readThemePreference(storageKey) {
          if (!storageKey) {
            return '';
          }
          var storedValue = localStorage.getItem(storageKey);
          if (storedValue === null) {
            return '';
          }
          return storedValue;
        }

        function writeThemePreference(storageKey, mode) {
          if (!storageKey) {
            return;
          }
          localStorage.setItem(storageKey, mode);
        }

        function resolveThemePreference() {
          var publicTheme = readThemePreference(themePreferencePublicStorageKey);
          if (isRecognizedTheme(publicTheme)) {
            writeThemePreference(themePreferenceStorageKey, publicTheme);
            return publicTheme;
          }
          var landingTheme = readThemePreference(themePreferenceLandingStorageKey);
          if (isRecognizedTheme(landingTheme)) {
            writeThemePreference(themePreferenceStorageKey, landingTheme);
            return landingTheme;
          }
          var storedTheme = readThemePreference(themePreferenceStorageKey);
          if (isRecognizedTheme(storedTheme)) {
            return storedTheme;
          }
          var legacyTheme = readThemePreference(themePreferenceLegacyStorageKey);
          if (isRecognizedTheme(legacyTheme)) {
            writeThemePreference(themePreferenceStorageKey, legacyTheme);
            return legacyTheme;
          }
          writeThemePreference(themePreferenceStorageKey, 'light');
          return 'light';
        }

        function applyThemePreference(mode) {
          var normalized = mode === 'dark' ? 'dark' : 'light';
          currentThemeMode = normalized;
          document.documentElement.setAttribute('data-bs-theme', normalized);
          if (normalized === 'dark') {
            document.body.classList.remove('bg-light');
            document.body.classList.add('bg-dark', 'text-light');
            applyElementThemeClasses(footerElement, footerThemeClasses.dark || '', footerThemeClasses.light || '');
            applyElementThemeClasses(feedbackTableHeader, tableThemeClasses.dark || '', tableThemeClasses.light || '');
          } else {
            document.body.classList.remove('bg-dark', 'text-light');
            if (!document.body.classList.contains('bg-light')) {
              document.body.classList.add('bg-light');
            }
            applyElementThemeClasses(footerElement, footerThemeClasses.light || '', footerThemeClasses.dark || '');
            applyElementThemeClasses(feedbackTableHeader, tableThemeClasses.light || '', tableThemeClasses.dark || '');
          }
          if (sessionTimeoutManager && typeof sessionTimeoutManager.applyTheme === 'function') {
            sessionTimeoutManager.applyTheme(normalized);
          }
        }

        function persistThemePreference(mode) {
          writeThemePreference(themePreferenceStorageKey, mode);
          writeThemePreference(themePreferencePublicStorageKey, mode);
          writeThemePreference(themePreferenceLandingStorageKey, mode);
          writeThemePreference(themePreferenceLegacyStorageKey, mode);
        }

        function synchronizeFooterToggle(mode) {
          if (!footerThemeToggleInput) {
            return;
          }
          var shouldCheck = mode === 'dark';
          if (footerThemeToggleInput.checked !== shouldCheck) {
            footerThemeToggleInput.checked = shouldCheck;
          }
        }

        function handleThemeSelection(mode) {
          var normalizedMode = mode === 'dark' ? 'dark' : 'light';
          applyThemePreference(normalizedMode);
          persistThemePreference(normalizedMode);
          synchronizeFooterToggle(normalizedMode);
        }

        function loadThemePreference() {
          var stored = resolveThemePreference();
          synchronizeFooterToggle(stored);
          applyThemePreference(stored);
        }

        function performLogout() {
          if (sessionTimeoutManager && typeof sessionTimeoutManager.stop === 'function') {
            sessionTimeoutManager.stop();
          }
          if (!logoutPath) {
            window.location.href = landingPath;
            return;
          }
          var redirectToLanding = function() {
            window.location.href = landingPath;
          };
          window.fetch(logoutPath, {
            method: 'POST',
            credentials: 'same-origin'
          }).then(redirectToLanding).catch(redirectToLanding);
        }

        function fetchJSON(url, options) {
          var requestOptions = options || {};
          if (!requestOptions.credentials) {
            requestOptions.credentials = 'same-origin';
          }
          return window.fetch(url, requestOptions).then(function(response) {
            if (response.status === 401) {
              window.location.href = loginPath;
              return Promise.reject(new Error('unauthorized'));
            }
            var forbiddenResponse = response.status === 403;
            if (!response.ok) {
              if (forbiddenResponse && refreshMessagesButton) {
                updateButtonStatus(refreshMessagesButton, buttonLabels.refresh_failed || '', buttonStyles.danger || '');
              }
              return response.json().catch(function() {
                return {};
              }).then(function(body) {
                var backendErrorCode = '';
                if (body && typeof body.error === 'string') {
                  backendErrorCode = body.error;
                } else if (body && typeof body.message === 'string') {
                  backendErrorCode = body.message;
                }
                var resolvedMessage = resolveErrorMessage(backendErrorCode, statusMessages.load_failed || '');
                throw new Error(resolvedMessage);
              });
            }
            return response.json();
          });
        }

        function extractAvatarURL(user) {
          if (!user || typeof user !== 'object') {
            return '';
          }
          var avatar = user.avatar;
          if (!avatar || typeof avatar !== 'object') {
            return '';
          }
          var avatarURL = avatar.url;
          if (typeof avatarURL !== 'string') {
            return '';
          }
          return avatarURL.trim();
        }

        function updateUserCard() {
          var displayName = state.user.name || state.user.email;
          userName.textContent = displayName || '';
          userEmail.textContent = state.user.email || '';
          var avatarURL = extractAvatarURL(state.user);
          if (avatarURL) {
            userAvatar.src = avatarURL;
            userAvatar.classList.remove('d-none');
          } else {
            userAvatar.src = '';
            userAvatar.classList.add('d-none');
          }
          var isAdminUser = state.user.role === adminRoleValue;
          var roleLabel = isAdminUser ? roleLabels[adminRoleValue] : roleLabels[userRoleValue];
          userRole.textContent = roleLabel;
          userRole.className = isAdminUser ? 'badge bg-warning text-dark mt-2' : 'badge bg-secondary mt-2';
          if (editSiteOwnerContainer) {
            editSiteOwnerContainer.classList.remove('d-none');
          }

          var shouldShowAvatar = avatarURL !== '';
          settingsAvatarImage.src = shouldShowAvatar ? avatarURL : '';
          if (shouldShowAvatar) {
            settingsAvatarImage.classList.remove('d-none');
            settingsAvatarFallback.classList.add('d-none');
          } else {
            settingsAvatarImage.classList.add('d-none');
            settingsAvatarFallback.classList.remove('d-none');
          }
          clearValidationFeedback();
        }

        function isNewSiteSelected() {
          return state.selectedSiteId === newSiteOptionValue;
        }

        function buildWidgetSnippet(siteId) {
          return '<script defer src="' + widgetBaseURL + '/widget.js?site_id=' + siteId + '"></script>';
        }

        function updateButtonStatus(button, text, extraClass) {
          if (!button) {
            return;
          }
          if (!button._defaultText) {
            button._defaultText = button.textContent;
          }
          if (!button._defaultClass) {
            button._defaultClass = button.className;
          }
          button.textContent = text;
          button.className = extraClass || button._defaultClass;
          button._statusActive = true;
          clearTimeout(button._statusTimer);
          button._statusTimer = window.setTimeout(function() {
            button._statusActive = false;
            restoreButtonDefault(button);
          }, buttonStatusDisplayDuration);
        }

        function setButtonDefault(button, label, className) {
          if (!button) {
            return;
          }
          button._defaultText = label;
          button._defaultClass = className;
          if (button._statusActive) {
            return;
          }
          restoreButtonDefault(button);
        }

        function restoreButtonDefault(button) {
          if (!button) {
            return;
          }
          if (typeof button._defaultText === 'string') {
            button.textContent = button._defaultText;
          }
          if (typeof button._defaultClass === 'string') {
            button.className = button._defaultClass;
          }
        }

        function disableWidgetTestButton() {
          if (!widgetTestButton) {
            return;
          }
          widgetTestButton.disabled = true;
          widgetTestButton.dataset.siteId = '';
        }

        function enableWidgetTestButton(siteId) {
          if (!widgetTestButton) {
            return;
          }
          widgetTestButton.disabled = false;
          widgetTestButton.dataset.siteId = siteId || '';
        }

        function normalizeClassList(value) {
          if (typeof value !== 'string') {
            return [];
          }
          return value.split(/\s+/).filter(function(item) {
            return item.length > 0;
          });
        }

        function normalizeMessage(value) {
          if (typeof value !== 'string') {
            return '';
          }
          return value.trim();
        }

        function resolveErrorMessage(errorCode, fallbackMessage) {
          var normalizedCode = normalizeMessage(errorCode);
          if (normalizedCode !== '') {
            var mappedMessage = normalizeMessage(errorMessages[normalizedCode]);
            if (mappedMessage !== '') {
              return mappedMessage;
            }
          }
          var normalizedFallback = normalizeMessage(fallbackMessage);
          if (normalizedFallback !== '') {
            return normalizedFallback;
          }
          if (normalizedCode !== '') {
            return normalizedCode;
          }
          return '';
        }

        function applyElementThemeClasses(element, classesToAdd, classesToRemove) {
          if (!element) {
            return;
          }
          normalizeClassList(classesToRemove).forEach(function(className) {
            element.classList.remove(className);
          });
          normalizeClassList(classesToAdd).forEach(function(className) {
            element.classList.add(className);
          });
        }

        function updateNewSiteButtonState() {
          if (!newSiteButton) {
            return;
          }
          if (isNewSiteSelected()) {
            newSiteButton.className = newSiteButtonActiveClass;
          } else {
            newSiteButton.className = newSiteButtonDefaultClass;
          }
        }

        function updateDeleteButtonState() {
          if (!deleteSiteButton) {
            return;
          }
          var shouldDisable = state.sites.length === 0 || !state.selectedSiteId || isNewSiteSelected();
          deleteSiteButton.disabled = shouldDisable;
          deleteSiteButton.className = shouldDisable ? deleteSiteButtonDisabledClass : deleteSiteButtonDefaultClass;
        }

        function setFormStatus(message, className) {
          if (!formStatus) {
            return;
          }
          if (formStatusResetTimerId) {
            clearTimeout(formStatusResetTimerId);
            formStatusResetTimerId = null;
          }
          formStatus.textContent = message;
          formStatus.className = className;
          var trimmed = (message || '').trim();
          if (trimmed === '') {
            clearFormStatus();
            return;
          }
          formStatusResetTimerId = window.setTimeout(function() {
            clearFormStatus();
          }, formStatusDisplayDuration);
        }

        function clearFormStatus() {
          if (!formStatus) {
            return;
          }
          if (formStatusResetTimerId) {
            clearTimeout(formStatusResetTimerId);
            formStatusResetTimerId = null;
          }
          formStatus.textContent = '';
          formStatus.className = formStatusBaseClass;
        }

        function clearDeleteConfirmationInput() {
          if (deleteSiteConfirmInput) {
            deleteSiteConfirmInput.value = '';
            deleteSiteConfirmInput.dataset.expectedName = '';
          }
          if (deleteSiteConfirmButton) {
            deleteSiteConfirmButton.disabled = true;
          }
        }

        function updateDeleteConfirmationState() {
          if (!deleteSiteConfirmInput || !deleteSiteConfirmButton) {
            return;
          }
          var expectedName = (deleteSiteConfirmInput.dataset.expectedName || '').trim();
          var typedName = deleteSiteConfirmInput.value.trim();
          deleteSiteConfirmButton.disabled = expectedName === '' || typedName !== expectedName;
        }

        function openDeleteSiteModal() {
          if (!deleteSiteModal || !deleteSiteButton || deleteSiteButton.disabled) {
            return;
          }
          var site = state.sites.find(function(item) { return item.id === state.selectedSiteId; });
          if (!site) {
            return;
          }
          state.pendingDeletionSiteId = site.id;
          if (deleteSiteTargetName) {
            deleteSiteTargetName.textContent = site.name || '';
          }
          if (deleteSiteConfirmInput) {
            deleteSiteConfirmInput.dataset.expectedName = site.name || '';
            deleteSiteConfirmInput.value = '';
          }
          if (deleteSiteConfirmButton) {
            deleteSiteConfirmButton.disabled = true;
          }
          deleteSiteModal.show();
          window.setTimeout(function() {
            if (deleteSiteConfirmInput) {
              deleteSiteConfirmInput.focus();
            }
          }, 150);
        }

        function deleteSelectedSite() {
          if (!state.pendingDeletionSiteId) {
            return;
          }
          var site = state.sites.find(function(item) { return item.id === state.pendingDeletionSiteId; });
          if (!site) {
            return;
          }
          if (deleteSiteConfirmButton) {
            deleteSiteConfirmButton.disabled = true;
          }
          setFormStatus(statusMessages.deleting_site || '', formStatusDangerClass);
          window.fetch(apiSiteUpdatePrefix + site.id, {
            method: 'DELETE',
            credentials: 'same-origin'
          }).then(function(response) {
            if (response.status === 401) {
              window.location.href = loginPath;
              throw new Error('unauthorized');
            }
            if (!response.ok) {
              return response.json().catch(function() {
                return {};
              }).then(function(body) {
                var message = body.error || body.message || statusMessages.delete_site_failed || '';
                throw new Error(message);
              });
            }
            return response;
          }).then(function() {
            state.sites = state.sites.filter(function(item) { return item.id !== site.id; });
            if (state.siteMessages) {
              delete state.siteMessages[site.id];
            }
            state.selectedSiteId = state.sites.length > 0 ? state.sites[0].id : newSiteOptionValue;
            state.pendingDeletionSiteId = '';
            if (deleteSiteModal) {
              deleteSiteModal.hide();
            }
            clearDeleteConfirmationInput();
            renderSites();
            setFormStatus(statusMessages.site_deleted || '', formStatusSuccessClass);
          }).catch(function(error) {
            if (error && error.message === 'unauthorized') {
              return;
            }
            setFormStatus((error && error.message) || statusMessages.delete_site_failed || '', formStatusDangerClass);
            if (deleteSiteConfirmInput) {
              updateDeleteConfirmationState();
            }
          });
        }

        function updateWidgetSnippet() {
          if (!state.selectedSiteId || isNewSiteSelected()) {
            widgetSnippetTextarea.value = widgetUnavailableMessage;
            copyWidgetSnippetButton.disabled = true;
            disableWidgetTestButton();
            return;
          }
          var site = state.sites.find(function(item) { return item.id === state.selectedSiteId; });
          if (!site) {
            widgetSnippetTextarea.value = widgetUnavailableMessage;
            copyWidgetSnippetButton.disabled = true;
            disableWidgetTestButton();
            return;
          }
          widgetSnippetTextarea.value = buildWidgetSnippet(site.id);
          copyWidgetSnippetButton.disabled = false;
          enableWidgetTestButton(site.id);
        }

        function copyWidgetSnippet() {
          if (copyWidgetSnippetButton.disabled) {
            return;
          }
          var snippet = widgetSnippetTextarea.value;
          if (!snippet || snippet === widgetUnavailableMessage) {
            updateButtonStatus(copyWidgetSnippetButton, buttonLabels.copy_failed || '', buttonStyles.danger || '');
            return;
          }
          if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(snippet).then(function() {
              updateButtonStatus(copyWidgetSnippetButton, buttonLabels.copy_copied || '', buttonStyles.primary || '');
            }).catch(function() {
              fallbackCopyWidgetSnippet(snippet);
            });
          } else {
            fallbackCopyWidgetSnippet(snippet);
          }
        }

        function fallbackCopyWidgetSnippet(snippet) {
          var previousSelectionStart = widgetSnippetTextarea.selectionStart;
          var previousSelectionEnd = widgetSnippetTextarea.selectionEnd;
          widgetSnippetTextarea.focus();
          widgetSnippetTextarea.select();
          var copySucceeded = false;
          try {
            copySucceeded = document.execCommand('copy');
          } catch (error) {
            copySucceeded = false;
          }
          widgetSnippetTextarea.selectionStart = previousSelectionStart;
          widgetSnippetTextarea.selectionEnd = previousSelectionEnd;
          widgetSnippetTextarea.blur();
          if (copySucceeded) {
            updateButtonStatus(copyWidgetSnippetButton, buttonLabels.copy_copied || '', buttonStyles.primary || '');
          } else {
            updateButtonStatus(copyWidgetSnippetButton, buttonLabels.copy_failed || '', buttonStyles.danger || '');
          }
        }

        function renderSites() {
          if (!sitesList) {
            return;
          }
          while (sitesList.firstChild) {
            sitesList.removeChild(sitesList.firstChild);
          }
          var filteredSites = getFilteredSites();
          var hasSites = filteredSites.length > 0;
          var previousSelectedSiteId = state.selectedSiteId;

          if (!state.selectedSiteId && hasSites) {
            state.selectedSiteId = filteredSites[0].id;
          }

          if (!isNewSiteSelected()) {
            var selectedExists = filteredSites.some(function(item) {
              return item.id === state.selectedSiteId;
            });
            if (!selectedExists) {
              if (hasSites) {
                state.selectedSiteId = filteredSites[0].id;
              } else if (siteSearchQuery === '') {
                state.selectedSiteId = state.sites.length > 0 ? state.sites[0].id : newSiteOptionValue;
              } else {
                state.selectedSiteId = '';
              }
            }
          }

          var selectedSite = null;
          filteredSites.forEach(function(site) {
            var listItem = document.createElement('button');
            listItem.type = 'button';
            listItem.className = siteListItemClass + (site.id === state.selectedSiteId ? ' ' + siteListItemActiveClass : '');
            listItem.dataset.siteId = site.id;

            if (site.id === state.selectedSiteId) {
              selectedSite = site;
            }

            var headerElement = document.createElement('div');
            headerElement.className = siteListItemHeaderClass;

            var faviconElement = document.createElement('img');
            faviconElement.className = siteListItemFaviconClass;
            faviconElement.width = 24;
            faviconElement.height = 24;
            faviconElement.alt = '';
            faviconElement.decoding = 'async';
            faviconElement.loading = 'lazy';
            faviconElement.referrerPolicy = 'no-referrer';
            var faviconURL = (site.favicon_url || '').trim();
            var siteOrigin = (site.allowed_origin || '').trim();
            var hasSiteOrigin = siteOrigin.length > 0;
            if (faviconURL.length > 0) {
              faviconElement.src = faviconURL;
              faviconElement.addEventListener('error', function() {
                faviconElement.classList.add('d-none');
              });
              if (hasSiteOrigin) {
                faviconElement.tabIndex = 0;
                faviconElement.setAttribute('role', 'link');
                faviconElement.setAttribute('aria-label', siteOrigin);
                faviconElement.style.cursor = 'pointer';
                var openSiteInNewTab = function() {
                  window.open(siteOrigin, '_blank', 'noopener,noreferrer');
                };
                faviconElement.addEventListener('click', function() {
                  openSiteInNewTab();
                });
                faviconElement.addEventListener('keydown', function(event) {
                  if (event.key === 'Enter' || event.key === ' ' || event.key === 'Spacebar') {
                    event.preventDefault();
                    event.stopPropagation();
                    openSiteInNewTab();
                  }
                });
              }
            } else {
              faviconElement.classList.add('d-none');
            }
            headerElement.appendChild(faviconElement);

            var nameElement = document.createElement('span');
            nameElement.className = 'fw-semibold text-truncate flex-grow-1';
            nameElement.textContent = site.name || '';
            headerElement.appendChild(nameElement);

            listItem.appendChild(headerElement);

            var originElement = document.createElement('div');
            originElement.className = 'small text-muted text-truncate';
            originElement.textContent = site.allowed_origin || '';
            listItem.appendChild(originElement);

            sitesList.appendChild(listItem);
          });

          if (hasSites) {
            emptySitesMessage.classList.add('d-none');
          } else {
            emptySitesMessage.textContent = siteSearchQuery ? statusNoSiteMatches : statusMessages.no_sites || '';
            emptySitesMessage.classList.remove('d-none');
          }

          updateNewSiteButtonState();
          updateDeleteButtonState();
          updateSelectedSiteSummary(selectedSite);
          populateSiteForm();
          updateWidgetSnippet();
          if (!state.selectedSiteId) {
            renderFeedbackPlaceholder(siteSearchQuery ? statusNoSiteMatches : statusMessages.select_site || '');
            return;
          }
          if (isNewSiteSelected()) {
            renderFeedbackPlaceholder(statusMessages.select_site || '');
            return;
          }
          if (previousSelectedSiteId !== state.selectedSiteId || !state.siteMessages[state.selectedSiteId]) {
            loadMessages(false);
            return;
          }
          renderMessages(state.siteMessages[state.selectedSiteId]);
        }

        function handleSitesListClick(event) {
          var target = event.target;
          while (target && target !== sitesList && !target.dataset.siteId) {
            target = target.parentElement;
          }
          if (!target || target === sitesList) {
            return;
          }
          var siteIdentifier = target.dataset.siteId;
          if (!siteIdentifier || siteIdentifier === state.selectedSiteId) {
            return;
          }
          clearValidationFeedback();
          state.selectedSiteId = siteIdentifier;
          renderSites();
        }

        function clearSiteForm() {
          editSiteNameInput.value = '';
          editSiteOriginInput.value = '';
          editSiteOwnerInput.value = '';
          setWidgetPlacementControls(widgetDefaultSide, widgetDefaultBottomOffset);
          clearValidationFeedback();
          setSiteCreatedAt(null);
          setFeedbackCount(0, 0);
        }

        function populateSiteForm() {
          clearValidationFeedback();
          if (!state.selectedSiteId) {
            updateSelectedSiteSummary(null);
            clearSiteForm();
            saveSiteButton.disabled = true;
            updateFormMode();
            updateWidgetSnippet();
            return;
          }

          if (isNewSiteSelected()) {
            updateSelectedSiteSummary(null);
            clearSiteForm();
            saveSiteButton.disabled = false;
            updateFormMode();
            updateWidgetSnippet();
            return;
          }

          var site = state.sites.find(function(item) { return item.id === state.selectedSiteId; });
          if (!site) {
            updateSelectedSiteSummary(null);
            clearSiteForm();
            saveSiteButton.disabled = true;
            updateFormMode();
            updateWidgetSnippet();
            return;
          }

          updateSelectedSiteSummary(site);
          editSiteNameInput.value = site.name || '';
          editSiteOriginInput.value = site.allowed_origin || '';
          editSiteOwnerInput.value = site.owner_email || '';
          setWidgetPlacementControls(site.widget_bubble_side, site.widget_bubble_bottom_offset);
          saveSiteButton.disabled = false;
          updateFormMode();
          updateWidgetSnippet();
        }

        function updateFormMode() {
          if (!state.user) {
            return;
          }
          if (isNewSiteSelected()) {
            setButtonDefault(saveSiteButton, createButtonLabel, createButtonClass);
          } else {
            setButtonDefault(saveSiteButton, updateButtonLabel, updateButtonClass);
          }
          if (!editSiteOwnerInput) {
            return;
          }
          editSiteOwnerInput.disabled = false;
        }

        function renderFeedbackPlaceholder(message) {
          feedbackTableBody.innerHTML = '';
          var row = document.createElement('tr');
          var cell = document.createElement('td');
          cell.colSpan = 4;
          cell.className = 'text-center text-muted';
          cell.textContent = message;
          row.appendChild(cell);
          feedbackTableBody.appendChild(row);
          setFeedbackCount(0, 0);
        }

        function renderMessages(messages) {
          var baseMessages = Array.isArray(messages) ? messages : [];
          var filteredMessages = filterMessages(baseMessages);
          if (!filteredMessages.length) {
            if (baseMessages.length === 0 && messagesSearchQuery === '') {
              renderFeedbackPlaceholder(statusMessages.no_messages || '');
              setFeedbackCount(0, 0);
              return;
            }
            renderFeedbackPlaceholder(messagesSearchQuery ? statusNoMessageMatches : statusMessages.no_messages || '');
            setFeedbackCount(baseMessages.length, 0);
            return;
          }
          feedbackTableBody.innerHTML = '';
          filteredMessages.forEach(function(message) {
            var row = document.createElement('tr');
            var createdCell = document.createElement('td');
            createdCell.textContent = formatTimestamp(message.created_at);
            var contactCell = document.createElement('td');
            renderContactValue(contactCell, message.contact);
            var bodyCell = document.createElement('td');
            bodyCell.textContent = message.message;
            var deliveryCell = document.createElement('td');
            deliveryCell.textContent = resolveDeliveryLabel(message.delivery);
            row.appendChild(createdCell);
            row.appendChild(contactCell);
            row.appendChild(bodyCell);
            row.appendChild(deliveryCell);
            feedbackTableBody.appendChild(row);
          });
          setFeedbackCount(baseMessages.length, filteredMessages.length);
        }

        function filterMessages(messages) {
          if (!messagesSearchQuery) {
            return messages.slice();
          }
          var query = messagesSearchQuery;
          return messages.filter(function(message) {
            var contactValue = (message.contact || emptyString).toLowerCase();
            var bodyValue = (message.message || emptyString).toLowerCase();
            var deliveryValue = (message.delivery || emptyString).toLowerCase();
            return contactValue.indexOf(query) !== -1 || bodyValue.indexOf(query) !== -1 || deliveryValue.indexOf(query) !== -1;
          });
        }

        function formatTimestamp(unixSeconds) {
          if (!unixSeconds) {
            return '';
          }
          var date = new Date(unixSeconds * 1000);
          return date.toLocaleDateString();
        }

        function resolveDeliveryLabel(value) {
          var normalized = (value || emptyString).toLowerCase();
          if (normalized === 'mailed' || normalized === 'texted') {
            return normalized;
          }
          return 'no';
        }

        function loadUser() {
          return fetchJSON(apiMeEndpoint).then(function(payload) {
            state.user = payload;
            updateUserCard();
          }).catch(function(error) {
            updateButtonStatus(saveSiteButton, error.message || buttonLabels.save_failed || '', buttonStyles.danger || '');
            saveSiteButton.disabled = false;
            throw error;
          });
        }

        function loadSites() {
          updateButtonStatus(refreshMessagesButton, buttonLabels.refresh_loading || '', buttonStyles.secondary || '');
          return fetchJSON(apiSitesEndpoint).then(function(payload) {
            state.sites = payload.sites || [];
            state.siteMessages = {};
            renderSites();
          }).catch(function(error) {
            updateButtonStatus(saveSiteButton, error.message || buttonLabels.save_failed || '', buttonStyles.danger || '');
            saveSiteButton.disabled = false;
          });
        }

        function loadMessages(shouldUpdateButtonStatus) {
          var manualRefresh = shouldUpdateButtonStatus === true;
          if (!state.selectedSiteId || isNewSiteSelected()) {
            renderFeedbackPlaceholder(statusMessages.select_site || '');
            if (manualRefresh) {
              setButtonDefault(refreshMessagesButton, buttonLabels.refresh_default || '', buttonClasses.refresh_default || '');
            }
            return;
          }
          var endpoint = apiSiteMessagesPrefix + state.selectedSiteId + apiSiteMessagesSuffix;
          renderFeedbackPlaceholder(statusMessages.loading_sites || 'Loading...');
          if (manualRefresh) {
            updateButtonStatus(refreshMessagesButton, buttonLabels.refresh_loading || '', buttonStyles.secondary || '');
          }
          fetchJSON(endpoint).then(function(payload) {
            var messages = payload.messages || [];
            var site = state.sites.find(function(item) { return item.id === state.selectedSiteId; });
            state.siteMessages[state.selectedSiteId] = messages;
            if (site) {
              site.feedback_count = messages.length;
              updateSelectedSiteSummary(site);
            }
            renderMessages(messages);
            if (manualRefresh) {
              updateButtonStatus(refreshMessagesButton, buttonLabels.refresh_success || '', buttonStyles.secondary || '');
            }
        }).catch(function() {
          renderFeedbackPlaceholder(statusMessages.load_failed || '');
          var site = state.sites.find(function(item) { return item.id === state.selectedSiteId; });
          if (site) {
            setFeedbackCount(site.feedback_count || 0, site.feedback_count || 0);
          } else {
            setFeedbackCount(0, 0);
          }
          if (manualRefresh) {
            updateButtonStatus(refreshMessagesButton, buttonLabels.refresh_failed || '', buttonStyles.danger || '');
          }
        });
      }

      function closeFaviconEventStream() {
        if (!faviconEventSource) {
          return;
        }
        faviconEventSource.close();
        faviconEventSource = null;
      }

      function openFaviconEventStream() {
        if (!window.EventSource || !siteFaviconEventsEndpoint) {
          return;
        }
        closeFaviconEventStream();
        faviconEventSource = new EventSource(siteFaviconEventsEndpoint);
        faviconEventSource.addEventListener(faviconUpdatedEventName, handleFaviconUpdateEvent);
        faviconEventSource.onerror = function() {
          closeFaviconEventStream();
          window.setTimeout(openFaviconEventStream, faviconReconnectDelayMilliseconds);
        };
      }

      function handleFaviconUpdateEvent(event) {
        if (!event || !event.data) {
          return;
        }
        var payload;
        try {
          payload = JSON.parse(event.data);
        } catch (error) {
          return;
        }
        var siteIdentifier = (payload.site_id || '').trim();
        var faviconURL = (payload.favicon_url || '').trim();
        if (!siteIdentifier || !faviconURL) {
          return;
        }
        var site = state.sites.find(function(item) { return item.id === siteIdentifier; });
        if (!site) {
          return;
        }
        if (site.favicon_url === faviconURL) {
          return;
        }
        site.favicon_url = faviconURL;
        renderSites();
      }

      function closeFeedbackEventStream() {
        if (!feedbackEventSource) {
          return;
        }
        feedbackEventSource.close();
        feedbackEventSource = null;
      }

      function openFeedbackEventStream() {
        if (!window.EventSource || !feedbackEventsEndpoint) {
          return;
        }
        closeFeedbackEventStream();
        feedbackEventSource = new EventSource(feedbackEventsEndpoint);
        feedbackEventSource.addEventListener(feedbackUpdatedEventName, handleFeedbackUpdateEvent);
        feedbackEventSource.onerror = function() {
          closeFeedbackEventStream();
          window.setTimeout(openFeedbackEventStream, feedbackReconnectDelayMilliseconds);
        };
      }

      function handleFeedbackUpdateEvent(event) {
        if (!event || !event.data) {
          return;
        }
        var payload;
        try {
          payload = JSON.parse(event.data);
        } catch (error) {
          return;
        }
        var siteIdentifier = (payload.site_id || '').trim();
        if (!siteIdentifier) {
          return;
        }
        if (!state || !Array.isArray(state.sites)) {
          return;
        }
        var site = state.sites.find(function(item) { return item.id === siteIdentifier; });
        if (site) {
          if (typeof payload.feedback_count === 'number' && Number.isFinite(payload.feedback_count)) {
            site.feedback_count = payload.feedback_count;
          } else if (typeof site.feedback_count === 'number' && Number.isFinite(site.feedback_count)) {
            site.feedback_count += 1;
          } else {
            site.feedback_count = 1;
          }
        }
        if (state && state.siteMessages) {
          delete state.siteMessages[siteIdentifier];
        }
        renderSites();
      }

      function submitSite(event) {
        if (event) { event.preventDefault(); }
        if (saveSiteButton.disabled) { return; }
        if (!state.selectedSiteId) {
            updateButtonStatus(saveSiteButton, statusMessages.select_site || '', buttonStyles.secondary || '');
            return;
          }
          if (!validateSiteForm()) {
            return;
          }
          if (isNewSiteSelected()) {
            createSite();
          } else {
            updateSite();
          }
        }

        function updateSite() {
          saveSiteButton.disabled = true;
          updateButtonStatus(saveSiteButton, buttonLabels.save_saving || '');
          var ownerEmailValue = getTrimmedValue(editSiteOwnerInput);
          var body = {
            name: getTrimmedValue(editSiteNameInput),
            allowed_origin: getTrimmedValue(editSiteOriginInput)
          };
          if (ownerEmailValue) {
            body.owner_email = ownerEmailValue;
          }
          var placementPayload = determineWidgetPlacementPayload();
          body.widget_bubble_side = placementPayload.widget_bubble_side;
          body.widget_bubble_bottom_offset = placementPayload.widget_bubble_bottom_offset;
          var endpoint = apiSiteUpdatePrefix + state.selectedSiteId;
          fetchJSON(endpoint, {
            method: 'PATCH',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(body)
          }).then(function(payload) {
            updateButtonStatus(saveSiteButton, buttonLabels.save_saved || '');
            saveSiteButton.disabled = false;
            var index = state.sites.findIndex(function(item) { return item.id === payload.id; });
            if (index >= 0) {
              state.sites[index] = payload;
            }
            renderSites();
          }).catch(function(error) {
            updateButtonStatus(saveSiteButton, error.message || buttonLabels.save_failed || '', buttonStyles.danger || '');
            saveSiteButton.disabled = false;
          });
        }

        function createSite() {
          saveSiteButton.disabled = true;
          updateButtonStatus(saveSiteButton, buttonLabels.save_saving || '');
          var body = {
            name: getTrimmedValue(editSiteNameInput),
            allowed_origin: getTrimmedValue(editSiteOriginInput),
            owner_email: getTrimmedValue(editSiteOwnerInput)
          };
          var placementPayload = determineWidgetPlacementPayload();
          body.widget_bubble_side = placementPayload.widget_bubble_side;
          body.widget_bubble_bottom_offset = placementPayload.widget_bubble_bottom_offset;
          fetchJSON(apiSitesEndpoint, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(body)
          }).then(function(payload) {
            updateButtonStatus(saveSiteButton, buttonLabels.save_created || '');
            saveSiteButton.disabled = false;
            state.sites.unshift(payload);
            if (!state.siteMessages) {
              state.siteMessages = {};
            }
            state.siteMessages[payload.id] = [];
            state.selectedSiteId = payload.id;
            renderSites();
          }).catch(function(error) {
            updateButtonStatus(saveSiteButton, error.message || buttonLabels.save_failed || '', buttonStyles.danger || '');
            saveSiteButton.disabled = false;
          });
        }

        if (sitesList) {
          sitesList.addEventListener('click', handleSitesListClick);
        }
        if (siteSearchToggleButton) {
          siteSearchToggleButton.addEventListener('click', function(event) {
            event.preventDefault();
            toggleSiteSearchVisibility();
          });
        }
        if (siteSearchInput) {
          siteSearchInput.addEventListener('input', function() {
            applySiteSearchQuery(siteSearchInput.value);
          });
          siteSearchInput.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
              hideSiteSearch();
            }
          });
        }
        if (newSiteButton) {
          newSiteButton.addEventListener('click', function(event) {
            event.preventDefault();
            if (state.selectedSiteId === newSiteOptionValue) {
              return;
            }
            clearValidationFeedback();
            state.selectedSiteId = newSiteOptionValue;
            renderSites();
          });
        }
        if (deleteSiteButton) {
          deleteSiteButton.addEventListener('click', function(event) {
            event.preventDefault();
            openDeleteSiteModal();
          });
        }
        if (messagesSearchToggleButton) {
          messagesSearchToggleButton.addEventListener('click', function(event) {
            event.preventDefault();
            toggleMessagesSearchVisibility();
          });
        }
        if (messagesSearchInput) {
          messagesSearchInput.addEventListener('input', function() {
            applyMessagesSearchQuery(messagesSearchInput.value);
          });
          messagesSearchInput.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
              hideMessagesSearch();
            }
          });
        }
        if (deleteSiteConfirmInput) {
          deleteSiteConfirmInput.addEventListener('input', function() {
            updateDeleteConfirmationState();
          });
        }
        if (deleteSiteConfirmButton) {
          deleteSiteConfirmButton.addEventListener('click', function(event) {
            event.preventDefault();
            deleteSelectedSite();
          });
        }
        if (settingsModalElement) {
          settingsModalElement.dataset.loopawareSettingsModalDismissAttached = 'true';
          settingsModalElement.addEventListener('click', function(event) {
            if (event.target === settingsModalElement && window.bootstrap && window.bootstrap.Modal) {
              var modalInstance = window.bootstrap.Modal.getOrCreateInstance(settingsModalElement);
              if (modalInstance) {
                modalInstance.hide();
                settingsModalElement.dataset.loopawareSettingsModalDismissTriggered = 'true';
              }
            }
          });
          settingsModalElement.addEventListener('show.bs.modal', function() {
            updateAutoLogoutInputs(autoLogoutSettingsState);
            clearAutoLogoutValidation();
          });
        }
        if (autoLogoutToggle) {
          autoLogoutToggle.addEventListener('change', function() {
            handleAutoLogoutSettingsChange();
          });
        }
        if (autoLogoutPromptInput) {
          autoLogoutPromptInput.addEventListener('input', handleAutoLogoutSettingsChange);
          autoLogoutPromptInput.addEventListener('blur', handleAutoLogoutSettingsChange);
        }
        if (autoLogoutLogoutInput) {
          autoLogoutLogoutInput.addEventListener('input', handleAutoLogoutSettingsChange);
          autoLogoutLogoutInput.addEventListener('blur', handleAutoLogoutSettingsChange);
        }
        if (deleteSiteModalElement) {
          deleteSiteModalElement.addEventListener('hidden.bs.modal', function() {
            state.pendingDeletionSiteId = '';
            clearDeleteConfirmationInput();
          });
        }

        if (siteForm) {
          siteForm.addEventListener('submit', submitSite);
        }
        if (saveSiteButton) {
          saveSiteButton.addEventListener('click', submitSite);
        }
        if (footerThemeToggleInput) {
          footerThemeToggleInput.addEventListener('change', function(event) {
            var mode = event.target.checked ? 'dark' : 'light';
            handleThemeSelection(mode);
          });
        }
        if (footerElement) {
          footerElement.addEventListener('mpr-footer:theme-change', function(event) {
            var mode = event && event.detail && event.detail.theme === 'dark' ? 'dark' : 'light';
            handleThemeSelection(mode);
          });
        }
        if (copyWidgetSnippetButton) {
          copyWidgetSnippetButton.addEventListener('click', function(event) {
            event.preventDefault();
            copyWidgetSnippet();
          });
        }

        disableWidgetTestButton();
        if (widgetTestButton) {
          widgetTestButton.addEventListener('click', function(event) {
            event.preventDefault();
            if (widgetTestButton.disabled) {
              return;
            }
            var siteIdForTest = widgetTestButton.dataset.siteId || '';
            if (!siteIdForTest) {
              return;
            }
            var targetURL = (widgetTestPagePrefix || '') + siteIdForTest + (widgetTestPageSuffix || '');
            if (targetURL) {
              window.open(targetURL, '_blank', 'noopener');
            }
          });
        }
        if (refreshMessagesButton) {
          refreshMessagesButton.addEventListener('click', function(event) {
            event.preventDefault();
            loadMessages(true);
          });
        }
        if (logoutButton) {
          logoutButton.addEventListener('click', function(event) {
            event.preventDefault();
            performLogout();
          });
        }

        window.addEventListener('beforeunload', function() {
          closeFaviconEventStream();
          closeFeedbackEventStream();
        });

        loadThemePreference();
        sessionTimeoutStartRequested = true;
        if (sessionTimeoutManager && typeof sessionTimeoutManager.start === 'function') {
          sessionTimeoutManager.start();
        }
        loadUser().then(function() {
          openFaviconEventStream();
          openFeedbackEventStream();
          return loadSites();
        });
      })();
    </script>
    <script type="module">
      import Alpine from "https://cdn.jsdelivr.net/npm/alpinejs@3.13.5/dist/module.esm.js";
      import { mprFooter } from "https://cdn.jsdelivr.net/gh/MarcoPoloResearchLab/mpr-ui@main/footer.js";
      window.Alpine = Alpine;
      window.mprFooter = mprFooter;
      Alpine.start();
    </script>
  </body>
</html>
