<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>{{.PageTitle}}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script>
    window.addEventListener('DOMContentLoaded', function() {
      (function() {
      var THEME_KEYS = [
        'loopaware_dashboard_theme',
        'loopaware_public_theme',
        'loopaware_landing_theme',
        'loopaware_theme'
      ];
      var theme = 'light';
      for (var index = 0; index < THEME_KEYS.length; index++) {
        try {
          var value = localStorage.getItem(THEME_KEYS[index]);
          if (value === 'dark') {
            theme = 'dark';
            break;
          }
          if (value === 'light') {
            theme = 'light';
          }
        } catch (error) {
          theme = 'light';
        }
      }
      document.documentElement.setAttribute('data-bs-theme', theme);
      }());
    });
  </script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" {{.BootstrapIconsIntegrity}} crossorigin="anonymous" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/MarcoPoloResearchLab/mpr-ui@latest/mpr-ui.css" />
  <link rel="icon" type="image/svg+xml" href="{{.FaviconDataURI}}" />
  {{if .TauthScriptURL}}<script defer src="{{.TauthScriptURL}}"></script>{{end}}
  <script defer src="https://cdn.jsdelivr.net/gh/MarcoPoloResearchLab/mpr-ui@latest/mpr-ui.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>{{.SharedStyles}}</style>
</head>
<body class="d-flex flex-column min-vh-100" data-events-endpoint="{{.EventsEndpoint}}" data-site-id="{{.SiteID}}" data-default-accent="{{.DefaultAccent}}" data-default-cta="{{.DefaultCTA}}">
  {{template "dashboard_header" .Header}}
  <div class="modal fade" id="{{.Header.SettingsModalID}}" tabindex="-1" aria-labelledby="{{.Header.SettingsModalTitleID}}" aria-describedby="{{.Header.SettingsModalContentID}}" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="{{.Header.SettingsModalTitleID}}">{{.Header.SettingsModalTitle}}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{.Header.SettingsModalCloseLabel}}"></button>
        </div>
        <div class="modal-body">
          <p class="text-muted mb-4">{{.Header.SettingsModalIntro}}</p>
          <div id="{{.Header.SettingsModalContentID}}" class="d-flex flex-column gap-3"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{.Header.SettingsModalCloseLabel}}</button>
        </div>
      </div>
    </div>
  </div>
  <main class="flex-fill pt-5 mt-4">
    <div class="container">
      <div class="row justify-content-center">
        <div class="col-lg-10">
          <div class="card shadow-sm border-0 mb-4">
            <div class="card-body">
              <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-3">
                <div>
                  <h1 class="h4 mb-1">Test subscribe widget — {{.SiteName}}</h1>
                  <p class="text-muted small mb-0">Site ID: <code>{{.SiteID}}</code></p>
                </div>
                <span class="badge text-bg-secondary">Preview only</span>
              </div>
              <hr class="my-4" />
              <p class="text-muted mb-4">Adjust colors and copy, then try both widget modes. Submissions are stored on the selected site.</p>
              <div class="row g-3">
                <div class="col-md-4">
                  <label class="form-label" for="{{.AccentInputID}}">Accent color</label>
                  <input type="color" class="form-control form-control-color w-100" id="{{.AccentInputID}}" value="{{.DefaultAccent}}" title="Choose a hex color">
                </div>
                <div class="col-md-4">
                  <label class="form-label" for="{{.CTAInputID}}">CTA text</label>
                  <input type="text" class="form-control" id="{{.CTAInputID}}" value="{{.DefaultCTA}}" maxlength="40" autocomplete="off" placeholder="Call to action">
                </div>
                <div class="col-md-4 d-flex align-items-center">
                  <div class="form-check mt-4">
                    <input class="form-check-input" type="checkbox" id="{{.NameFieldInputID}}" checked>
                    <label class="form-check-label" for="{{.NameFieldInputID}}">Include optional name field</label>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="card shadow-sm border-0 mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="mb-0">{{.InlineFormTitle}}</h5>
            </div>
            <div class="card-body">
              <p class="text-muted small mb-4">This preview renders the inline subscribe widget with the options above and submits to the live API.</p>
              <div class="d-flex justify-content-center">
                <div id="{{.InlineFormContainerID}}" class="w-100 d-flex justify-content-center"></div>
              </div>
            </div>
          </div>
          <div class="card shadow-sm border-0 mt-4">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="mb-0">Submission activity</h5>
              <span id="{{.StatusTextElementID}}" class="small text-muted"></span>
            </div>
            <div class="card-body">
              <div id="{{.StatusLogElementID}}" class="list-group list-group-flush small"></div>
              <p class="text-muted small mt-3 mb-0">Success entries include subscriber IDs. Notification errors surface here with reason text.</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
  {{.FooterHTML}}
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
  <script>
    (function() {
      var themeStorageKey = '{{js .ThemeStorageKey}}';
      var publicThemeStorageKey = '{{js .PublicThemeStorageKey}}';
      var landingThemeStorageKey = '{{js .LandingThemeStorageKey}}';
      var legacyThemeStorageKey = '{{js .LegacyThemeStorageKey}}';
      var footerElement = document.getElementById('{{js .FooterElementID}}');
      var footerLightClass = '{{js .FooterThemeLightClass}}';
      var footerDarkClass = '{{js .FooterThemeDarkClass}}';
      var footerBaseClass = '{{js .FooterBaseClass}}';
      var landingPath = '{{js .LandingPath}}';
      var dashboardPath = '{{js .DashboardPath}}';
      var authFetch = typeof window.apiFetch === 'function' ? window.apiFetch : window.fetch.bind(window);

      function normalizeClassList(value) {
        if (typeof value !== 'string') {
          return [];
        }
        return value.split(/\s+/).filter(function(item) {
          return item.length > 0;
        });
      }

      function applyElementThemeClasses(element, classesToAdd, classesToRemove) {
        if (!element) {
          return;
        }
        normalizeClassList(classesToRemove).forEach(function(className) {
          element.classList.remove(className);
        });
        normalizeClassList(classesToAdd).forEach(function(className) {
          element.classList.add(className);
        });
      }

      function isRecognizedTheme(value) {
        return value === 'dark' || value === 'light';
      }

      function readThemePreference(storageKey) {
        if (!storageKey) {
          return '';
        }
        try {
          var storedValue = localStorage.getItem(storageKey);
          if (storedValue === null) {
            return '';
          }
          return storedValue;
        } catch (storageError) {
          return '';
        }
      }

      function writeThemePreference(storageKey, mode) {
        if (!storageKey) {
          return;
        }
        try {
          localStorage.setItem(storageKey, mode);
        } catch (writeError) {
        }
      }

      function resolveThemePreference() {
        var storedTheme = readThemePreference(themeStorageKey);
        if (isRecognizedTheme(storedTheme)) {
          return storedTheme;
        }
        var publicTheme = readThemePreference(publicThemeStorageKey);
        if (isRecognizedTheme(publicTheme)) {
          writeThemePreference(themeStorageKey, publicTheme);
          return publicTheme;
        }
        var landingTheme = readThemePreference(landingThemeStorageKey);
        if (isRecognizedTheme(landingTheme)) {
          writeThemePreference(themeStorageKey, landingTheme);
          return landingTheme;
        }
        var legacyTheme = readThemePreference(legacyThemeStorageKey);
        if (isRecognizedTheme(legacyTheme)) {
          writeThemePreference(themeStorageKey, legacyTheme);
          return legacyTheme;
        }
        writeThemePreference(themeStorageKey, 'light');
        return 'light';
      }

      function parseThemeConfig(rawValue) {
        if (!rawValue) {
          return {};
        }
        try {
          var parsed = JSON.parse(rawValue);
          if (parsed && typeof parsed === 'object') {
            return parsed;
          }
        } catch (error) {
          console.error(error);
        }
        return {};
      }

      function updateFooterThemeConfig(mode) {
        if (!footerElement) {
          return;
        }
        var normalized = mode === 'dark' ? 'dark' : 'light';
        var config = parseThemeConfig(footerElement.getAttribute('theme-config'));
        if (!config.attribute) {
          config.attribute = 'data-bs-theme';
        }
        config.initialMode = normalized;
        footerElement.setAttribute('theme-config', JSON.stringify(config));
      }

      function applyThemePreference(mode) {
        var normalized = mode === 'dark' ? 'dark' : 'light';
        document.documentElement.setAttribute('data-bs-theme', normalized);
        var footerThemeClass = normalized === 'dark' ? footerDarkClass : footerLightClass;
        applyElementThemeClasses(footerElement, footerThemeClass + ' ' + footerBaseClass, normalized === 'dark' ? footerLightClass : footerDarkClass);
      }

      function handleThemeSelection(mode) {
        writeThemePreference(themeStorageKey, mode);
        writeThemePreference(publicThemeStorageKey, mode);
        applyThemePreference(mode);
      }

      var resolvedTheme = resolveThemePreference();
      updateFooterThemeConfig(resolvedTheme);
      applyThemePreference(resolvedTheme);

      if (footerElement) {
        footerElement.addEventListener('mpr-footer:theme-change', function(event) {
          var nextTheme = event && event.detail && event.detail.theme === 'dark' ? 'dark' : 'light';
          handleThemeSelection(nextTheme);
        });
      }
      var body = document.body;
      if (!body) {
        return;
      }
      var siteIdentifier = body.getAttribute('data-site-id') || '';
      var eventsEndpoint = body.getAttribute('data-events-endpoint') || '';
      var defaultAccent = body.getAttribute('data-default-accent') || '';
      var defaultCTA = body.getAttribute('data-default-cta') || '';
      var accentInput = document.getElementById('{{js .AccentInputID}}');
      var ctaInput = document.getElementById('{{js .CTAInputID}}');
      var nameFieldInput = document.getElementById('{{js .NameFieldInputID}}');
      var inlineFormContainer = document.getElementById('{{js .InlineFormContainerID}}');
      var statusText = document.getElementById('{{js .StatusTextElementID}}');
      var statusLog = document.getElementById('{{js .StatusLogElementID}}');
      var eventSource = null;
      var inlinePreview = null;
      var submitEndpoint = (window.location && window.location.origin ? window.location.origin : '') + '/app/sites/' + encodeURIComponent(siteIdentifier) + '/subscribe-test/subscriptions';

      function normalizeCTA(value) {
        var trimmed = (value || '').trim();
        if (trimmed.length === 0) {
          return defaultCTA || 'Subscribe';
        }
        return trimmed.slice(0, 40);
      }

      function normalizeAccent(value) {
        var trimmed = (value || '').trim();
        if (!/^#[0-9a-f]{6}$/i.test(trimmed)) {
          return defaultAccent || '#0d6efd';
        }
        return trimmed;
      }

      function validateEmail(value) {
        var trimmed = (value || '').trim();
        return trimmed.length > 3 && trimmed.indexOf('@') > 0;
      }

      function createInlineContainer() {
        var container = document.createElement('div');
        container.style.maxWidth = '420px';
        container.style.width = '100%';
        container.style.padding = '12px';
        container.style.border = '1px solid rgba(0,0,0,0.08)';
        container.style.borderRadius = '10px';
        container.style.boxShadow = '0 8px 24px rgba(0,0,0,0.12)';
        container.style.fontFamily = 'system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif';
        container.style.background = '#fff';
        container.style.color = '#1f2937';
        container.style.boxSizing = 'border-box';
        return container;
      }

      function createFormElements(showName) {
        var heading = document.createElement('div');
        heading.style.fontWeight = '600';
        heading.style.marginBottom = '8px';
        heading.textContent = 'Get updates';

        var email = document.createElement('input');
        email.id = 'mp-subscribe-email';
        email.type = 'email';
        email.placeholder = 'you@example.com';
        email.required = true;
        email.style.width = '100%';
        email.style.padding = '10px 12px';
        email.style.border = '1px solid #d1d5db';
        email.style.borderRadius = '8px';
        email.style.fontSize = '14px';
        email.style.boxSizing = 'border-box';
        email.autocomplete = 'email';

        var name = null;
        if (showName) {
          name = document.createElement('input');
          name.id = 'mp-subscribe-name';
          name.type = 'text';
          name.placeholder = 'Your name (optional)';
          name.style.width = '100%';
          name.style.padding = '10px 12px';
          name.style.border = '1px solid #d1d5db';
          name.style.borderRadius = '8px';
          name.style.fontSize = '14px';
          name.style.boxSizing = 'border-box';
          name.autocomplete = 'name';
        }

        var submit = document.createElement('button');
        submit.id = 'mp-subscribe-submit';
        submit.type = 'button';
        submit.textContent = normalizeCTA(ctaInput && ctaInput.value);
        submit.style.width = '100%';
        submit.style.padding = '10px 12px';
        submit.style.border = '0';
        submit.style.borderRadius = '8px';
        submit.style.fontWeight = '600';
        submit.style.cursor = 'pointer';
        submit.style.background = normalizeAccent(accentInput && accentInput.value);
        submit.style.color = '#fff';
        submit.style.boxSizing = 'border-box';

        var status = document.createElement('div');
        status.id = 'mp-subscribe-status';
        status.style.minHeight = '16px';
        status.style.marginTop = '8px';
        status.style.fontSize = '13px';
        status.style.color = '#374151';

        return {
          heading: heading,
          email: email,
          name: name,
          submit: submit,
          status: status,
        };
      }

      function renderInlinePreview(showName) {
        if (!inlineFormContainer) {
          return null;
        }
        inlineFormContainer.innerHTML = '';
        var innerWrapper = document.createElement('div');
        innerWrapper.style.width = '100%';
        innerWrapper.style.display = 'flex';
        innerWrapper.style.justifyContent = 'center';
        var container = createInlineContainer();
        var elements = createFormElements(showName);
        container.appendChild(elements.heading);
        container.appendChild(elements.email);
        if (elements.name) {
          container.appendChild(elements.name);
        }
        var spacer = document.createElement('div');
        spacer.style.height = '8px';
        container.appendChild(spacer);
        container.appendChild(elements.submit);
        container.appendChild(elements.status);
        innerWrapper.appendChild(container);
        inlineFormContainer.appendChild(innerWrapper);
        return {
          container: container,
          email: elements.email,
          name: elements.name,
          submit: elements.submit,
          status: elements.status,
          hasNameField: showName,
        };
      }

      function shouldShowNameField() {
        return !nameFieldInput || nameFieldInput.checked;
      }

      function applyPreviewOptions() {
        if (!inlinePreview) {
          return;
        }
        inlinePreview.submit.textContent = normalizeCTA(ctaInput && ctaInput.value);
        inlinePreview.submit.style.background = normalizeAccent(accentInput && accentInput.value);
      }

      function refreshInlinePreview() {
        inlinePreview = renderInlinePreview(shouldShowNameField());
        applyPreviewOptions();
        attachFormBehavior();
      }

      function updateFormStatus(message, color) {
        if (!inlinePreview || !inlinePreview.status) {
          return;
        }
        inlinePreview.status.textContent = message || '';
        inlinePreview.status.style.color = color || '#374151';
      }

      function attachFormBehavior() {
        if (!inlinePreview) {
          return;
        }
        var sending = false;
        function currentNameValue() {
          if (!nameFieldInput || nameFieldInput.checked) {
            if (inlinePreview.name) {
              return inlinePreview.name.value || '';
            }
            return '';
          }
          return '';
        }
        function submitInlineForm() {
          if (sending) {
            return;
          }
          var emailValue = (inlinePreview.email.value || '').trim();
          if (!validateEmail(emailValue)) {
            updateFormStatus('Enter a valid email.', '#dc2626');
            inlinePreview.email.focus();
            return;
          }
          sending = true;
          inlinePreview.submit.disabled = true;
          updateFormStatus('Sending...', '#2563eb');
          var payload = {
            site_id: siteIdentifier,
            email: emailValue,
            name: currentNameValue().trim(),
            source_url: window.location ? window.location.href : ''
          };
          authFetch(submitEndpoint, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload),
            keepalive: true
          }).then(function(response) {
            if (response.status === 401) {
              window.location.assign(landingPath || dashboardPath || '/');
              throw new Error('unauthorized');
            }
            if (!response.ok) {
              throw new Error('http_' + response.status);
            }
            return response.json().catch(function() {
              return {};
            });
          }).then(function() {
            inlinePreview.email.value = '';
            if (inlinePreview.name) {
              inlinePreview.name.value = '';
            }
            updateFormStatus("You're on the list!", '#15803d');
          }).catch(function(error) {
            if (error && error.message === 'unauthorized') {
              return;
            }
            updateFormStatus('Please try again.', '#dc2626');
          }).finally(function() {
            inlinePreview.submit.disabled = false;
            sending = false;
          });
        }
        inlinePreview.submit.addEventListener('click', function(event) {
          event.preventDefault();
          submitInlineForm();
        });
        inlinePreview.email.addEventListener('keydown', function(event) {
          if (event.key === 'Enter') {
            event.preventDefault();
            submitInlineForm();
          }
        });
        if (inlinePreview.name) {
          inlinePreview.name.addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
              event.preventDefault();
              submitInlineForm();
            }
          });
        }
      }

      function appendStatusLog(event) {
        if (!statusLog) {
          return;
        }
        var wrapper = document.createElement('div');
        wrapper.className = 'list-group-item d-flex flex-column gap-1';
        var title = document.createElement('div');
        title.className = 'fw-semibold text-nowrap';
        var timestamp = new Date(event.timestamp || Date.now());
        var icon = event.event_type === 'notification' ? 'bi-broadcast-pin' : 'bi-envelope';
        title.innerHTML = '<i class="bi ' + icon + ' me-2"></i>' + (event.event_type || 'event') + ' — ' + (event.status || 'ok');
        var bodyText = document.createElement('div');
        bodyText.className = 'text-muted';
        var email = event.email || '';
        var detailParts = [];
        if (email) {
          detailParts.push(email);
        }
        if (event.subscriber_id) {
          detailParts.push('ID ' + event.subscriber_id);
        }
        if (event.error) {
          detailParts.push('error: ' + event.error);
        }
        bodyText.textContent = detailParts.join(' • ') || 'No additional details';
        var timeLabel = document.createElement('div');
        timeLabel.className = 'text-muted small';
        timeLabel.textContent = timestamp.toLocaleTimeString();
        wrapper.appendChild(title);
        wrapper.appendChild(bodyText);
        wrapper.appendChild(timeLabel);
        statusLog.insertBefore(wrapper, statusLog.firstChild);
        if (statusLog.children.length > 8) {
          statusLog.removeChild(statusLog.lastChild);
        }
      }

      function updateStatusText(message) {
        if (!statusText) {
          return;
        }
        statusText.textContent = message || '';
      }

      function connectEvents() {
        if (!eventsEndpoint || !window.EventSource) {
          updateStatusText('Live events unavailable');
          return;
        }
        if (eventSource) {
          eventSource.close();
        }
        eventSource = new EventSource(eventsEndpoint);
        eventSource.onmessage = function(event) {
          updateStatusText('Receiving updates');
          try {
            var payload = JSON.parse(event.data || '{}');
            appendStatusLog(payload);
          } catch (parseError) {
            console.error(parseError);
          }
        };
        eventSource.onerror = function() {
          updateStatusText('Connection lost. Retrying…');
        };
      }

      refreshInlinePreview();
      connectEvents();

      if (accentInput) {
        accentInput.addEventListener('input', applyPreviewOptions);
      }
      if (ctaInput) {
        ctaInput.addEventListener('input', applyPreviewOptions);
      }
      if (nameFieldInput) {
        nameFieldInput.addEventListener('change', refreshInlinePreview);
      }
    }());
  </script>
</body>
</html>
