<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{.PageTitle}}</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" integrity="sha384-XGjxtQfXaH2tnPFa9x+ruJTuLE3Aa6LhHSWRr1XeTyhezb4abCG4ccI5AkVDxqC+" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/MarcoPoloResearchLab/mpr-ui@latest/mpr-ui.css" />
    <link rel="icon" type="image/svg+xml" href="{{.FaviconDataURI}}" />
    {{if .TauthScriptURL}}<script defer src="{{.TauthScriptURL}}"></script>{{end}}
    <script defer src="https://cdn.jsdelivr.net/gh/MarcoPoloResearchLab/mpr-ui@latest/mpr-ui.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
{{.SharedStyles}}
      .subscription-confirm-card {
        border-radius: 1rem;
      }
    </style>
  </head>
  <body class="landing-body d-flex flex-column min-vh-100 bg-body text-body" data-bs-theme="dark">
    {{.HeaderHTML}}
    <main class="flex-grow-1">
      <section class="py-5">
        <div class="container">
          <div class="row justify-content-center">
            <div class="col-lg-8 col-xl-6">
              <div class="card subscription-confirm-card shadow border-0">
                <div class="card-body p-4 p-md-5">
                  <div class="d-flex align-items-start gap-3 mb-3">
                    <span class="d-inline-flex align-items-center justify-content-center rounded-circle bg-success-subtle text-success-emphasis" style="width: 48px; height: 48px;">
                      <i class="bi bi-check2 fs-3"></i>
                    </span>
                    <div>
                      <h1 id="subscription-link-heading" class="h3 fw-semibold mb-1">{{.Heading}}</h1>
                      <p id="subscription-link-message" class="text-body-secondary mb-0">{{.Message}}</p>
                    </div>
                  </div>
                  <div class="mt-4 d-flex flex-wrap gap-2">
                    <a id="subscription-link-open" class="btn btn-primary d-none" href="#" target="_blank" rel="noopener noreferrer">Open site</a>
                    <a id="subscription-link-secondary" class="btn btn-outline-secondary" href="{{.LandingPath}}">Return to LoopAware</a>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>
    {{.FooterHTML}}
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script>
{{.ThemeScript}}
    </script>
    <script>
{{.AuthScript}}
    </script>
    <script>
      (function() {
        var headingElement = document.getElementById('subscription-link-heading');
        var messageElement = document.getElementById('subscription-link-message');
        var openLink = document.getElementById('subscription-link-open');
        var secondaryLink = document.getElementById('subscription-link-secondary');
        var landingPath = '{{js .LandingPath}}';
        var actionEndpoint = '{{js .ActionEndpoint}}';

        function setText(element, value) {
          if (!element) {
            return;
          }
          element.textContent = value || '';
        }

        function setHidden(element, hidden) {
          if (!element) {
            return;
          }
          if (hidden) {
            element.classList.add('d-none');
          } else {
            element.classList.remove('d-none');
          }
        }

        function normalizeURL(value) {
          if (typeof value !== 'string') {
            return '';
          }
          return value.trim();
        }

        function applyResponse(payload) {
          if (!payload || typeof payload !== 'object') {
            return;
          }
          if (typeof payload.heading === 'string' && payload.heading.trim()) {
            setText(headingElement, payload.heading.trim());
            document.title = payload.heading.trim() + ' â€” LoopAware';
          }
          if (typeof payload.message === 'string' && payload.message.trim()) {
            setText(messageElement, payload.message.trim());
          }

          var openUrl = normalizeURL(payload.open_url);
          if (openUrl) {
            if (openLink) {
              openLink.href = openUrl;
              openLink.textContent = normalizeURL(payload.open_label) || 'Open site';
            }
            setHidden(openLink, false);
          } else {
            setHidden(openLink, true);
          }

          var unsubscribeUrl = normalizeURL(payload.unsubscribe_url);
          if (unsubscribeUrl) {
            if (secondaryLink) {
              secondaryLink.href = unsubscribeUrl;
              secondaryLink.textContent = 'Unsubscribe';
              secondaryLink.classList.remove('btn-outline-secondary');
              secondaryLink.classList.add('btn-outline-danger');
            }
            return;
          }

          if (secondaryLink) {
            secondaryLink.href = landingPath || '/';
            secondaryLink.textContent = 'Return to LoopAware';
            secondaryLink.classList.remove('btn-outline-danger');
            if (!secondaryLink.classList.contains('btn-outline-secondary')) {
              secondaryLink.classList.add('btn-outline-secondary');
            }
          }
        }

        var params = new URLSearchParams(window.location && window.location.search ? window.location.search : '');
        var token = normalizeURL(params.get('token') || '');
        if (!token) {
          applyResponse({ heading: 'Subscription confirmation', message: 'Missing confirmation token.' });
          return;
        }
        if (!actionEndpoint) {
          applyResponse({ heading: 'Subscription confirmation', message: 'Subscription confirmation is unavailable.' });
          return;
        }

        fetch(actionEndpoint + '?token=' + encodeURIComponent(token), {
          method: 'GET',
          credentials: 'same-origin',
          headers: { 'Accept': 'application/json' },
          referrer: window.location.href,
          referrerPolicy: 'strict-origin-when-cross-origin'
        }).then(function(response) {
          return response.json().catch(function() {
            return {};
          }).then(function(payload) {
            if (!response.ok) {
              return Object.assign({ heading: 'Subscription confirmation', message: 'Request failed.' }, payload || {});
            }
            return payload || {};
          });
        }).then(applyResponse).catch(function() {
          applyResponse({ heading: 'Subscription confirmation', message: 'Request failed.' });
        });
      }());
    </script>
  </body>
</html>
