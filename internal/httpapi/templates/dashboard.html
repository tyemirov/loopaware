<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{.PageTitle}}</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" integrity="sha384-b0OvQu3P5AnbcW2CYwiVdc+GqOR/mdrIW6DCeU44yWiNys8lm2SleqU9jwOpcPfq" crossorigin="anonymous" />
  </head>
  <body class="d-flex flex-column min-vh-100 bg-light">
    <header class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top shadow-sm">
      <div class="container-fluid">
        <span class="navbar-brand fw-semibold">{{.PageTitle}}</span>
        <div class="dropdown ms-auto">
          <button id="{{.SettingsButtonID}}" class="btn btn-outline-light border-0 rounded-circle p-1 d-flex align-items-center justify-content-center" type="button" data-bs-toggle="dropdown" aria-expanded="false">
            <span class="visually-hidden">{{.SettingsButtonLabel}}</span>
            <img id="{{.SettingsAvatarImageID}}" src="" alt="Avatar" class="rounded-circle d-none" width="36" height="36" />
            <i id="{{.SettingsAvatarFallbackID}}" class="bi bi-person-circle fs-3"></i>
          </button>
          <div id="{{.SettingsMenuID}}" class="dropdown-menu dropdown-menu-end">
            <button id="{{.LogoutButtonID}}" class="dropdown-item" type="button">{{.LogoutLabel}}</button>
            <div class="dropdown-item d-flex align-items-center justify-content-between">
              <span>{{.ThemeToggleLabel}}</span>
              <div class="form-check form-switch m-0">
                <input class="form-check-input" type="checkbox" role="switch" id="{{.SettingsThemeToggleID}}" />
              </div>
            </div>
          </div>
        </div>
      </div>
    </header>
    <main class="flex-grow-1 pt-5 mt-4">
      <div class="container py-4">
        
        <div class="row g-4">
          <div class="col-lg-4">
            <div class="card shadow-sm">
              <div class="card-header">Account</div>
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <img id="{{.UserAvatarID}}" src="" alt="Avatar" class="rounded-circle me-3 d-none" width="64" height="64" />
                  <div>
                    <div id="{{.UserNameID}}" class="fw-semibold"></div>
                    <div id="{{.UserEmailID}}" class="text-muted small"></div>
                    <span id="{{.UserRoleBadgeID}}" class="badge bg-secondary mt-2"></span>
                  </div>
                </div>
              </div>
            </div>
            <div class="card shadow-sm mt-4">
              <div class="card-header d-flex align-items-center justify-content-between">
                <span>Sites</span>
                <button id="{{.NewSiteButtonID}}" type="button" class="{{.NewSiteButtonClass}}">{{.NewSiteButtonLabel}}</button>
              </div>
              <div class="card-body p-0">
                <div id="{{.SitesListID}}" class="list-group list-group-flush overflow-auto" style="max-height: 20rem;"></div>
                <p class="text-muted small m-3" id="{{.EmptySitesMessageID}}">{{.EmptySitesMessage}}</p>
              </div>
            </div>
          </div>
          <div class="col-lg-8">
            <div class="card shadow-sm mb-4">
              <div class="card-header">
                <div class="d-flex align-items-center justify-content-between">
                  <h5 class="mb-0">Site details</h5>
                  <div class="d-flex align-items-center gap-2">
                    <div id="{{.FormStatusID}}" class="d-none py-1 px-2 small"></div>
                    <button id="{{.SaveSiteButtonID}}" type="button" class="{{.SaveButtonDefaultClass}}"></button>
                  </div>
                </div>
              </div>
              <div class="card-body">
                <form id="{{.SiteFormID}}">
                  <div class="row g-3 align-items-end">
                    <div class="col-md-6">
                      <label class="form-label" for="{{.EditSiteNameInputID}}">Name</label>
                      <input id="{{.EditSiteNameInputID}}" type="text" class="form-control" autocomplete="off" />
                    </div>
                    <div class="col-md-6">
                      <label class="form-label" for="{{.EditSiteOriginInputID}}">Allowed origin</label>
                      <input id="{{.EditSiteOriginInputID}}" type="text" class="form-control" autocomplete="off" />
                    </div>
                    <div class="col-md-6 d-none" id="{{.EditSiteOwnerContainerID}}">
                      <label class="form-label" for="{{.EditSiteOwnerInputID}}">Owner email</label>
                      <input id="{{.EditSiteOwnerInputID}}" type="email" class="form-control" autocomplete="off" />
                    </div>
                                      </div>
                </form>
              </div>
            </div>
            <div class="card shadow-sm mb-4">
              <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                  <h5 class="mb-0">{{.WidgetCardTitle}}</h5>
                  <div class="d-flex align-items-center gap-2">
                    <div id="{{.WidgetStatusID}}" class="d-none py-1 px-2 small"></div>
                    <button id="{{.CopyWidgetSnippetButtonID}}" type="button" class="{{.CopyButtonDefaultClass}}">{{.CopyButtonDefaultLabel}}</button>
                  </div>
                </div>
              </div>
              <div class="card-body">
                <p class="text-muted small mb-3">{{.WidgetInstructions}}</p>
                <textarea id="{{.WidgetSnippetTextareaID}}" class="form-control font-monospace" rows="3" readonly></textarea>
              </div>
            </div>
            <div class="card shadow-sm">
              <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                  <h5 class="mb-0">Feedback messages</h5>
                  <div class="d-flex align-items-center gap-2">
                    <div id="{{.MessagesStatusID}}" class="d-none py-1 px-2 small"></div>
                    <button id="{{.RefreshMessagesButtonID}}" class="{{.RefreshButtonDefaultClass}}">{{.RefreshButtonDefaultLabel}}</button>
                  </div>
                </div>
              </div>
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table table-striped table-hover align-middle">
                    <thead class="table-light">
                      <tr>
                        <th scope="col">When</th>
                        <th scope="col">Contact</th>
                        <th scope="col">Message</th>
                      </tr>
                    </thead>
                    <tbody id="{{.FeedbackTableBodyID}}">
                      <tr><td colspan="3" class="text-center text-muted">{{.FeedbackPlaceholder}}</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
    <footer class="bg-white mt-auto py-3 fixed-bottom border-top">
      <div class="container d-flex flex-column flex-md-row align-items-center justify-content-between text-center text-md-start text-muted small gap-2">
        <span>LoopAware Â© {{.CurrentYear}}</span>
        <span>{{.FooterBrandPrefix}} <a class="text-decoration-none" href="{{.FooterBrandURL}}" target="_blank" rel="noopener noreferrer">{{.FooterBrandName}}</a></span>
        <a class="text-decoration-none" href="{{.LogoutPath}}">{{.LogoutLabel}}</a>
      </div>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script>
      (function() {
        var apiMeEndpoint = '{{.APIMeEndpoint}}';
        var apiSitesEndpoint = '{{.APISitesEndpoint}}';
        var apiSiteUpdatePrefix = '{{.APISiteUpdateEndpointPrefix}}';
        var apiSiteMessagesPrefix = '{{.APIMessagesEndpointPrefix}}';
        var apiSiteMessagesSuffix = '{{.APIMessagesEndpointSuffix}}';
        var logoutPath = '{{.LogoutPath}}';
        var loginPath = '{{.LoginPath}}';
        var themePreferenceStorageKey = '{{.ThemeStorageKey}}';
        var settingsButton = document.getElementById('{{.SettingsButtonID}}');
        var settingsMenu = document.getElementById('{{.SettingsMenuID}}');
        var themeToggle = document.getElementById('{{.SettingsThemeToggleID}}');
        var settingsAvatarImage = document.getElementById('{{.SettingsAvatarImageID}}');
        var settingsAvatarFallback = document.getElementById('{{.SettingsAvatarFallbackID}}');
        var newSiteOptionValue = '{{.NewSiteOptionValue}}';
        var createButtonLabel = '{{.CreateButtonLabel}}';
        var updateButtonLabel = '{{.UpdateButtonLabel}}';
        var createButtonClass = '{{.CreateButtonClass}}';
        var updateButtonClass = '{{.UpdateButtonClass}}';
        var newSiteButton = document.getElementById('{{.NewSiteButtonID}}');
        var newSiteButtonDefaultClass = '{{.NewSiteButtonClass}}';
        var newSiteButtonActiveClass = '{{.NewSiteButtonActiveClass}}';
        var sitesList = document.getElementById('{{.SitesListID}}');
        var siteListItemClass = '{{.SiteListItemClass}}';
        var siteListItemActiveClass = '{{.SiteListItemActiveClass}}';
        var statusMessages = {
          loadingUser: '{{.StatusLoadingUser}}',
          loadingSites: '{{.StatusLoadingSites}}',
          loadFailed: '{{.StatusLoadFailed}}',
          savingSite: '{{.StatusSavingSite}}',
          siteSaved: '{{.StatusSiteSaved}}',
          creatingSite: '{{.StatusCreatingSite}}',
          siteCreated: '{{.StatusSiteCreated}}',
          selectSite: '{{.StatusSelectSite}}',
          noMessages: '{{.StatusNoMessages}}',
          noSites: '{{.StatusNoSites}}',
          widgetCopied: '{{.StatusWidgetCopied}}',
          widgetCopyFailed: '{{.StatusWidgetCopyFailed}}'
        };
        var roleLabels = {
          admin: '{{.RoleAdmin}}',
          user: '{{.RoleUser}}'
        };
        var widgetUnavailableMessage = '{{.WidgetUnavailableMessage}}';

        var userName = document.getElementById('{{.UserNameID}}');
        var userEmail = document.getElementById('{{.UserEmailID}}');
        var userAvatar = document.getElementById('{{.UserAvatarID}}');
        var userRole = document.getElementById('{{.UserRoleBadgeID}}');
        var emptySitesMessage = document.getElementById('{{.EmptySitesMessageID}}');
        var siteForm = document.getElementById('{{.SiteFormID}}');
        var editSiteNameInput = document.getElementById('{{.EditSiteNameInputID}}');
        var editSiteOriginInput = document.getElementById('{{.EditSiteOriginInputID}}');
        var editSiteOwnerContainer = document.getElementById('{{.EditSiteOwnerContainerID}}');
        var editSiteOwnerInput = document.getElementById('{{.EditSiteOwnerInputID}}');
        var saveSiteButton = document.getElementById('{{.SaveSiteButtonID}}');
        var refreshMessagesButton = document.getElementById('{{.RefreshMessagesButtonID}}');
        var feedbackTableBody = document.getElementById('{{.FeedbackTableBodyID}}');
        var logoutButton = document.getElementById('{{.LogoutButtonID}}');
        var widgetSnippetTextarea = document.getElementById('{{.WidgetSnippetTextareaID}}');
        var copyWidgetSnippetButton = document.getElementById('{{.CopyWidgetSnippetButtonID}}');

        var state = {
          user: null,
          sites: [],
          selectedSiteId: ''
        };
        var buttonStatusDisplayDuration = 3000;
        var widgetBaseURL = window.location.origin.replace(/\/$/, '');
        widgetSnippetTextarea.value = widgetUnavailableMessage;
        copyWidgetSnippetButton.disabled = true;
        setButtonDefault(copyWidgetSnippetButton, '{{.CopyButtonDefaultLabel}}', '{{.CopyButtonDefaultClass}}');
        setButtonDefault(refreshMessagesButton, '{{.RefreshButtonDefaultLabel}}', '{{.RefreshButtonDefaultClass}}');
        setButtonDefault(saveSiteButton, updateButtonLabel, updateButtonClass);

        function applyThemePreference(mode) {
          var normalized = mode === 'dark' ? 'dark' : 'light';
          document.documentElement.setAttribute('data-bs-theme', normalized);
          if (normalized === 'dark') {
            document.body.classList.remove('bg-light');
            document.body.classList.add('bg-dark', 'text-light');
          } else {
            document.body.classList.remove('bg-dark', 'text-light');
            if (!document.body.classList.contains('bg-light')) {
              document.body.classList.add('bg-light');
            }
          }
        }

        function loadThemePreference() {
          var stored = localStorage.getItem(themePreferenceStorageKey);
          if (stored !== 'dark' && stored !== 'light') {
            stored = 'light';
          }
          themeToggle.checked = stored === 'dark';
          applyThemePreference(stored);
        }

        function persistThemePreference(mode) {
          localStorage.setItem(themePreferenceStorageKey, mode);
        }

        function fetchJSON(url, options) {
          var requestOptions = options || {};
          if (!requestOptions.credentials) {
            requestOptions.credentials = 'same-origin';
          }
          return window.fetch(url, requestOptions).then(function(response) {
            if (response.status === 401) {
              window.location.href = loginPath;
              return Promise.reject(new Error('unauthorized'));
            }
            if (response.status === 403) {
              updateButtonStatus(refreshMessagesButton, '{{.RefreshButtonFailed}}', 'btn btn-outline-danger btn-sm');
              return Promise.reject(new Error('forbidden'));
            }
            if (!response.ok) {
              return response.json().catch(function() {
                return {};
              }).then(function(body) {
                var message = body.error || body.message || statusMessages.loadFailed;
                throw new Error(message);
              });
            }
            return response.json();
          });
        }

        function showStatus(message, variant, targetId) {
          var container = document.getElementById(targetId);
          if (!container) {
            return;
          }
          container.textContent = message;
          container.className = 'badge rounded-pill bg-' + variant + ' py-2 px-3';
          container.classList.remove('d-none');
          clearTimeout(container._timer);
          container._timer = setTimeout(function() {
            container.classList.add('d-none');
            container.textContent = '';
          }, 3000);
        }

        function hideStatus() {}

        function updateUserCard() {
          var displayName = state.user.name || state.user.email;
          userName.textContent = displayName || '';
          userEmail.textContent = state.user.email || '';
          if (state.user.picture_url) {
            userAvatar.src = state.user.picture_url;
            userAvatar.classList.remove('d-none');
          }
          var roleLabel = state.user.is_admin ? roleLabels.admin : roleLabels.user;
          userRole.textContent = roleLabel;
          userRole.className = state.user.is_admin ? 'badge bg-warning text-dark mt-2' : 'badge bg-secondary mt-2';
          if (state.user.is_admin) {
            editSiteOwnerContainer.classList.remove('d-none');
          } else {
            editSiteOwnerContainer.classList.add('d-none');
          }

          if (state.user.picture_url) {
            settingsAvatarImage.src = state.user.picture_url;
            settingsAvatarImage.classList.remove('d-none');
            settingsAvatarFallback.classList.add('d-none');
          } else {
            settingsAvatarImage.src = '';
            settingsAvatarImage.classList.add('d-none');
            settingsAvatarFallback.classList.remove('d-none');
          }
        }

        function isNewSiteSelected() {
          return state.selectedSiteId === newSiteOptionValue;
        }

        function buildWidgetSnippet(siteId) {
          return '<script src="' + widgetBaseURL + '/widget.js?site_id=' + siteId + '"></script>';
        }

        function updateButtonStatus(button, text, extraClass) {
          if (!button) {
            return;
          }
          if (!button._defaultText) {
            button._defaultText = button.textContent;
          }
          if (!button._defaultClass) {
            button._defaultClass = button.className;
          }
          button.textContent = text;
          button.className = extraClass || button._defaultClass;
          button._statusActive = true;
          clearTimeout(button._statusTimer);
          button._statusTimer = window.setTimeout(function() {
            button._statusActive = false;
            restoreButtonDefault(button);
          }, buttonStatusDisplayDuration);
        }

        function setButtonDefault(button, label, className) {
          if (!button) {
            return;
          }
          button._defaultText = label;
          button._defaultClass = className;
          if (button._statusActive) {
            return;
          }
          restoreButtonDefault(button);
        }

        function restoreButtonDefault(button) {
          if (!button) {
            return;
          }
          if (typeof button._defaultText === 'string') {
            button.textContent = button._defaultText;
          }
          if (typeof button._defaultClass === 'string') {
            button.className = button._defaultClass;
          }
        }

        function updateNewSiteButtonState() {
          if (!newSiteButton) {
            return;
          }
          if (isNewSiteSelected()) {
            newSiteButton.className = newSiteButtonActiveClass;
          } else {
            newSiteButton.className = newSiteButtonDefaultClass;
          }
        }

function updateWidgetSnippet() {
          if (!state.selectedSiteId || isNewSiteSelected()) {
            widgetSnippetTextarea.value = widgetUnavailableMessage;
            copyWidgetSnippetButton.disabled = true;
            return;
          }
          var site = state.sites.find(function(item) { return item.id === state.selectedSiteId; });
          if (!site) {
            widgetSnippetTextarea.value = widgetUnavailableMessage;
            copyWidgetSnippetButton.disabled = true;
            return;
          }
          widgetSnippetTextarea.value = buildWidgetSnippet(site.id);
          copyWidgetSnippetButton.disabled = false;
        }

        function copyWidgetSnippet() {
          if (copyWidgetSnippetButton.disabled) {
            return;
          }
          var snippet = widgetSnippetTextarea.value;
          if (!snippet || snippet === widgetUnavailableMessage) {
            updateButtonStatus(copyWidgetSnippetButton, '{{.CopyButtonFailed}}', 'btn btn-outline-danger btn-sm');
            return;
          }
          if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(snippet).then(function() {
              updateButtonStatus(copyWidgetSnippetButton, '{{.CopyButtonCopied}}', 'btn btn-outline-success btn-sm');
            }).catch(function() {
              fallbackCopyWidgetSnippet(snippet);
            });
          } else {
            fallbackCopyWidgetSnippet(snippet);
          }
        }

        function fallbackCopyWidgetSnippet(snippet) {
          var previousSelectionStart = widgetSnippetTextarea.selectionStart;
          var previousSelectionEnd = widgetSnippetTextarea.selectionEnd;
          widgetSnippetTextarea.focus();
          widgetSnippetTextarea.select();
          var copySucceeded = false;
          try {
            copySucceeded = document.execCommand('copy');
          } catch (error) {
            copySucceeded = false;
          }
          widgetSnippetTextarea.selectionStart = previousSelectionStart;
          widgetSnippetTextarea.selectionEnd = previousSelectionEnd;
          widgetSnippetTextarea.blur();
          if (copySucceeded) {
            updateButtonStatus(copyWidgetSnippetButton, '{{.CopyButtonCopied}}', 'btn btn-outline-success btn-sm');
          } else {
            updateButtonStatus(copyWidgetSnippetButton, '{{.CopyButtonFailed}}', 'btn btn-outline-danger btn-sm');
          }
        }

        function renderSites() {
          if (!sitesList) {
            return;
          }
          while (sitesList.firstChild) {
            sitesList.removeChild(sitesList.firstChild);
          }
          var hasSites = state.sites.length > 0;

          if (!state.selectedSiteId) {
            state.selectedSiteId = hasSites ? state.sites[0].id : newSiteOptionValue;
          }

          if (!isNewSiteSelected()) {
            var selectedExists = state.sites.some(function(item) {
              return item.id === state.selectedSiteId;
            });
            if (!selectedExists) {
              state.selectedSiteId = hasSites ? state.sites[0].id : newSiteOptionValue;
            }
          }

          state.sites.forEach(function(site) {
            var listItem = document.createElement('button');
            listItem.type = 'button';
            listItem.className = siteListItemClass + (site.id === state.selectedSiteId ? ' ' + siteListItemActiveClass : '');
            listItem.dataset.siteId = site.id;

            var nameElement = document.createElement('div');
            nameElement.className = 'fw-semibold';
            nameElement.textContent = site.name || '';
            listItem.appendChild(nameElement);

            var originElement = document.createElement('div');
            originElement.className = 'small text-muted text-truncate';
            originElement.textContent = site.allowed_origin || '';
            listItem.appendChild(originElement);

            sitesList.appendChild(listItem);
          });

          if (hasSites) {
            emptySitesMessage.classList.add('d-none');
          } else {
            emptySitesMessage.textContent = statusMessages.noSites;
            emptySitesMessage.classList.remove('d-none');
          }

          updateNewSiteButtonState();
          populateSiteForm();
          updateWidgetSnippet();
          if (isNewSiteSelected()) {
            renderFeedbackPlaceholder(statusMessages.selectSite);
          } else {
            loadMessages();
          }
        }

        function handleSitesListClick(event) {
          var target = event.target;
          while (target && target !== sitesList && !target.dataset.siteId) {
            target = target.parentElement;
          }
          if (!target || target === sitesList) {
            return;
          }
          var siteIdentifier = target.dataset.siteId;
          if (!siteIdentifier || siteIdentifier === state.selectedSiteId) {
            return;
          }
          state.selectedSiteId = siteIdentifier;
          renderSites();
        }

        function clearSiteForm() {
          editSiteNameInput.value = '';
          editSiteOriginInput.value = '';
          editSiteOwnerInput.value = '';
        }

        function populateSiteForm() {
          if (!state.selectedSiteId) {
            clearSiteForm();
            saveSiteButton.disabled = true;
            updateFormMode();
            updateWidgetSnippet();
            return;
          }

          if (isNewSiteSelected()) {
            clearSiteForm();
            saveSiteButton.disabled = false;
            updateFormMode();
            updateWidgetSnippet();
            return;
          }

          var site = state.sites.find(function(item) { return item.id === state.selectedSiteId; });
          if (!site) {
            clearSiteForm();
            saveSiteButton.disabled = true;
            updateFormMode();
            updateWidgetSnippet();
            return;
          }

          editSiteNameInput.value = site.name || '';
          editSiteOriginInput.value = site.allowed_origin || '';
          editSiteOwnerInput.value = site.owner_email || '';
          saveSiteButton.disabled = false;
          updateFormMode();
          updateWidgetSnippet();
        }

        function updateFormMode() {
          if (!state.user) {
            return;
          }
          var isAdmin = state.user.is_admin;
          if (isNewSiteSelected()) {
            setButtonDefault(saveSiteButton, createButtonLabel, createButtonClass);
          } else {
            setButtonDefault(saveSiteButton, updateButtonLabel, updateButtonClass);
          }
          if (isAdmin) {
            editSiteOwnerInput.disabled = false;
          } else {
            editSiteOwnerInput.disabled = true;
          }
        }

        function renderFeedbackPlaceholder(message) {
          feedbackTableBody.innerHTML = '';
          var row = document.createElement('tr');
          var cell = document.createElement('td');
          cell.colSpan = 3;
          cell.className = 'text-center text-muted';
          cell.textContent = message;
          row.appendChild(cell);
          feedbackTableBody.appendChild(row);
        }

        function renderMessages(messages) {
          if (!messages.length) {
            renderFeedbackPlaceholder(statusMessages.noMessages);
            return;
          }
          feedbackTableBody.innerHTML = '';
          messages.forEach(function(message) {
            var row = document.createElement('tr');
            var createdCell = document.createElement('td');
            createdCell.textContent = formatTimestamp(message.created_at);
            var contactCell = document.createElement('td');
            contactCell.textContent = message.contact;
            var bodyCell = document.createElement('td');
            bodyCell.textContent = message.message;
            row.appendChild(createdCell);
            row.appendChild(contactCell);
            row.appendChild(bodyCell);
            feedbackTableBody.appendChild(row);
          });
        }

        function formatTimestamp(unixSeconds) {
          if (!unixSeconds) {
            return '';
          }
          var date = new Date(unixSeconds * 1000);
          return date.toLocaleString();
        }

        function loadUser() {
          showStatus(statusMessages.loadingUser, 'info', '{{.FormStatusID}}');
          return fetchJSON(apiMeEndpoint).then(function(payload) {
            state.user = payload;
            updateUserCard();
            hideStatus();
          }).catch(function(error) {
            updateButtonStatus(saveSiteButton, error.message || '{{.SaveButtonFailed}}', 'btn btn-outline-danger');
            saveSiteButton.disabled = false;
            saveSiteButton.disabled = false;
            throw error;
          });
        }

        function loadSites() {
          updateButtonStatus(refreshMessagesButton, '{{.RefreshButtonLoading}}', '{{.RefreshButtonDefaultClass}}');
          return fetchJSON(apiSitesEndpoint).then(function(payload) {
            state.sites = payload.sites || [];
            renderSites();
            hideStatus();
          }).catch(function(error) {
            updateButtonStatus(saveSiteButton, error.message || '{{.SaveButtonFailed}}', 'btn btn-outline-danger');
            saveSiteButton.disabled = false;
            saveSiteButton.disabled = false;
          });
        }

        function loadMessages() {
          if (!state.selectedSiteId || isNewSiteSelected()) {
            renderFeedbackPlaceholder(statusMessages.selectSite);
            return;
          }
          var endpoint = apiSiteMessagesPrefix + state.selectedSiteId + apiSiteMessagesSuffix;
          renderFeedbackPlaceholder('Loading...');
          fetchJSON(endpoint).then(function(payload) {
            renderMessages(payload.messages || []); updateButtonStatus(refreshMessagesButton, '{{.RefreshButtonSuccess}}', 'btn btn-outline-success btn-sm');
          }).catch(function() {
            renderFeedbackPlaceholder(statusMessages.loadFailed); updateButtonStatus(refreshMessagesButton, '{{.RefreshButtonFailed}}', 'btn btn-outline-danger btn-sm');
          });
        }

        function submitSite(event) {
          if (event) { event.preventDefault(); }
          if (saveSiteButton.disabled) { return; }
          if (!state.selectedSiteId) {
            showStatus(statusMessages.selectSite, 'warning', '{{.FormStatusID}}');
            return;
          }
          if (isNewSiteSelected()) {
            createSite();
          } else {
            updateSite();
          }
        }

        function updateSite() {
          saveSiteButton.disabled = true;
          updateButtonStatus(saveSiteButton, '{{.SaveButtonSaving}}', '{{.SaveButtonDefaultClass}}');
          var body = {
            name: editSiteNameInput.value,
            allowed_origin: editSiteOriginInput.value
          };
          if (state.user.is_admin) {
            body.owner_email = editSiteOwnerInput.value;
          }
          var endpoint = apiSiteUpdatePrefix + state.selectedSiteId;
          fetchJSON(endpoint, {
            method: 'PATCH',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(body)
          }).then(function(payload) {
            updateButtonStatus(saveSiteButton, '{{.SaveButtonSaved}}', '{{.SaveButtonDefaultClass}}');
            saveSiteButton.disabled = false;
            var index = state.sites.findIndex(function(item) { return item.id === payload.id; });
            if (index >= 0) {
              state.sites[index] = payload;
            }
            renderSites();
          }).catch(function(error) {
            updateButtonStatus(saveSiteButton, error.message || '{{.SaveButtonFailed}}', 'btn btn-outline-danger');
            saveSiteButton.disabled = false;
            saveSiteButton.disabled = false;
          });
        }

        function createSite() {
          saveSiteButton.disabled = true;
          updateButtonStatus(saveSiteButton, '{{.SaveButtonSaving}}', '{{.SaveButtonDefaultClass}}');
          var body = {
            name: editSiteNameInput.value,
            allowed_origin: editSiteOriginInput.value,
            owner_email: editSiteOwnerInput.value
          };
          fetchJSON(apiSitesEndpoint, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(body)
          }).then(function(payload) {
            updateButtonStatus(saveSiteButton, '{{.SaveButtonCreated}}', '{{.SaveButtonDefaultClass}}');
            saveSiteButton.disabled = false;
            state.sites.unshift(payload);
            state.selectedSiteId = payload.id;
            renderSites();
          }).catch(function(error) {
            updateButtonStatus(saveSiteButton, error.message || '{{.SaveButtonFailed}}', 'btn btn-outline-danger');
            saveSiteButton.disabled = false;
            saveSiteButton.disabled = false;
          });
        }

        if (sitesList) {
          sitesList.addEventListener('click', handleSitesListClick);
        }
        if (newSiteButton) {
          newSiteButton.addEventListener('click', function(event) {
            event.preventDefault();
            if (state.selectedSiteId === newSiteOptionValue) {
              return;
            }
            state.selectedSiteId = newSiteOptionValue;
            renderSites();
          });
        }

        siteForm.addEventListener('submit', submitSite);
        document.getElementById('{{.SaveSiteButtonID}}').addEventListener('click', submitSite);
        themeToggle.addEventListener('change', function(event) {
          var mode = event.target.checked ? 'dark' : 'light';
          applyThemePreference(mode);
          persistThemePreference(mode);
        });
        copyWidgetSnippetButton.addEventListener('click', function(event) {
          event.preventDefault();
          copyWidgetSnippet();
        });
        refreshMessagesButton.addEventListener('click', function(event) {
          event.preventDefault();
          loadMessages();
        });
        logoutButton.addEventListener('click', function(event) {
          event.preventDefault();
          window.location.href = logoutPath;
        });

        loadThemePreference();
        loadUser().then(loadSites);
      })();
    </script>
  </body>
</html>
