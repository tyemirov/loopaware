<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>{{.PageTitle}}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script>
    (function() {
      var THEME_KEYS = [
        'loopaware_dashboard_theme',
        'loopaware_public_theme',
        'loopaware_landing_theme',
        'loopaware_theme'
      ];
      var theme = 'light';
      for (var index = 0; index < THEME_KEYS.length; index++) {
        try {
          var value = localStorage.getItem(THEME_KEYS[index]);
          if (value === 'dark') {
            theme = 'dark';
            break;
          }
          if (value === 'light') {
            theme = 'light';
          }
        } catch (error) {
          theme = 'light';
        }
      }
      document.documentElement.setAttribute('data-bs-theme', theme);
    }());
  </script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" {{.BootstrapIconsIntegrity}} crossorigin="anonymous" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/MarcoPoloResearchLab/mpr-ui@latest/mpr-ui.css" />
  <link rel="icon" type="image/svg+xml" href="{{.FaviconDataURI}}" />
  <script defer src="https://cdn.jsdelivr.net/gh/MarcoPoloResearchLab/mpr-ui@latest/mpr-ui.js"></script>
  <style>{{.SharedStyles}}</style>
</head>
<body class="d-flex flex-column min-vh-100" data-site-id="{{.SiteID}}" data-widget-side="{{.PlacementSide}}" data-widget-offset="{{.PlacementOffset}}" data-update-endpoint="{{.WidgetUpdateEndpoint}}">
  {{template "dashboard_header" .Header}}
  <div class="modal fade" id="{{.Header.SettingsModalID}}" tabindex="-1" aria-labelledby="{{.Header.SettingsModalTitleID}}" aria-describedby="{{.Header.SettingsModalContentID}}" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="{{.Header.SettingsModalTitleID}}">{{.Header.SettingsModalTitle}}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{.Header.SettingsModalCloseLabel}}"></button>
        </div>
        <div class="modal-body">
          <p class="text-muted mb-4">{{.Header.SettingsModalIntro}}</p>
          <div id="{{.Header.SettingsModalContentID}}" class="d-flex flex-column gap-3"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{.Header.SettingsModalCloseLabel}}</button>
        </div>
      </div>
    </div>
  </div>
  <main class="flex-fill pt-5 mt-4">
    <div class="container">
      <div class="row justify-content-center">
        <div class="col-lg-8">
          <div class="card shadow-sm border-0">
            <div class="card-body">
              <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-3">
                <div>
                  <h1 class="h4 mb-1">Widget Test â€” {{.SiteName}}</h1>
                  <p class="text-muted small mb-0">Site ID: <code>{{.SiteID}}</code></p>
                </div>
                <span class="badge text-bg-secondary">Preview only</span>
              </div>
              <hr class="my-4" />
              <p id="widget-test-summary" class="mb-3">
                Bubble side <strong id="widget-test-summary-side">{{.PlacementSideLabel}}</strong>, bottom offset <strong><span id="widget-test-summary-offset">{{.PlacementOffset}}</span>px</strong>.
              </p>
              <p class="text-muted mb-4">Use the theme switch in the navigation bar to verify light and dark modes. Interactions with this widget are stored with the selected site.</p>
              <form id="widget-test-form" class="border rounded p-3 bg-body-secondary">
                <div class="row g-3 align-items-start mb-3">
                  <div class="col-12 col-lg-6">
                    <fieldset class="mb-0">
                      <legend class="fs-6 mb-2">Bubble placement</legend>
                      <div class="form-check">
                        <input class="form-check-input" type="radio" name="widget-test-side" id="widget-test-side-left" value="left">
                        <label class="form-check-label" for="widget-test-side-left">Left</label>
                      </div>
                      <div class="form-check">
                        <input class="form-check-input" type="radio" name="widget-test-side" id="widget-test-side-right" value="right">
                        <label class="form-check-label" for="widget-test-side-right">Right</label>
                      </div>
                    </fieldset>
                  </div>
                  <div class="col-12 col-lg-6">
                    <div class="d-flex flex-column gap-2">
                      <label class="form-label mb-0" for="widget-test-bottom-offset">Bottom offset (0-240 px)</label>
                      <div class="input-group">
                        <button id="widget-test-offset-decrease" type="button" class="btn btn-outline-secondary" aria-label="Decrease bottom offset by 10 pixels">-10 px</button>
                        <input class="form-control text-end" type="number" id="widget-test-bottom-offset" min="0" max="240" step="1" required>
                        <button id="widget-test-offset-increase" type="button" class="btn btn-outline-secondary" aria-label="Increase bottom offset by 10 pixels">+10 px</button>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="d-flex align-items-center gap-3">
                  <button type="submit" class="btn btn-primary" id="widget-test-save">Save placement</button>
                  <span class="small text-muted" id="widget-test-status"></span>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
  {{.FooterHTML}}
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
  <script>
    (function() {
      var themeStorageKey = '{{js .ThemeStorageKey}}';
      var publicThemeStorageKey = '{{js .PublicThemeStorageKey}}';
      var landingThemeStorageKey = '{{js .LandingThemeStorageKey}}';
      var legacyThemeStorageKey = '{{js .LegacyThemeStorageKey}}';
      var footerElement = document.getElementById('{{js .FooterElementID}}');
      var footerLightClass = '{{js .FooterThemeLightClass}}';
      var footerDarkClass = '{{js .FooterThemeDarkClass}}';
      var footerBaseClass = '{{js .FooterBaseClass}}';
      var logoutButton = document.getElementById('{{js .Header.LogoutButtonID}}');
      var logoutPath = '{{js .LogoutPath}}';
      var landingPath = '{{js .LandingPath}}';
      var dashboardPath = '{{js .DashboardPath}}';
      var settingsModalElement = document.getElementById('{{js .Header.SettingsModalID}}');

      function normalizeClassList(value) {
        if (typeof value !== 'string') {
          return [];
        }
        return value.split(/\s+/).filter(function(item) {
          return item.length > 0;
        });
      }

      function applyElementThemeClasses(element, classesToAdd, classesToRemove) {
        if (!element) {
          return;
        }
        normalizeClassList(classesToRemove).forEach(function(className) {
          element.classList.remove(className);
        });
        normalizeClassList(classesToAdd).forEach(function(className) {
          element.classList.add(className);
        });
      }

      function isRecognizedTheme(value) {
        return value === 'dark' || value === 'light';
      }

      function readThemePreference(storageKey) {
        if (!storageKey) {
          return '';
        }
        var storedValue = localStorage.getItem(storageKey);
        if (storedValue === null) {
          return '';
        }
        return storedValue;
      }

      function writeThemePreference(storageKey, mode) {
        if (!storageKey) {
          return;
        }
        localStorage.setItem(storageKey, mode);
      }

      function resolveThemePreference() {
        var storedTheme = readThemePreference(themeStorageKey);
        if (isRecognizedTheme(storedTheme)) {
          return storedTheme;
        }
        var publicTheme = readThemePreference(publicThemeStorageKey);
        if (isRecognizedTheme(publicTheme)) {
          writeThemePreference(themeStorageKey, publicTheme);
          return publicTheme;
        }
        var landingTheme = readThemePreference(landingThemeStorageKey);
        if (isRecognizedTheme(landingTheme)) {
          writeThemePreference(themeStorageKey, landingTheme);
          return landingTheme;
        }
        var legacyTheme = readThemePreference(legacyThemeStorageKey);
        if (isRecognizedTheme(legacyTheme)) {
          writeThemePreference(themeStorageKey, legacyTheme);
          return legacyTheme;
        }
        writeThemePreference(themeStorageKey, 'light');
        return 'light';
      }

      function applyThemePreference(mode) {
        var normalized = mode === 'dark' ? 'dark' : 'light';
        document.documentElement.setAttribute('data-bs-theme', normalized);
        var body = document.body;
        if (body) {
          if (normalized === 'dark') {
            body.classList.remove('bg-light', 'text-dark');
            body.classList.add('bg-dark', 'text-light');
          } else {
            body.classList.remove('bg-dark', 'text-light');
            if (!body.classList.contains('bg-light')) {
              body.classList.add('bg-light');
            }
            if (!body.classList.contains('text-dark')) {
              body.classList.add('text-dark');
            }
          }
        }
        if (footerElement) {
          normalizeClassList(footerBaseClass).forEach(function(className) {
            footerElement.classList.add(className);
          });
          if (normalized === 'dark') {
            applyElementThemeClasses(footerElement, footerDarkClass, footerLightClass);
          } else {
            applyElementThemeClasses(footerElement, footerLightClass, footerDarkClass);
          }
        }
      }

      function persistThemePreference(mode) {
        writeThemePreference(themeStorageKey, mode);
        writeThemePreference(publicThemeStorageKey, mode);
        writeThemePreference(landingThemeStorageKey, mode);
        writeThemePreference(legacyThemeStorageKey, mode);
      }

      function synchronizeFooterThemeMode(mode) {
        if (!footerElement) {
          return;
        }
        footerElement.setAttribute('theme-mode', mode);
      }

      function handleThemeSelection(mode) {
        var normalized = mode === 'dark' ? 'dark' : 'light';
        applyThemePreference(normalized);
        persistThemePreference(normalized);
        synchronizeFooterThemeMode(normalized);
      }

      function loadThemePreference() {
        var stored = resolveThemePreference();
        synchronizeFooterThemeMode(stored);
        applyThemePreference(stored);
      }

      function performLogout() {
        var redirectToLanding = function() {
          window.location.href = landingPath;
        };
      if (!logoutPath) {
        redirectToLanding();
        return;
      }
      window.fetch(logoutPath, {
        method: 'POST',
        credentials: 'same-origin'
      }).then(redirectToLanding).catch(redirectToLanding);
    }

      if (settingsModalElement) {
        settingsModalElement.dataset.loopawareSettingsModalDismissAttached = 'true';
        settingsModalElement.addEventListener('click', function(event) {
          if (event.target === settingsModalElement && window.bootstrap && window.bootstrap.Modal) {
            var modalInstance = window.bootstrap.Modal.getOrCreateInstance(settingsModalElement);
            if (modalInstance) {
              modalInstance.hide();
              settingsModalElement.dataset.loopawareSettingsModalDismissTriggered = 'true';
            }
          }
        });
      }

      if (logoutButton) {
        logoutButton.addEventListener('click', function(event) {
          event.preventDefault();
          performLogout();
        });
      }

      if (footerElement) {
        footerElement.addEventListener('mpr-footer:theme-change', function(event) {
          var nextTheme = event && event.detail && event.detail.theme === 'dark' ? 'dark' : 'light';
          handleThemeSelection(nextTheme);
        });
      }

      loadThemePreference();
    }());
  </script>
  <script>
    (function() {
      var body = document.body;
      if (!body) {
        return;
      }
      var updateEndpoint = body.getAttribute('data-update-endpoint') || '';
      var defaultSide = (body.getAttribute('data-widget-side') || 'right').toLowerCase();
      var defaultOffset = parseInt(body.getAttribute('data-widget-offset') || '16', 10);
      if (!Number.isFinite(defaultOffset)) {
        defaultOffset = 16;
      }
      var sideLeftInput = document.getElementById('widget-test-side-left');
      var sideRightInput = document.getElementById('widget-test-side-right');
      var offsetInput = document.getElementById('widget-test-bottom-offset');
      var offsetDecreaseButton = document.getElementById('widget-test-offset-decrease');
      var offsetIncreaseButton = document.getElementById('widget-test-offset-increase');
      var saveButton = document.getElementById('widget-test-save');
      var statusLabel = document.getElementById('widget-test-status');
      var summarySide = document.getElementById('widget-test-summary-side');
      var summaryOffset = document.getElementById('widget-test-summary-offset');
      var form = document.getElementById('widget-test-form');
      var horizontalOffset = '16px';
      var panelSpacing = 64;
      var minimumOffset = 0;
      var maximumOffset = 240;
      var saving = false;
      var offsetStep = 10;

      function normalizeSide(value) {
        var normalized = (value || '').toLowerCase();
        if (normalized !== 'left' && normalized !== 'right') {
          normalized = 'right';
        }
        return normalized;
      }

      function normalizeOffset(value) {
        var numeric = Number(value);
        if (!Number.isFinite(numeric)) {
          numeric = defaultOffset;
        }
        numeric = Math.round(numeric);
        if (numeric < minimumOffset) {
          numeric = minimumOffset;
        }
        if (numeric > maximumOffset) {
          numeric = maximumOffset;
        }
        return numeric;
      }

      function adjustOffset(delta) {
        if (!offsetInput) {
          return;
        }
        var current = currentOffset();
        var adjusted = normalizeOffset(current + delta);
        if (adjusted === current) {
          return;
        }
        offsetInput.value = adjusted.toString();
        handleControlChange();
      }

      function formatSideLabel(side) {
        return side === 'left' ? 'Left' : 'Right';
      }

      function updateSummary(side, offset) {
        if (summarySide) {
          summarySide.textContent = formatSideLabel(side);
        }
        if (summaryOffset) {
          summaryOffset.textContent = String(offset);
        }
      }

      function updateWidgetPreview(side, offset) {
        var bubble = document.getElementById('mp-feedback-bubble');
        var panel = document.getElementById('mp-feedback-panel');
        if (!bubble || !panel) {
          window.setTimeout(function() {
            updateWidgetPreview(side, offset);
          }, 50);
          return;
        }
        bubble.style.left = '';
        bubble.style.right = '';
        panel.style.left = '';
        panel.style.right = '';
        if (side === 'left') {
          bubble.style.left = horizontalOffset;
          panel.style.left = horizontalOffset;
        } else {
          bubble.style.right = horizontalOffset;
          panel.style.right = horizontalOffset;
        }
        bubble.style.bottom = offset + 'px';
        panel.style.bottom = offset + panelSpacing + 'px';
      }

      function resolveDashboardReturnPath() {
        if (typeof dashboardPath === 'string' && dashboardPath.trim().length > 0) {
          return dashboardPath;
        }
        if (typeof landingPath === 'string' && landingPath.trim().length > 0) {
          return landingPath.trim();
        }
        return '/app';
      }

      function redirectToDashboard() {
        var target = resolveDashboardReturnPath();
        if (window.opener && !window.opener.closed) {
          try {
            window.opener.focus();
          } catch (error) {
            // ignore focus errors
          }
        }
        window.location.assign(target);
      }

      function applyFormState(side, offset) {
        var normalizedSide = normalizeSide(side);
        var normalizedOffset = normalizeOffset(offset);
        if (sideLeftInput) {
          sideLeftInput.checked = normalizedSide === 'left';
        }
        if (sideRightInput) {
          sideRightInput.checked = normalizedSide !== 'left';
        }
        if (offsetInput) {
          offsetInput.value = normalizedOffset.toString();
        }
        updateSummary(normalizedSide, normalizedOffset);
        updateWidgetPreview(normalizedSide, normalizedOffset);
      }

      function currentSide() {
        if (sideLeftInput && sideLeftInput.checked) {
          return 'left';
        }
        return 'right';
      }

      function currentOffset() {
        if (!offsetInput) {
          return defaultOffset;
        }
        return normalizeOffset(offsetInput.value);
      }

      function setStatus(message) {
        if (!statusLabel) {
          return;
        }
        statusLabel.textContent = message;
      }

      function handleControlChange() {
        applyFormState(currentSide(), currentOffset());
      }

      if (sideLeftInput) {
        sideLeftInput.addEventListener('change', handleControlChange);
      }
      if (sideRightInput) {
        sideRightInput.addEventListener('change', handleControlChange);
      }
      if (offsetInput) {
        offsetInput.addEventListener('input', handleControlChange);
        offsetInput.addEventListener('keydown', function(event) {
          if (event.key === 'ArrowUp' || event.key === 'ArrowDown') {
            event.preventDefault();
            adjustOffset(event.key === 'ArrowUp' ? offsetStep : -offsetStep);
          }
        });
      }

      if (offsetDecreaseButton) {
        offsetDecreaseButton.addEventListener('click', function() {
          adjustOffset(-offsetStep);
        });
      }

      if (offsetIncreaseButton) {
        offsetIncreaseButton.addEventListener('click', function() {
          adjustOffset(offsetStep);
        });
      }

      if (form && saveButton) {
        form.addEventListener('submit', function(event) {
          event.preventDefault();
          if (!updateEndpoint || saving) {
            return;
          }
          saving = true;
          saveButton.disabled = true;
          setStatus('Saving...');
          var payload = {
            widget_bubble_side: currentSide(),
            widget_bubble_bottom_offset: currentOffset()
          };
          fetch(updateEndpoint, {
            method: 'PATCH',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          }).then(function(response) {
            if (!response.ok) {
              throw new Error('save_failed');
            }
            return response.json().catch(function() {
              return {};
            });
          }).then(function() {
            setStatus('Saved.');
            redirectToDashboard();
          }).catch(function() {
            setStatus('Save failed.');
          }).finally(function() {
            saving = false;
            saveButton.disabled = false;
          });
        });
      }

      applyFormState(defaultSide, defaultOffset);
    }());
  </script>
  <script>
    window.LOOPAWARE_WIDGET_TEST_MODE = true;
    window.LOOPAWARE_WIDGET_TEST_ENDPOINT = "{{.TestFeedbackEndpoint}}";
  </script>
  <script defer src="{{.WidgetScriptURL}}"></script>
</body>
</html>
